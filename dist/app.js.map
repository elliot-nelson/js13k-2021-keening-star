{"version":3,"sources":["app.js","../../src/js/Camera.js","../../src/js/Font-gen.js","../../src/js/pico8-audio-player.js","../../src/js/AudioData-gen.js","../../src/js/Audio.js","../../src/js/Input.js","../../src/js/WorldData-gen.js","../../src/js/World.js","../../src/js/Constants.js","../../src/js/Util.js","../../src/js/Text.js","../../src/js/Screen.js","../../src/js/Log.js","../../src/js/LogScreen.js","../../src/js/HelpScreen.js","../../src/js/InventoryScreen.js","../../src/js/GoodbyeScreen.js","../../src/js/Player.js","../../src/js/TurnSystem.js","../../src/js/Viewport.js","../../src/js/WelcomeScreen.js","../../src/js/Game.js","../../src/js/index.js"],"names":["Camera","[object Object]","this","pos","x","y","z","Game","player","Font","Promise","resolve","image","Image","onload","src","data","uri","img","SAMPLE_RATE","AudioCart","h","sfx","l","music","options","audioCtx","AudioContext","sfxData","split","musicData","prevNoise","parseHex","str","start","len","parseInt","substr","round","oscillators","t","Math","abs","white","random","brown","value","u","getFreq","pitch","soundCache","getSound","sfxIndex","pitchOffset","key","sound","sfxRow","noteLength","loopStart","loopEnd","length","Float32Array","getNextIndex","i","getSfx","index","offset","currNote","currFreq","currWaveform","currVolume","currEffect","phi","prevNote","prevFreq","prevWaveform","prevVolume","prevEffect","next","nextNote","nextWaveform","nextVolume","nextEffect","attack","release","samples","customInstrument","k","j","noteFactor","envelope","freq","volume","sin","buildMusic","endOffset","sfxBuffer","createMusic","startPattern","timeChannels","patternSamples","songLength","endPattern","pattern","musicRow","flags","channel","frameCount","audioBuffer","createBuffer","getChannelData","source","createBufferSource","buffer","loop","playMusic","connect","destination","AudioData","Audio","initialized","AC","window","webkitAudioContext","setTimeout","globalGain","createGain","gain","unmute","cart","seconds","linearRampToValueAtTime","currentTime","Input","I","T","B","D","O","H","SELECT","C","S","R","BACK","keyboard","pressed","released","held","framesHeld","keyMapping","ArrowUp","Action","UP","ArrowLeft","LEFT","ArrowDown","DOWN","ArrowRight","RIGHT","KeyC","CAST","KeyL","LOG","KeyH","HELP","KeyI","INVENTORY","Enter","Escape","addEventListener","event","action","code","init","enterPressed","Object","values","WorldData","G","name","F","J","X","K","id","bounds","Z","World","P","reset","visions","frame","tiles","floors","visible","object","objectAt","type","Screen","writeOnMap","char","colorForObject","c","String","fromCharCode","colorForTile","write","repeat","room","strings","floor","GREEN","map","row","objects","rooms","width","height","spawn","FLOOR","find","list","push","tileAt","_","finished","DIM","interacted","YELLOW","BLUE","ee","tile","WHITE","roomId","rgba","r","g","b","a","formatQuantity","valueMax","padStart","Text","colorways","terminal","recolor","terminal_shadow","ctx","text","v","color","font","Array","isArray","block","drawText","idx","charCodeAt","drawImage","FONT_WIDTH","FONT_HEIGHT","canvas","document","createElement","getContext","ve","fillStyle","fillRect","globalCompositeOperation","ae","RED","se","ce","ue","Ie","Ee","de","Te","Be","screen","smudge","clear","COLORS","BRIGHT","startX","startY","SCREEN_WIDTH","SPACE","x2","Error","ox","w","c2","Log","entries","message","formatCode","add","lines","boxHeight","boxStart","temporaryBlanks","display","flat","slice","writeBox","LogScreen","closing","cull","min","max","draw","HelpScreen","expand","join","InventoryScreen","selected","inventory","useItemOn","description","padEnd","GoodbyeScreen","mute","Player","lookingAt","speed","hp","hpMax","sp","spMax","obtainItem","objectsById","roomAt","makeVisible","move","interactWith","entityAt","open","moveInto","openInventoryFor","openDoor","obtainedItem","screens","updateRoom","item","removeItem","includes","filter","objectId","stringId","TurnSystem","entities","tp","update","entity","Viewport","getElementById","resize","force","dpi","devicePixelRatio","clientWidth","clientHeight","dpiWidth","dpiHeight","scale","ceil","center","pe","ke","imageSmoothingEnabled","style","cursor","WelcomeScreen","requestAnimationFrame","onFrame","now","Date","getTime","lastFrame","takeEntityTurns","setTransform","translate"],"mappings":"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iB,SAASC,IAC7B,IAAIC,EAAS1K,KAAKoJ,EAAWqB,EAAME,MAC/BD,IACA1K,KAAK+I,EAAS2B,IAAAA,OAK1B3K,IACI,IAAK,IAAI2K,KAAUI,OAAOC,OAAO5C,EAAMmB,GAAS,CAC5C,IAAIJ,EAAOlJ,KAAK+I,EAAS2B,GAEzB1K,KAAKgJ,EAAQ0B,IAAW1K,KAAKkJ,EAAKwB,IAAWxB,EAC7ClJ,KAAKiJ,EAASyB,GAAU1K,KAAKkJ,EAAKwB,KAAYxB,EAE1ClJ,KAAKgJ,EAAQ0B,GACb1K,KAAKmJ,EAAWuB,GAAU,EACnB1K,KAAKkJ,EAAKwB,IAAWxB,GAC5BlJ,KAAKmJ,EAAWuB,KAGpB1K,KAAKkJ,EAAKwB,GAAUxB,KCVnB8B,EAEb,CACIC,EAAU,CACN,CACIC,KAAQ,KACRC,EAAS,CACL,CACI,GACA,GACA,GACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IAEJ,CACI,GACA,GACA,GACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,IACA,IACA,GACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IAEJ,CACI,GACA,GACA,GACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,IACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IAEJ,CACI,GACA,GACA,GACA,IACA,GACA,GACA,IACA,GACA,GACA,IACA,IACA,IACA,GACA,IACA,IACA,IACA,GACA,IACA,IACA,IACA,GACA,IACA,IACA,IACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IAEJ,CACI,GACA,GACA,GACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,GACA,GACA,GACA,GACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,IACA,IACA,IACA,IACA,GACA,IACA,IACA,IACA,IAEJ,CACI,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,GACA,GACA,GACA,GACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,IAEJ,CACI,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,IACA,GACA,GACA,GACA,GACA,IACA,GACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,KAEJ,CACI,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,GACA,GACA,GACA,GACA,GACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,KAEJ,CACI,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,IACA,GACA,GACA,GACA,GACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,KAEJ,CACI,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,IACA,IACA,IACA,IACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IAEJ,CACI,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,IACA,IACA,IACA,GACA,IACA,IACA,IACA,IACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,KAGRC,EAAS,CACL,CACI,GACA,EACA,EACA,EACA,GAEJ,CACI,GACA,GACA,EACA,EACA,GAEJ,CACI,GACA,GACA,EACA,EACA,GAEJ,CACI,GACA,GACA,EACA,GACA,GAEJ,CACI,GACA,GACA,EACA,GACA,GAEJ,CACI,GACA,GACA,EACA,EACA,GAEJ,CACI,GACA,EACA,EACA,EACA,GAEJ,CACI,GACA,GACA,EACA,GACA,GAEJ,CACI,GACA,GACA,EACA,EACA,IAGRC,EAAW,CACP,CACI,EACA,GACA,GAEJ,CACI,EACA,GACA,EACA,GAEJ,CACI,EACA,GACA,EACA,GAEJ,CACI,GACA,GACA,GAEJ,CACI,EACA,GACA,EACA,GAEJ,CACI,GACA,GACA,EACA,GAEJ,CACI,GACA,EACA,EACA,GAEJ,CACI,EACA,GACA,GACA,GAEJ,CACI,GACA,GACA,EACA,GAEJ,CACI,GACA,GACA,GAEJ,CACI,GACA,GACA,GAEJ,CACI,GACA,GACA,EACA,GAEJ,CACI,GACA,GACA,GAEJ,CACI,EACA,EACA,GAEJ,CACI,EACA,EACA,GAEJ,CACI,EACA,EACA,GAEJ,CACI,GACA,EACA,GAEJ,CACI,GACA,EACA,EACA,GAEJ,CACI,GACA,EACA,EACA,GAEJ,CACI,GACA,GACA,GAEJ,CACI,GACA,GACA,GAEJ,CACI,GACA,GACA,GAEJ,CACI,GACA,GACA,EACA,GAEJ,CACI,GACA,GACA,EACA,GAEJ,CACI,GACA,GACA,EACA,GAEJ,CACI,EACA,GACA,EACA,GAEJ,CACI,GACA,GACA,GAEJ,CACI,GACA,GACA,GACA,GAEJ,CACI,GACA,GACA,EACA,GAEJ,CACI,GACA,GACA,GAEJ,CACI,GACA,GACA,GAEJ,CACI,GACA,GACA,GAEJ,CACI,GACA,GACA,GAEJ,CACI,GACA,GACA,GAEJ,CACI,GACA,GACA,GAEJ,CACI,GACA,GACA,GAEJ,CACI,GACA,GACA,EACA,GAEJ,CACI,GACA,GACA,EACA,GAEJ,CACI,GACA,GACA,EACA,IAGRC,EAAY,GACZC,GAAM,IAGdC,OAAU,CACN,CACI,EACA,GAEJ,CACI,GACA,KAGRlG,EAAS,CACL,GACA,EACA,GAEJmG,EAAW,CACP,EACA,o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","file":"app.js","sourcesContent":["(function () {\n    'use strict';\n\n    // Camera\n\n    const Camera = {\n        init() {\n            this.pos = { x: 0, y: 0, z: 0 };\n        },\n\n        update() {\n            this.pos = Game.player.pos;\n        }\n    };\n\n    // Constants\n    //\n    // Where possible, global values are all kept here in spot for easy tweaking.\n    // Don't worry about constant length -- our terser configuration in the build step\n    // is going to mangle all of our constants into tiny variable names.\n\n    // The \"screen area\", in ASCII characters.\n    const SCREEN_WIDTH = 80;\n    const SCREEN_HEIGHT = 24;\n\n    // The size in pixels of each character in our monospaced font.\n    const FONT_WIDTH = 8;\n    const FONT_HEIGHT = 16;\n\n    // Screen scaling -- currently not used.\n    const SCREEN_SCALE = 1;\n\n    // Playable area in pixels. Note that actual on-screen dimensions may differ to maintain\n    // aspect ratio -- see `Viewport.width` & `Viewport.height`.\n    //\n    // We add a little bit of padding to make sure we don't draw a character right on top of\n    // of the edge of the user's browser window.\n    const GAME_WIDTH = (SCREEN_WIDTH + 1) * FONT_WIDTH * SCREEN_SCALE;\n    const GAME_HEIGHT = (SCREEN_HEIGHT + 1) * FONT_HEIGHT * SCREEN_SCALE;\n\n    // Global frames per second\n    const FPS = 60;\n\n    // How many frames does a turn take? This game is essentially turn-based (enemies don't\n    // move unless the player moves). So this value really boils down to how fast the player\n    // moves if they hold down an arrow key.\n    //\n    // 12 frames = 5 tiles per second.\n    const TURN_FRAMES = 2;\n\n    // The number of lines of recent history to show to the player, in the normal (closed)\n    // case and the open (reviewing history) case.\n    const LOG_CLOSED_LINES = 3;\n    const LOG_OPEN_LINES = 15;\n\n    // Horizontal column for the divider between map and status area.\n    const STATUS_COL = 64;\n\n    // Object types\n    const TYPE_DOOR = 2;\n    const TYPE_HIDDEN = 3;\n    const TYPE_EXAMINE_ONLY = 4;\n\n    // Screen flickers\n    const FLICKER_FRAME_1 = 169;\n    const FLICKER_FRAME_2 = 221;\n\n    // Font\n    //\n    // This file is generated by `gulp buildAssets`.\n\n    const Font = {\n        async init() {\n            await new Promise(resolve => {\n                let image = new Image();\n                image.onload = resolve;\n                image.src = Font.data.uri;\n                Font.img = image;\n            });\n        },\n        data:\n    /* <generated> */\n    { uri:\n       'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAAEACAYAAAB7+X6nAAABiGlDQ1BzUkdCAAAokX2Ru0vDUBTGv6ZKi1REdBCpkKE6iAVRKA4uVrEIFUKtYNXBPPqCJA1Jiouj4FpwEF18DfoHiK4OroIgKIKIg3+Br0VKPDcJtEjrhUt+98s5H/d8F+DOVVmzOsYBTbfNTCrJr+RW+dAbAhhCL+JIiLJlzAhCGm3X9wNV07qPM6/2dS1Xt5K3ZCDAE8/LhmkTl4gTm7bB+Ii4Xy6JCvEF8ZhJFyR+Zbrk8SfjostcmLGZzcwSR4n5YhNLTSyXTI14mjimaDr5cxseK4y3GWtqVfbvySaM5PXlJfqO0o4iBRVlaDBgIQ8eEqp0VmFTamXopFjIUFWSsm3tM+j6CNQnuV4y9cyhQp6i6wD2Fn8ztgqTE55ThJw7XxznYxgI7QL1muP8HDtO/QQIPgPXeqO/QjlOfZFea2ixQ6CH5ry8aWjSHnC1Aww8GaIpulKQNlcoAO9n9Fw5oO8O6Frz8vP/4/QRyG4B6Vtg/wAYKZL3epu5w35+C1iE8G+Nn+Avca5059mUyFUAAA5CSURBVHic7V3ZcuQgDMRb+f9f9j5kcEDoBDyXuqtSmTGWkKERIBHnOM/zLEBa/Hu1AcBrAQIkBwiQHCBAcoAAyQECJAcIkBwgQHKAAMkBAiQHCJAcIEBygADJAQIkBwiQHCBAcoAAyQECJAcIkBwgQHKAAMkBAiQHCJAcIEBygADJAQIkBwiQHCBAcoAAyQECJAcIkBzHqw2oryc4joO9XoHyveUAUErZ5AGat4wcpZTrc4R1rY672GrVIZU/w7Znoj7PcRzHT1SoTDTCCkHIK2ysjpuyj9Gh3fYVJKhwE+BOkMZvCVqvtcSRCNUWr3QSJ8jV85EgbXc/AWjnkiJvw3KdT6Hq0kY4LaPkOY6jXVQNBPN4uHedRt7CAzwgtUp7/RSu07KZejxlH+0F6OgvZV8c4GiUtp+L83Mpv41bf65ReBxH/Tx0/uM61XOU32cdBjaR4x9EKDNGbS0cGvhdUZ9niwewGlTyvo8ycx6nizxS5yAbtXEFwtRyPsqkZ3uY5LNJm/YmdHQCt0cCjTVAO4qp5+Dka4NKI1z7DjzQkibiAW5p0MCbSun0wcl11ydGvbiDMBafpTBTlFAuGsUtFKu3UK02II3+UmIEmJ3fupWxUw+7VmimE9Httt8D28HIAq9T+LCJPt9Zxl1AJ+PF7mAavX77FOBYcLGLRroIJDEBuugsVH7BxmGwW9vEd4Y2+kt53hQgrv6Jq+uusYp497xj/vd4Ac9W1XPPgE0v7da3KkzbvQ2VZ13kM2x4hm10pO6qx7L9bQiQHe8wAAAAAIBU+A2y8yvQYS/pODAxyBurW7MOrzxzn1veen5v++xANGvouV+z/5/SQF2RdJ9X3oPZrdDKFsqyf+fzLdgyLa7ZX0ofB5DSrl7DomlbPfqi65fkuHu4a1IYeaV8CdJzWB6s9PELLfrJ2t8FggyXqcXfRXnl4EQxXCyF5OI7O7jDHJ0SpS4uKBUpt9yxcwoNxQGYjColQdc/1P6OAI6EB2uAIK+N8LOWMzLe0XWSCGBNwTamqZ3fhpLPsXj0XLtdvmQTsdtkgkYCawC0BOASNlcFD2HRiMCDdEYy5RReF86ZpLpDw+NVkk4niibKTQ+myQX657KF5gKmlrUeF9aQSGpQdzZPeFB1jtamJk2+GV2arZJOT7k6h0/ugjRDurJhEWgxicLqfDrvLeg3t0UeT1WUxpHkvR0yswZwzOEmnGuIYS1QCjMFLM5zwzws2zka1urgrhu2uedooXFFeaFgWxDAIEEki6gtINl2/SmO1f0iVP3MIuXvBvnMYGvfqv0z8uYoi0J6VssTWLsgCz/CHCdVzjWWWmNQ/1CHRz5o/4x9rJznWoXHPWm2aGKe+ovQT9vcGKBDioG8Gu/0hyHfDu9IBQAAAIBngIvHX2VcHJle1PIHRgBlJRff2j8TKePq5+7V9Hvy7628pd8dPIrolyKF9Xr4PEAgI3LdKsg4g2rrmKj/NryiUqbO65LrPICBjoVUXohRa4GXcEZSKw/Ub+mVIpRuBOL1krjmkdgQMlPnFW0spRz0L4NY5VVJ1d4qDWSv2v3vUZgGIKHPgbg1l9D+BMrN+lmjlXqCmM75CzrYcsXBHOR3KYWPA2h+2ai/58ZgQZMAkXQqySL6cNZyhJtTh3uUsrvwskAQl+wy/zaQRrDq7/MXquiMkTsQSqW9AJPmsSOYKQ+1uxYJlLJ0GqaMcMK9BnC4QSv5cyd52bn6VVAPhERz94bM9eCMV+luksomD1xcqsvf1k+Vjzwz3XJp2+KykPOvFRi2mYtEWs4dCWuVSd+lVT73/PTBBfv4RV9zTdJtwVu/z6hxTSzdytk2kECvSsxesrYKKWW68u90/xMMFSsIsJauutlyTXYHJusPVSFdE3ZIt/p+Z53Xd/U8ACfQfDf3xe2qn6tjNhfvsM9VTzOapp7P0s3Zx4zSmefjRjmp/s9TcDa+yxoEAAAAAIDXACuBJ0DYe4rp6Ig8c18ovvCjBS6MnLwZ+FiUr4GPpXz47vIawTnPs1j2l2BnrKCxIxRk0nIB53ku/X38qvzbeqeFrNHR/LTXLLWcnGaP28TIeYC7yml8/raOry6SsessY6jUawd3n+bVhu9WZ2nZU9LT4XBz5wGsSN9ieY2fPn5dH3bl26dgPU/pR+hADub8wQyRPV7AqyPUcF0uYKFyTZ6LxbOh0kmsjuBOB5WVRihnOyWI9/lmkm6tOLXJEdm9oK0BBiVBhmi5gFWy/VVij+ApHVIotwjEmu18Rm+obYj3Ea9JaAlwkB+L5apdrXxDgm4dsIsETnAZMWoI2wlCgkWUn/Fsr4rNs2sAhT3aSGAXeecDVT8jtwPaQlKqb4sdOzq/wY61QAiR18W3c2QpzEgq+givRJh9srMlU1ep4sIVV0738XQRFe2Eug5pEZF/iRfw/HHokHqUAiCOAwlUrwer8m40i6jdqivaZpO2aN2i1hFsclc4VHQc17FwsTHJ/H08lFIZuhLlvtetn7TG4FtjrN+SH/Q09f4aMba89V20T7CNrnfceLYXeM3K4yaEYqBPhDQIldh/d09U3lO3Vx4AAAD4WlyTQLsdiswNs3J36GRWvKZ8pC7PvfSeoIzb7l24/d/GPQvPDit+C77xJVF3Dh2P7pn6aSTzaWD/OpjbTXnclObuLHku1arIX7KMXtYGop+tK1CHJ1EmEoG2kxaAojYV8nzCc3X2c3pqGU0GWQZrl0+pzJIn5VqyxlDJw9IvXL9lVllUKrZxUezX2u8igJCxu4rJj4QhF8AwWB11VCFheCt/nr/n8qjO7ruln7Ffe/4Z2QtBWzj9llykfc9SlGwgwUl+Zgxsw7dcY1nyYv3OE0UR+zz6ovcMHbF5pW/pZJ/fXARGXJaVTOEydDTsqcmvwmvfM3BHXR6SltI//+w/j5bmdLoQGcqFFKxHfrXFLP13o637FWkL9vlnzgNoDcjNN7STtdWylvYdpiFnA1r6n4lhjfTsOul1DwG8NKULsXZelBZWXHl37+opIkv/M7HhWcKyQp3Xd5MASj6+HeHD59ZWQYd2ZrBbJErynLmOZ/AcLgnpr1CGNPcsEf3HQ790n/qdO9Nxtb1Q4VdB6JgtK/E7dT8DX5MLCOLODvqYzi/lO3MBHMagwL4OulP3MqqDYkLzrzAHeDe8DVVnzwB8GhwJJ1cSZxeyrgFegg0b/+2xgyxrgHdDZBi3gbBpSB6mfUNIu0dWc/3tfcLnToe0VSJhYaYq3ibL5heVcxBdtteVe/IjtHPrd8980U4B3nx+KJ+u+KxnhUK9sOxdV36DKto30Wq4l0V3CYtShvixyvgqq5RZMretAB+tw0XNrmdm7LJA7+uew8h9RED7huqq5Z4DNRe4E0FWR6nlSr6fTeZweXTlXIJmFx3BPmElVk7KWP3E1qFMqTOEicQXJzBc2/6KmPY+I+69xSt67JnRwZ1d0OQ4YjTfWyVTz82c7DnoZ+OwDUtK+ooYzcVP5dMfixLJTYahxN5b98f1GufmJZ1Svp61W+n8dhEXbjsBYe+ikZiuAaR8vth4FiboTncBpqoHyYZrjQ5p16Kdum1JwK2FOKPOx7XGjD9PsmsduDMYJJ0K7uY3riwAa02x+76uPDBFiGscbipb7ITzgX03TkL8lzHUjTFunJUbChRZTx3Cdem+QS9zv7g4ar0GNy0wcpI+CavTwPYdEvsqVgszMp8KaRs3+9zSVNVeJ4tL9v5d+Hkotf4ZETWCGyEZsNT5muzOLWMEnfbVkW3Jr5bfjU+3fwbIBiYHCJAcIEBygADJAQIkBwiQHFv/OnhdjJXXDklyiN4fqn9N7fvhFR5gKqRcirvVv6ZzngHvy6K9cB3G0KJeRs7Bssk6ibTr1FGk/reGSYBIREuKZ0ewcoiDG/lSXH01Uuet/92BRWBygADJAQIkBwiQHCAA8It28zyzkbbkV8vvxqfbPwt4gOQAAZIDBEgOECA5QIDkuCsdvC0f3OZivTpnZDz1c+Vfg2duY6xtFLketmmn/a+u/25gCkiO3f8vgPuLW/E+ek2Qcx/HsY7ueO3bWf+7w3MewPVQtFFmGiMiQ++1OmWHfTP1vzswBSQHCJAcIEBygADJAQIkB13J/hXMvR8gLF9l6P3WmzEkOQAAAMCLj/efWgDm7sjceZ4fPwVt/X8Bj86w3p9TpHtegVcS6B3QEUDrQKu8acjznPi3qI289mbP4SVMWkXfMELvxrUNDMSyh1sZ2VBoXOn89vfZft4dej8aBGS22vAK/JQyvu+2TaAV/i9er1Gu9ITLE2id37xEsZadzX3nab+AWX2fYQYXb+FnYSjVDmhHaIV1Iuc6cCMpZ14jGzZwVi4Tfsr8+2vpKO0L7dekty6eHd2NDs1LWGuAywvQz+4n/WL8O/i3gbcjm36/7ve0IaO/kyflwzzvmSKAedR3BXcjVdkFlDLR+ET/IM+8GcT8zHgHtmq3kRP4hl3GtQ10vp5F63zztTBVPyd/R0MSkl1ThnU6SDmeBgB/AEcAAPhsYK5LDpwISg4QIDlAgOQAAZIDBEgOECA5QIDkAAGSAwRIDhAgOUCA5AABkgMESA4QIDlAgOQAAZIDBEgOECA5QIDkAAGSAwRIDhAgOUCA5AABkgMESA4QIDlAgOQAAZIDBEgOECA5QIDkAAGSAwRIDhAgOUCA5AABkgMESA4QIDlAgOQAAZIDBEgOECA5QIDkAAGSAwRIDhAgOUCA5AABkgMESA4QIDlAgOQAAZIDBEgOECA5QIDkAAGSAwRIDhAgOUCA5AABkgMESA4QIDlAgOQAAZIDBEgOECA5QIDkAAGSAwRIDhAgOUCA5AABkgMESA4QIDlAgOQAAZIDBEgOECA5QIDk+A8CYVP2f4X6dwAAAABJRU5ErkJggg==' }\n    /* </generated> */\n    };\n\n    // Original: https://github.com/codyebberson/pico8-music\n    const FX_SLIDE = 1;\n    const FX_VIBRATO = 2;\n    const FX_DROP = 3;\n    const FX_FADE_IN = 4;\n    const FX_FADE_OUT = 5;\n    const FX_ARP_FAST = 6;\n    const SAMPLE_RATE = 44100;\n    const BASE_SPEED = 120;\n\n    /**\n     * Creates a new PICO-8 AudioCart using the \"sfx\" and \"music\" data from\n     * a cartridge file.\n     * @param {string} sfx\n     * @param {string} music\n     * @param {object} options\n     */\n    function AudioCart({ sfx, music }, options = {}) {\n      // Note: some browsers don't allow creation of an AudioContext unless you're inside\n      // a user-triggered event, like a mouse click or keypress. One way to control this\n      // is to initialize the AudioCart from a user-triggered event.\n      //\n      // (If you have multiple AudioCarts, you can choose to share an AudioContext by\n      // creating it yourself and passing it into each AudioCart in the options section.)\n      const audioCtx = options.audioCtx || new AudioContext();\n\n      // Each \"line\" of sfx and music represents one of the 64 allowed patterns in PICO-8.\n      // Note that sfx data contains a lot of \"nybbles\" (a single hex character, i.e., 4\n      // bits out of an 8-bit byte), which means the obvious improvement of breaking up\n      // each byte into integers isn't quite that simple.\n      //\n      // For now, the sfx and music data is processed \"as hex\" inline while we build up\n      // the audio samples.\n      let sfxData = sfx.split('\\n');\n      let musicData = music.split('\\n');\n\n      /**\n       * Previous brown noise.\n       * Need to track this to trim frequency ranges.\n       * See the noise oscillator.\n       * @type {number}\n       */\n      let prevNoise = 0;\n\n      /**\n       * Parses a hex substring into a decimal number.\n       * @param {string} str\n       * @param {number} start\n       * @param {number} len\n       * @return {number}\n       * @noinline\n       */\n      const parseHex = (str, start, len) => parseInt(str.substr(start, len), 16);\n\n      /**\n       * Rounds a number.\n       * This compresses better than Math.round.\n       * Google Closure Compiler inlines the calls.\n       * @param {number} x Input number.\n       * @return {number} Output number.\n       */\n      const round = (x) => (x + 0.5) | 0;\n\n      /**\n       * Triangle oscillator.\n       * @param {number} t\n       * @return {number}\n       */\n      const triangleOscillator = (t) => Math.abs(2 * t - 1) - 1.0;\n\n      /**\n       * Tilted saw oscillator.\n       * @param {number} t\n       * @return {number}\n       */\n      const tiltedSawOscillator = (t) => {\n        const a = 0.9;\n        const ret = t < a ? 2.0 * t / a - 1.0 : 2.0 * (1.0 - t) / (1.0 - a) - 1.0;\n        return ret * 0.5;\n      };\n\n      /**\n       * Saw oscillator.\n       * 0->1 ramp\n       * @param {number} t\n       * @return {number}\n       */\n      const sawOscillator = (t) => 0.6 * (t < 0.5 ? t : t - 1.0);\n\n      /**\n       * Square oscillator.\n       * 50% duty cycle square wave\n       * @param {number} t\n       * @return {number}\n       */\n      const squareOscillator = (t) => t < 0.5 ? 0.5 : -0.5;\n\n      /**\n       * Pulse oscillator.\n       * 20% duty cycle square wave\n       * @param {number} t\n       * @return {number}\n       */\n      const pulseOscillator = (t) => t < 0.3 ? 0.5 : -0.5;\n\n      /**\n       * Organ oscillator.\n       * tri-uneven: 100% tri 75% tri on loop\n       * @param {number} t\n       * @return {number}\n       */\n      const organOscillator = (t) => (\n        t < 0.5 ?\n          3.0 - Math.abs(24.0 * t - 6.0) :\n          1.0 - Math.abs(16.0 * t - 12.0)\n      ) / 9.0;\n\n      /**\n       * Noise oscillator.\n       * @return {number}\n       */\n      const noiseOscillator = () => {\n        const white = Math.random() * 2 - 1;\n        const brown = (prevNoise + (0.02 * white)) / 1.02;\n        prevNoise = brown;\n        return brown * 10; // (roughly) compensate for gain\n      };\n\n      /**\n       * Phaser oscillator.\n       * @param {number} t\n       * @param {number} value\n       * @return {number}\n       */\n      const phaserOscillator = (t, value) => {\n        // This one has a subfrequency of freq/128 that appears\n        // to modulate two signals using a triangle wave\n        const k = Math.abs(2.0 * ((value / 128.0) % 1.0) - 1.0);\n        const u = (t + 0.5 * k) % 1.0;\n        const ret = Math.abs(4.0 * u - 2.0) - Math.abs(8.0 * t - 4.0);\n        return ret / 6.0;\n      };\n\n      /**\n       * Oscillators.\n       * Order and indices are important!\n       * @const {!Array.<function(number=, number=): number>}\n       */\n      const oscillators = [\n        triangleOscillator,\n        tiltedSawOscillator,\n        sawOscillator,\n        squareOscillator,\n        pulseOscillator,\n        organOscillator,\n        noiseOscillator,\n        phaserOscillator,\n      ];\n\n      /**\n       * Returns note frequency from pitch index (0-63).\n       * From C-0 to D#-5 in chromatic scale.\n       * @param {number} pitch\n       * @return {number}\n       */\n      const getFreq = (pitch) => 65 * 2 ** (pitch / 12);\n\n      /**\n       * Cache of pre-built sounds.\n       * Key is `${sfxIndex}-${pitchOffset}\n       * Value is a Float32Array.\n       * @const {!Object}\n       */\n      const soundCache = {};\n\n      /**\n       * Builds the sound from scratch.\n       * @param {!Array.<string>} sfxData\n       * @param {number} sfxIndex\n       * @param {number} pitchOffset\n       * @return {!Float32Array}\n       */\n      const buildSound = (sfxData, sfxIndex, pitchOffset) => {\n        const sfxRow = sfxData[sfxIndex];\n        const noteLength = parseHex(sfxRow, 2, 2) / BASE_SPEED;\n        const loopStart = parseHex(sfxRow, 4, 2);\n        const loopEnd = parseHex(sfxRow, 6, 2) || 32;\n        const length = loopEnd * SAMPLE_RATE;\n        const data = new Float32Array(length);\n\n        /**\n         * Returns the next note index.\n         * Handles loop start/end.\n         * @param {number} i The current note index.\n         * @return {number} The next note index.\n         */\n        const getNextIndex = (i) => i + 1 >= loopEnd ? loopStart : i + 1;\n\n        /**\n         * Returns a data element from the sfx row.\n         * @param {number} index The note index. (0-32).\n         * @param {number} offset The element offset (0-4).\n         * @param {number} len The length in hex characters.\n         * @return {number} The sfx value.\n         */\n        const getSfx = (index, offset, len) => parseHex(sfxRow, 8 + index * 5 + offset, len);\n\n        let offset = 0;\n        let phi = 0;\n        let i = 0;\n\n        let prevNote = 24;\n        let prevFreq = getFreq(24);\n        let prevWaveform = -1;\n        let prevVolume = -1;\n        let prevEffect = -1;\n\n        let currNote;\n        let currFreq;\n        let currWaveform;\n        let currVolume;\n        let currEffect;\n\n        while (offset < length) {\n          currNote = getSfx(i, 0, 2) + pitchOffset;\n          currFreq = getFreq(currNote);\n          currWaveform = getSfx(i, 2, 1);\n          currVolume = getSfx(i, 3, 1) / 8.0;\n          currEffect = getSfx(i, 4, 1);\n\n          const next = getNextIndex(i);\n          const nextNote = getSfx(next, 0, 2) + pitchOffset;\n          const nextWaveform = getSfx(next, 2, 1);\n          const nextVolume = getSfx(next, 3, 1);\n          const nextEffect = getSfx(next, 4, 1);\n\n          let attack = 0.02;\n          if (currEffect === FX_FADE_IN ||\n            (currWaveform === prevWaveform &&\n              (currNote === prevNote || currEffect === FX_SLIDE) &&\n              prevVolume > 0 &&\n              prevEffect !== FX_FADE_OUT)) {\n            attack = 0;\n          }\n          let release = 0.05;\n          if (currEffect === FX_FADE_OUT ||\n            (currWaveform === nextWaveform &&\n              (currNote === nextNote || nextEffect === FX_SLIDE) &&\n              nextVolume > 0 &&\n              nextEffect !== FX_FADE_IN)) {\n            release = 0;\n          }\n\n          const samples = round(noteLength * SAMPLE_RATE);\n          const customInstrument = currWaveform > 7 && getSound(sfxData, currWaveform - 8, pitchOffset + currNote - 24);\n          let k = 0;\n          for (let j = offset; j < offset + samples; j++) {\n            // Note factor is the percentage of completion of the note\n            // 0.0 is the beginning\n            // 1.0 is the end\n            const noteFactor = (j - offset) / samples;\n\n            let envelope = 1.0;\n            if (noteFactor < attack) {\n              envelope = noteFactor / attack;\n            } else if (noteFactor > (1.0 - release)) {\n              envelope = (1.0 - noteFactor) / release;\n            }\n\n            let freq = currFreq;\n            let volume = currVolume;\n\n            if (currEffect === FX_SLIDE) {\n              freq = (1 - noteFactor) * prevFreq + noteFactor * currFreq;\n              if (prevVolume > 0) {\n                volume = (1 - noteFactor) * prevVolume + noteFactor * currVolume;\n              }\n            }\n            if (currEffect === FX_VIBRATO) {\n              freq *= 1.0 + 0.02 * Math.sin(7.5 * noteFactor);\n            }\n            if (currEffect === FX_DROP) {\n              freq *= 1.0 - noteFactor;\n            }\n            if (currEffect === FX_FADE_IN) {\n              volume *= noteFactor;\n            }\n            if (currEffect === FX_FADE_OUT) {\n              volume *= 1.0 - noteFactor;\n            }\n            if (currEffect >= FX_ARP_FAST) {\n              // From the documentation:\n              //   6 arpeggio fast  //  Iterate over groups of 4 notes at speed of 4\n              //   7 arpeggio slow  //  Iterate over groups of 4 notes at speed of 8\n              //   If the SFX speed is <= 8, arpeggio speeds are halved to 2, 4\n              // const m = (speed <= 8 ? 32 : 16) / (effect === FX_ARP_FAST ? 4 : 8);\n              // const n = (int)(m * 7.5 * offset / offsetPerSecond);\n              // const arp_note = (note_id & ~3) | (n & 3);\n              // freq = key_to_freq(sfx.notes[arp_note].key);\n              freq = currFreq;\n            }\n\n            phi += freq / SAMPLE_RATE;\n            if (currWaveform < 8) {\n              data[j] += volume * envelope * oscillators[currWaveform](phi % 1, phi);\n            } else {\n              data[j] += volume * envelope * customInstrument[k];\n              k = (k + 1) % customInstrument.length;\n            }\n          }\n\n          offset += samples;\n          prevNote = currNote;\n          prevFreq = currFreq;\n          prevWaveform = currWaveform;\n          prevVolume = currVolume;\n          prevEffect = currEffect;\n          i = getNextIndex(i);\n        }\n        return data;\n      };\n\n      /**\n       * Returns a sound buffer.\n       * Uses a cached buffer if available.\n       * Otherwise builds the sound from scratch.\n       * @param {!Array.<string>} sfxData\n       * @param {number} sfxIndex\n       * @param {number} pitchOffset\n       * @return {!Float32Array}\n       */\n      const getSound = (sfxData, sfxIndex, pitchOffset) => {\n        const key = sfxIndex + '-' + pitchOffset;\n        let sound = soundCache[key];\n        if (!sound) {\n          sound = buildSound(sfxData, sfxIndex, pitchOffset);\n          soundCache[key] = sound;\n        }\n        return sound;\n      };\n\n      /**\n       * @param {!Array.<string>} sfxData\n       * @param {!Float32Array} data\n       * @param {number} offset\n       * @param {number} endOffset\n       * @param {number} sfxIndex\n       * @param {number=} pitchOffset\n       */\n      const buildMusic = (sfxData, data, offset, endOffset, sfxIndex, pitchOffset = 0) => {\n        const sfxBuffer = getSound(sfxData, sfxIndex, pitchOffset);\n        let i = 0;\n        while (offset < endOffset) {\n          data[offset] += sfxBuffer[i];\n          i = (i + 1) % sfxBuffer.length;\n          offset++;\n        }\n      };\n\n      /**\n       * Builds a song and returns an audio buffer that can be used to play it.\n       * You should connect up your own audio destination before starting.\n       * @param {number=} startPattern\n       * @return {!AudioBufferSourceNode}\n       */\n      const createMusic = (startPattern = 0) => {\n        // Preprocess loop\n        // Need to do 4 things on this loop:\n        // 1) Find the \"time\" channels\n        //    Channels can run at different speeds, and therefore have different lengths\n        //    The length of a pattern is defined by the first non-looping channel\n        //    See: https://www.lexaloffle.com/bbs/?pid=12781\n        // 2) Calculate the pattern lengths\n        //    After we know the time channel, we can convert that into number of samples\n        // 3) Find the loop start time (if one exists)\n        //    Find the pattern with the \"start loop\" flag set\n        //    Otherwise default to beginning of the song\n        // 4) Find the end pattern and total song length\n        //    Find the pattern with the \"end loop\" flag set\n        //    Otherwise default to end of the song\n        const timeChannels = [];\n        const patternSamples = [];\n        let loopStart = 0;\n        let songLength = 0;\n        let endPattern = musicData.length - 1;\n        for (let pattern = startPattern; pattern <= endPattern; pattern++) {\n          const musicRow = musicData[pattern];\n          const flags = parseHex(musicRow, 0, 2);\n\n          timeChannels[pattern] = 0;\n          for (let channel = 0; channel < 4; channel++) {\n            const sfxIndex = parseHex(musicRow, 3 + channel * 2, 2);\n            if (sfxIndex < sfxData.length) {\n              const sfxRow = sfxData[sfxIndex];\n              const loopEnd = parseHex(sfxRow, 6, 2);\n              if (loopEnd === 0) {\n                timeChannels[pattern] = channel;\n                break;\n              }\n            }\n          }\n\n          const sfxIndex = parseHex(musicRow, 3 + timeChannels[pattern] * 2, 2);\n          const sfxRow = sfxData[sfxIndex];\n          const noteLength = parseHex(sfxRow, 2, 2) / BASE_SPEED;\n          patternSamples[pattern] = round(32 * noteLength * SAMPLE_RATE);\n\n          if ((flags & 1) === 1) {\n            loopStart = songLength;\n          }\n\n          songLength += 32 * noteLength;\n\n          if ((flags & 2) === 2) {\n            endPattern = pattern;\n            break;\n          }\n        }\n\n        // Now we have everything we need to build the song\n        const frameCount = SAMPLE_RATE * songLength;\n        const audioBuffer = audioCtx.createBuffer(1, frameCount, SAMPLE_RATE);\n        const data = audioBuffer.getChannelData(0);\n\n        // Main music generator loop\n        let offset = 0;\n        for (let pattern = startPattern; pattern <= endPattern; pattern++) {\n          const musicRow = musicData[pattern];\n          const samples = patternSamples[pattern];\n          for (let channel = 0; channel < 4; channel++) {\n            const sfxIndex = parseHex(musicRow, 3 + channel * 2, 2);\n            if (sfxIndex < sfxData.length) {\n              buildMusic(sfxData, data, offset, offset + samples, sfxIndex);\n            }\n          }\n          offset += samples;\n        }\n\n        const source = audioCtx.createBufferSource();\n        source.buffer = audioBuffer;\n        source.loop = true;\n        source.loopStart = loopStart;\n        return source;\n      };\n\n      /**\n       * Builds a song and immediately plays it.\n       * @param {number=} startPattern\n       * @return {!AudioBufferSourceNode}\n       */\n      const playMusic = (startPattern = 0) => {\n        const source = createMusic(startPattern);\n        source.connect(audioCtx.destination);\n        source.start();\n        return source;\n      };\n\n      this.music = createMusic;\n      this.playMusic = playMusic;\n    }\n\n    // audio.p8\n    const AudioData = { music: '00 01424144\\n00 01444144\\n00 01024147\\n00 01024344\\n00 01024344\\n00 00024344\\n01 01020544\\n00 01020444\\n00 01020544\\n00 00020344\\n00 01020544\\n00 01020444\\n00 01020544\\n00 00020344\\n00 41024344\\n02 41024344', sfx: '011600000f5250f4150f2130f7250f5150f7350f4150f5150f6250f4150f513147250f515157350f4150f7150f5250f4150f5130f7250f5150f7350f4150f5150f6250f4150f2130f7250f515107350f4150f715\\n011600000c5250c4150c5150c7250c5150c7350c4150c5150c6250c4150c5150d7250c5150d7350c4150c7150c5250c4150c5150c7250c5150c7350c4150c5150c6250c4150c5150c7250c5150d7350c4150c715\\n011600000c073000000c043000000c023000000c003000000c073000000c053000000c033000000c013306000c073000000c043000000c023000000c003306000c073000000c053000000c033000000c01330600\\n01160000157500300015730030001571003000030000300014750030001574003000147300300014710030000c70000000000000000000000000000000000000107300300010740147001075015700107600f760\\n011600000c7500c7500f7520000011750117501375012700127501255212750007000d750000000c750000000c740000000c730000000c720000000c710000000000000000000000000000000000000000000000\\n011600000c7500c7500f7520000011750117501375012700127501250212740007001173000000127100000000000000000000000000000000000000000000000000000000000000000000000000000000000000' };\n\n    // Audio\n\n    const Audio = {\n        init() {\n            if (this.initialized) return;\n\n            // Note: unlike most init() methods, this is called from the first\n            // user-triggered event (like a keypress), not the main game loop. This\n            // avoids warnings in browsers about being unable to create an AudioContext.\n            this.initialized = true;\n\n            const AC = window.AudioContext || window.webkitAudioContext;\n            this.audioCtx = new AC();\n\n            setTimeout(() => {\n                this.globalGain = this.audioCtx.createGain(this.audioCtx, { gain: 0 });\n                this.globalGain.connect(this.audioCtx.destination);\n                this.unmute(3);\n\n                this.cart = new AudioCart(AudioData, { audioCtx: this.audioCtx });\n\n                this.music = this.cart.music();\n                this.music.connect(this.globalGain);\n                this.music.start();\n            }, 1);\n        },\n\n        mute(seconds = 1) {\n            this.globalGain.gain.linearRampToValueAtTime(0, this.audioCtx.currentTime + seconds);\n        },\n\n        unmute(seconds = 1) {\n            this.globalGain.gain.linearRampToValueAtTime(1, this.audioCtx.currentTime + seconds);\n        }\n\n        // If I supported sound effects, I'd list them here.\n        // Due to lack of space, not yet implemented :)\n        //\n        /*playStuff() {\n            let sfx = this.cart.sfx(2);\n            sfx.connect(this.globalGain);\n            sfx.start();\n        }\n        */\n    };\n\n    // Input\n\n    const Input = {\n        Action: {\n            UP:        11,\n            DOWN:      12,\n            LEFT:      13,\n            RIGHT:     14,\n            CAST:      15,\n            SELECT:    25,\n            INVENTORY: 26,\n            LOG:       27,\n            HELP:      28,\n            BACK:      29\n        },\n\n        init() {\n            // Key action up/down state\n            this.keyboard = {};\n\n            // \"Pressed\" means an input was pressed THIS FRAME.\n            this.pressed = {};\n\n            // \"Released\" means an input was released THIS FRAME.\n            this.released = {};\n\n            // \"Held\" means an input is held down. The input was \"Pressed\" either\n            // this frame or in a past frame, and has not been \"Released\" yet.\n            this.held = {};\n\n            // How many frames was this input held down by the player. If [held]\n            // is false, it represents how long the input was last held down.\n            this.framesHeld = {};\n\n            this.keyMapping = {\n                ArrowUp: Input.Action.UP,\n                ArrowLeft: Input.Action.LEFT,\n                ArrowDown: Input.Action.DOWN,\n                ArrowRight: Input.Action.RIGHT,\n                KeyC: Input.Action.CAST,\n                KeyL: Input.Action.LOG,\n                KeyH: Input.Action.HELP,\n                KeyI: Input.Action.INVENTORY,\n                Enter: Input.Action.SELECT,\n                Escape: Input.Action.BACK\n            };\n\n            window.addEventListener('keydown', event => {\n                let action = this.keyMapping[event.code];\n                if (action) {\n                    this.keyboard[action] = true;\n\n                    if (action === Input.Action.SELECT) {\n                        Audio.init();\n                        Input.enterPressed = true;\n                    }\n                }\n            });\n\n            window.addEventListener('keyup', event => {\n                let action = this.keyMapping[event.code];\n                if (action) {\n                    this.keyboard[action] = false;\n                }\n            });\n        },\n\n        update() {\n            for (let action of Object.values(Input.Action)) {\n                let held = this.keyboard[action];\n\n                this.pressed[action] = !this.held[action] && held;\n                this.released[action] = this.held[action] && !held;\n\n                if (this.pressed[action]) {\n                    this.framesHeld[action] = 1;\n                } else if (this.held[action] && held) {\n                    this.framesHeld[action]++;\n                }\n\n                this.held[action] = held;\n            }\n        }\n    };\n\n    // WorldData\n    //\n    // This file is generated by `gulp buildAssets`.\n\n    /* <generated-constants> */\n    const $D_CLOSET = 1;\n    const $D_CLOSET_OPEN = 2;\n    const $D_DINING = 3;\n    const $D_DINING_OPEN = 4;\n    const $D_DRAW = 5;\n    const $D_FOYER = 6;\n    const $D_GARAGE = 7;\n    const $D_GARAGED = 8;\n    const $D_HALLWAY = 9;\n    const $D_KITCHEN = 10;\n    const $D_STUDY = 11;\n    const $F_ALTAR = 12;\n    const $F_ALTAR_A = 13;\n    const $F_BURNT_CHAIR = 14;\n    const $F_BURNT_CHAIR_A = 15;\n    const $F_DOLLHOUSE = 17;\n    const $F_DOLLHOUSE_A = 18;\n    const $F_DOLLHOUSE_B = 19;\n    const $F_DOLLHOUSE_C = 20;\n    const $F_DOLLHOUSE_D = 21;\n    const $F_DOLLHOUSE_E = 22;\n    const $F_DOLLHOUSE_F = 23;\n    const $F_DRAWER1 = 24;\n    const $F_DRAWER1_A = 25;\n    const $F_GRAFFITI = 26;\n    const $F_SHELF3 = 31;\n    const $F_SHELF3_A = 32;\n    const $F_STATUE = 35;\n    const $F_STATUE_A = 36;\n    const $F_STATUE_B = 37;\n    const $F_TABLE = 38;\n    const $F_VOTIVE = 39;\n    const $F_VOTIVE_A = 40;\n    const $F_VOTIVE_B = 41;\n    const $H_DIG = 42;\n    const $H_DIG_A = 43;\n    const $H_STATUE2 = 44;\n    const $H_STATUE2_A = 45;\n    const $H_STATUE2_B = 46;\n    const $H_WORDS = 47;\n    const $H_WORKBENCH = 48;\n    const $H_WORKBENCH_A = 49;\n    const $I_BURNT_NOTEBOOK = 74;\n    const $I_DOLL_SCULPTURE = 76;\n    const $I_DOLL_WORKBENCH = 75;\n    const $I_ENGRAVED_COIN = 78;\n    const $I_IRON_KNIFE = 71;\n    const $I_SCREWDRIVER = 77;\n    const $I_SILVER_KEY = 72;\n    const $I_UNCLE_LETTER = 73;\n    const $R_CLOSET = 58;\n    const $R_CLOSET_A = 59;\n    const $R_DINING = 60;\n    const $R_DRAW = 61;\n    const $R_GARAGE = 63;\n    const $R_GARAGE_A = 64;\n    const $R_HALLWAY = 65;\n    /* </generated-constants> */\n\n    const WorldData =\n    /* <generated-data> */\n    {\n        \"floors\": [\n            {\n                \"name\": \"1F\",\n                \"tiles\": [\n                    [\n                        32,\n                        32,\n                        32,\n                        129,\n                        129,\n                        129,\n                        129,\n                        129,\n                        129,\n                        129,\n                        134,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32\n                    ],\n                    [\n                        32,\n                        32,\n                        32,\n                        128,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        137,\n                        129,\n                        129,\n                        45,\n                        129,\n                        129,\n                        129,\n                        129,\n                        129,\n                        135,\n                        129,\n                        134,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32\n                    ],\n                    [\n                        32,\n                        32,\n                        32,\n                        128,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        124,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        93,\n                        128,\n                        168,\n                        128,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32\n                    ],\n                    [\n                        32,\n                        32,\n                        32,\n                        128,\n                        46,\n                        46,\n                        166,\n                        46,\n                        46,\n                        168,\n                        137,\n                        129,\n                        45,\n                        129,\n                        129,\n                        135,\n                        45,\n                        129,\n                        129,\n                        131,\n                        46,\n                        132,\n                        129,\n                        129,\n                        134,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32\n                    ],\n                    [\n                        32,\n                        32,\n                        32,\n                        129,\n                        129,\n                        129,\n                        129,\n                        129,\n                        129,\n                        129,\n                        138,\n                        46,\n                        46,\n                        46,\n                        46,\n                        128,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        167,\n                        137,\n                        129,\n                        129,\n                        129,\n                        45,\n                        129,\n                        129,\n                        138,\n                        32\n                    ],\n                    [\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        144,\n                        46,\n                        35,\n                        37,\n                        46,\n                        137,\n                        129,\n                        135,\n                        129,\n                        129,\n                        129,\n                        129,\n                        129,\n                        129,\n                        138,\n                        61,\n                        61,\n                        46,\n                        46,\n                        46,\n                        61,\n                        128,\n                        32\n                    ],\n                    [\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        133,\n                        131,\n                        46,\n                        37,\n                        35,\n                        46,\n                        128,\n                        60,\n                        132,\n                        46,\n                        46,\n                        46,\n                        46,\n                        35,\n                        46,\n                        128,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        132,\n                        134\n                    ],\n                    [\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        128,\n                        46,\n                        46,\n                        35,\n                        37,\n                        46,\n                        128,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        124,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        38,\n                        128\n                    ],\n                    [\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        132,\n                        134,\n                        46,\n                        46,\n                        46,\n                        46,\n                        124,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        128,\n                        91,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        133,\n                        131\n                    ],\n                    [\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        132,\n                        129,\n                        129,\n                        129,\n                        129,\n                        138,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        137,\n                        129,\n                        129,\n                        145,\n                        145,\n                        145,\n                        129,\n                        131,\n                        32\n                    ],\n                    [\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        132,\n                        129,\n                        129,\n                        129,\n                        45,\n                        129,\n                        129,\n                        145,\n                        129,\n                        131,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32\n                    ]\n                ],\n                \"rooms\": [\n                    [\n                        63,\n                        3,\n                        0,\n                        8,\n                        5\n                    ],\n                    [\n                        61,\n                        25,\n                        4,\n                        8,\n                        6\n                    ],\n                    [\n                        60,\n                        10,\n                        3,\n                        6,\n                        7\n                    ],\n                    [\n                        65,\n                        10,\n                        1,\n                        10,\n                        3\n                    ],\n                    [\n                        62,\n                        15,\n                        5,\n                        10,\n                        6\n                    ],\n                    [\n                        61,\n                        24,\n                        4,\n                        4,\n                        2\n                    ],\n                    [\n                        60,\n                        9,\n                        6,\n                        2,\n                        3\n                    ],\n                    [\n                        58,\n                        15,\n                        3,\n                        10,\n                        2\n                    ],\n                    [\n                        58,\n                        19,\n                        1,\n                        3,\n                        3\n                    ]\n                ],\n                \"objects\": [\n                    [\n                        5,\n                        24,\n                        7\n                    ],\n                    [\n                        9,\n                        12,\n                        3,\n                        2\n                    ],\n                    [\n                        3,\n                        15,\n                        8,\n                        2\n                    ],\n                    [\n                        17,\n                        22,\n                        6\n                    ],\n                    [\n                        7,\n                        10,\n                        2,\n                        2\n                    ],\n                    [\n                        10,\n                        13,\n                        1,\n                        2\n                    ],\n                    [\n                        29,\n                        6,\n                        3,\n                        4\n                    ],\n                    [\n                        6,\n                        19,\n                        10,\n                        2\n                    ],\n                    [\n                        34,\n                        16,\n                        6,\n                        4\n                    ],\n                    [\n                        35,\n                        31,\n                        7\n                    ],\n                    [\n                        14,\n                        18,\n                        2\n                    ],\n                    [\n                        30,\n                        25,\n                        5,\n                        4\n                    ],\n                    [\n                        31,\n                        26,\n                        5\n                    ],\n                    [\n                        8,\n                        3,\n                        3\n                    ],\n                    [\n                        8,\n                        3,\n                        2\n                    ],\n                    [\n                        8,\n                        3,\n                        1\n                    ],\n                    [\n                        24,\n                        9,\n                        3\n                    ],\n                    [\n                        48,\n                        7,\n                        3,\n                        3\n                    ],\n                    [\n                        48,\n                        8,\n                        3,\n                        3\n                    ],\n                    [\n                        26,\n                        27,\n                        9\n                    ],\n                    [\n                        26,\n                        28,\n                        9\n                    ],\n                    [\n                        26,\n                        29,\n                        9\n                    ],\n                    [\n                        16,\n                        25,\n                        8,\n                        4\n                    ],\n                    [\n                        33,\n                        30,\n                        5,\n                        4\n                    ],\n                    [\n                        44,\n                        10,\n                        7,\n                        3\n                    ],\n                    [\n                        1,\n                        16,\n                        3,\n                        2\n                    ],\n                    [\n                        12,\n                        23,\n                        4\n                    ],\n                    [\n                        27,\n                        22,\n                        10,\n                        4\n                    ],\n                    [\n                        11,\n                        28,\n                        4,\n                        2\n                    ],\n                    [\n                        38,\n                        13,\n                        7\n                    ],\n                    [\n                        38,\n                        12,\n                        5\n                    ],\n                    [\n                        38,\n                        13,\n                        6\n                    ],\n                    [\n                        38,\n                        12,\n                        7\n                    ],\n                    [\n                        38,\n                        12,\n                        6\n                    ],\n                    [\n                        38,\n                        13,\n                        5\n                    ],\n                    [\n                        39,\n                        20,\n                        2\n                    ],\n                    [\n                        47,\n                        18,\n                        3,\n                        3\n                    ],\n                    [\n                        42,\n                        20,\n                        8,\n                        3\n                    ],\n                    [\n                        28,\n                        10,\n                        5,\n                        4\n                    ]\n                ],\n                \"triggers\": [],\n                \"id\": 0\n            }\n        ],\n        \"bounds\": [\n            [\n                0,\n                0\n            ],\n            [\n                33,\n                11\n            ]\n        ],\n        \"spawn\": [\n            19,\n            8,\n            0\n        ],\n        \"strings\": [\n            0,\n            \"The door is barred by a metal plate, held in place by a series of screws.\\nYou could open it with the right tool.\",\n            \"You unscrew several screws and the metal plate clatters to the floor.\\n%y%0 You push the door open.\",\n            \"The lock is broken and the door won't budge. With the right tool, you can\\nprobably pry it open.\",\n            \"You wedge the knife between the door and frame. With a little effort, you\\nforce the broken lock away from the strike plate.\\n%y%0 You push the door open.\",\n            0,\n            \"The front door has jammed behind you and won't budge.\",\n            0,\n            \"The garage door is heavy and immobile. In the center of the door is\\na spray-painted eye, surrounded by rings of tiny symbols. It's hard\\nto breathe in this room, it's too small somehow.\",\n            0,\n            \"It seems to be locked from the other side.\",\n            \"It seems to be locked from the other side.\",\n            \"A makeshift altar rests against the back wall. Tiny animal bones and black\\nfeathers hang from every corner and crevice.\\nA miniature sculpture sits in the middle of the altar.\",\n            \"A makeshift altar rests against the back wall. Tiny animal bones and black\\nfeathers hang from every corner and crevice.\",\n            \"The charred remnants of a rocking chair.\\nA half-burnt notebook is resting on the melted seat cushion.\",\n            \"The charred remnants of a rocking chair.\",\n            \"This chair is covered in mildew, but otherwise uninteresting.\",\n            \"A vintage dollhouse. Normally you could open it up and take a look inside,\\nbut it's been locked with a small silver padlock.\",\n            \"You carefully unlock the padlock and swing the dollhouse open. Eerily, it\\nseems to be a miniature version of the house you stand in. Even the\\nfurniture is in the same locations.\",\n            \"The open dollhouse watches you impatiently.\",\n            \"The miniature workbench fits perfectly into a space in the garage. The\\ndollhouse accepts your gift eagerly.\",\n            \"The miniature sculpture fits perfectly into an alcove in the dining\\nroom. You feel your bond with the dollhouse deepen.\",\n            \"The open dollhouse welcomes you, waiting patiently.\",\n            \"Gauging carefully, you line up your knife and plunge it into the floor\\nof the dollhouse. Wood and concrete scream with glee behind you as\\nthe floor opens up.\",\n            \"A small dresser-drawer is sitting in the corner.\\nA small silver key is lying on top, attached to note.\",\n            \"A small dresser-drawer is sitting in the corner.\",\n            \"The wall is strangely spongy here, more like moss than wallpaper.\\nThe phrase %rHER CHILDREN %whas been spray-painted across the wall.\",\n            \"An oil painting hangs on the wall, out of place in this shabby room. It\\nseems to depict a planet being devoured by... something.\\nThe less you look at it, the better.\",\n            \"A painting used to hang here. %rAZATHOTH squirms, we will burst from\\n%rthis dimension like locusts on the old ones %whas been written\\nhere in thick red marker.\",\n            \"A rusty garage shelf.\",\n            \"The shelf is covered with dust, but not much else.\",\n            \"Someone has touched this shelf recently, the dust is noticeably absent.\\nA realistic miniature workbench rests on the shelf.\",\n            \"The shelf seems to have been recently used, most of the dust is wiped off.\",\n            \"The shelf is covered with dust, but not much else.\",\n            \"The stairs to the second floor are a wreck - you can't go up this way.\",\n            \"A crude, life-sized sculpture of a pregnant woman. One hand rests on her\\nbelly, and the other holds an iron knife.\\nThe sculpture's grip looks loose - perhaps you could take the knife.\",\n            \"With a tug, the sculpture releases the knife.\\n%y%0 You have obtained iron knife.\",\n            \"A crude, life-sized sculpture of a pregnant woman. One hand rests on her\\nbelly.\",\n            \"The dining room table is smashed to splinters. A black, sticky substance\\nthat smells like burning hair covers most of the table.\",\n            \"An armoire has been repurposed to hold dozens of votive candles. A message\\nis written on the back panel: %rSay her words%w.\\nYour spine tingles. You feel like you could recite something here.\",\n            \"Your voice echoes as you recite the words engraved on the coin.\\nYou shield your eyes as the candles burst into flame, the room lit bright\\nas day. Your mind is reeling, grasping for something it can't quite hold.\",\n            \"An old armoire holding dozens of burning votive candles. Her candles.\",\n            \"This is the spot, you can feel it under your feet. But your knife barely\\nmakes a dent in the old hardwood - there must be a better way.\",\n            \"This is the spot.\",\n            \"A life-sized sculpture of a woman. She holds in her arms a creature, all\\nlegs, heads, and arms, reaching upwards in celebration.\\nOne baby fist is clutching something round and shiny.\",\n            \"You reach carefully through the tangled limbs.\\n%y%0 You have obtained engraved coin.\",\n            \"A life-sized sculpture of a woman. She holds in her arms a creature, all\\nlegs, heads, and arms, reaching upwards in celebration.\",\n            \"Your goddess has left instructions on the wall for you. The old passages\\nare still alive under the entrance hallway. Your knife will do.\",\n            \"A sturdy wood and metal workbench, littered with debris.\\nLying amidst the junk and broken tools, you spot a screwdriver.\",\n            \"A sturdy wood and metal workbench, littered with debris.\",\n            0,\n            0,\n            0,\n            0,\n            0,\n            0,\n            0,\n            0,\n            [\n                \"SHRINE\",\n                \"This storage closet has been converted into some kind of shrine. The\\nunpainted wooden walls are carved with words, but none of them make\\nany sense to you.\"\n            ],\n            [\n                \"SHRINE\",\n                \"Her shrine. The walls are carved with instructions for her children.\"\n            ],\n            [\n                \"DINING ROOM\",\n                \"The dining room is somber and quiet. The walls are covered with\\nfaded squares where paintings used to hang.\"\n            ],\n            [\n                \"DRAWING ROOM\",\n                \"You are in a dimly lit drawing room filled with faded furniture.\\nThe room smells of musty upholstery.\"\n            ],\n            [\n                \"FOYER\",\n                \"You are in the foyer. The peeling paint and threadbare rugs seem even\\nolder than the outside of the house.\\nA dollhouse sits on a pedestal in the far corner of the room.\"\n            ],\n            [\n                \"GARAGE\",\n                \"The garage is empty, save for a few rusty shelves and the usual cobwebs.\\nThere must have been other furniture here recently, you can see lines\\nin the dust where a workbench used to be.\"\n            ],\n            [\n                \"GARAGE\",\n                \"The garage is empty, save for a few rusty shelves and the usual cobwebs.\\nThere is a sturdy workbench near the door.\"\n            ],\n            [\n                \"CHARRED HALLWAY\",\n                \"There must have been a fire at some point. Soot and grime coat the walls,\\nand the air stinks of burnt fabric.\"\n            ],\n            0,\n            0,\n            0,\n            0,\n            0,\n            [\n                \"iron knife\",\n                \"A large iron knife etched with\\ntiny symbols. It feels heavy\\nin your hand.\"\n            ],\n            [\n                \"small silver key\",\n                \"A small silver key. A note is\\nattached with a piece of twine.\\n\\n%r\\\"N is still here, stay on this\\n%r side.\\\"\"\n            ],\n            [\n                \"your uncle's letter\",\n                \"%r\\\"Dearest Emily,\\n\\n%r We are all in grave danger and\\n%r I am running out of time. I\\n%r cannot explain here but I need\\nyour help.\\\"\\n%w[The rest of the letter has been\\ncrossed out and is illegible.]\"\n            ],\n            [\n                \"half-burnt notebook\",\n                \"Most of the pages are too burnt\\nto read, but somehow one page\\nis crystal clear:\\n\\n%r\\\"Our Goddess walks the hills\\n%r in the shadow of the keening star\\n%r and we follow in her path\\\"\"\n            ],\n            [\n                \"miniature workbench\",\n                \"A curiously realistic miniature\\nworkbench, made of wood and metal.\\nMaybe there's some use for it.\"\n            ],\n            [\n                \"miniature sculpture\",\n                \"A miniature sculpture of a woman,\\nvery like the one you saw in\\nthe drawing room.\\nMaybe there's some use for it.\"\n            ],\n            [\n                \"screwdriver\",\n                \"A rusty, but still functional,\\ncrosshead screwdriver.\"\n            ],\n            [\n                \"engraved coin\",\n                \"An ancient coin engraved on both\\nsides with a short verse:\\n\\n%r\\\"Yidhra, Dream Witch,\\n%r I am your child.\\n%r Walk with me.\\\"\"\n            ]\n        ]\n    }\n    /* </generated-data> */\n    ;\n\n    // World\n\n    const World = {\n        FLOOR: 46, // '.'\n\n        init() {\n            this.reset();\n            this.visions = [];\n        },\n\n        draw() {\n            if (Game.frame % FLICKER_FRAME_1 > 1) {\n                let tiles = this.floors[0].tiles;\n                for (let y = 0; y < tiles.length; y++) {\n                    for (let x = 0; x < tiles[y].length; x++) {\n                        if (this.floors[0].visible[y][x]) {\n                            let object = this.objectAt({ x, y, z: 0 });\n                            if (object && object.type !== TYPE_HIDDEN) {\n                                Screen.writeOnMap(x, y, object.char, this.colorForObject(object));\n                            } else {\n                                let c = String.fromCharCode(tiles[y][x]);\n                                Screen.writeOnMap(x, y, c, this.colorForTile(c));\n                            }\n                        }\n                    }\n                }\n            }\n\n            Screen.write(0, 0, ' '.repeat(STATUS_COL));\n            Screen.write(0, 1, ' '.repeat(STATUS_COL));\n            Screen.write(0, 2, ' '.repeat(STATUS_COL));\n\n            if (Game.player.room) {\n                let name = World.strings[Game.player.room.id][0];\n                Screen.write(Math.floor((STATUS_COL - name.length) / 2), 1, name, Screen.GREEN);\n            }\n\n            /*\n            if (Game.frame % 133 === 0) {\n                //console.log('generating visions');\n                this.visions = [];\n                for (let i = 0; i < 10; i++) {\n                    this.visions.push([\n                        Math.floor(Math.random() * tiles[0].length),\n                        Math.floor(Math.random() * tiles.length),\n                        String.fromCharCode(97 + Math.floor(Math.random() * 26))\n                    ]);\n                }\n            } else if (Game.frame % 133 >= 5 && Game.frame % 133 <= 25) {\n                for (let vision of this.visions) {\n                    Screen.writeOnMap(vision[0], vision[1], vision[2], Screen.RED);\n                }\n            }\n            */\n        },\n\n        reset() {\n            // We want to be careful and CLONE (not reference) the world data, because\n            // this will be our \"working copy\" -- rooms and objects and even tiles might\n            // get updated and moved during game logic.\n            this.floors = WorldData.floors.map(floor => {\n                return {\n                    tiles: floor.tiles.map(row => [...row]),\n                    visible: floor.tiles.map(row => row.map(c => false)),\n                    objects: floor.objects.map(object => ({ id: object[0], x: object[1], y: object[2], type: object[3] })),\n                    rooms: floor.rooms.map(room => ({ id: room[0], x: room[1], y: room[2], width: room[3], height: room[4] })),\n                    // *COMBAT*\n                    //triggers: floor.triggers.map(trigger => ({ ...trigger }))\n                };\n            });\n            this.bounds = WorldData.bounds;\n            this.spawn = WorldData.spawn;\n            this.strings = WorldData.strings;\n\n            for (let floor of this.floors) {\n                // \"Lift\" all objects off the floor, and get their default character\n                for (let object of floor.objects) {\n                    if (object.type !== TYPE_HIDDEN) {\n                        object.char = String.fromCharCode(floor.tiles[object.y][object.x]);\n                        floor.tiles[object.y][object.x] = World.FLOOR;\n                    }\n                }\n            }\n        },\n\n        roomAt(pos) {\n            return this.floors[pos.z].rooms.find(room =>\n                pos.x >= room.x && pos.y >= room.y && pos.x < room.x + room.width && pos.y < room.y + room.height\n            );\n        },\n\n        objectAt(pos) {\n            return this.floors[pos.z].objects.find(object => object.x === pos.x && object.y === pos.y);\n        },\n\n        objectsById(id, map) {\n            let list = [];\n            for (let floor of this.floors) {\n                for (let object of floor.objects) {\n                    if (object.id === id) {\n                        list.push(object);\n                        if (map) map(object);\n                    }\n                }\n            }\n            return list;\n        },\n\n        roomsById(id, map) {\n            let list = [];\n            for (let floor of this.floors) {\n                for (let room of floor.rooms) {\n                    if (room.id === id) {\n                        list.push(room);\n                        if (map) map(room);\n                    }\n                }\n            }\n            return list;\n        },\n\n        tileAt(pos) {\n            let tiles = this.floors[pos.z].tiles;\n            if (pos.x < 0 || pos.y < 0 || pos.x >= tiles[0].length || pos.y >= tiles.length) return ' ';\n            return tiles[pos.y][pos.x];\n        },\n\n        canMoveInto(pos) {\n            let tile = this.tileAt(pos);\n            if (tile === 46 /* . */) return true;\n            return false;\n        },\n\n        colorForObject(object) {\n            if (object.finished) return Screen.DIM;\n            if (object.interacted) return Screen.YELLOW;\n            return Screen.BLUE;\n        },\n\n        colorForTile(tile) {\n            return tile === '.' ? Screen.DIM : Screen.WHITE;\n        },\n\n        makeVisible(roomId) {\n            for (let floor of this.floors) {\n                for (let room of floor.rooms) {\n                    if (room.id === roomId) {\n                        for (let y = room.y; y < room.y + room.height; y++) {\n                            for (let x = room.x; x < room.x + room.width; x++) {\n                                floor.visible[y][x] = true;\n                            }\n                        }\n                    }\n                }\n            }\n        },\n    };\n\n    // Util\n\n    function rgba(r, g, b, a) {\n        return `rgba(${r},${g},${b},${a})`;\n    }\n\n    function xyz2pos(x, y, z) {\n        return { x, y, z };\n    }\n\n    function createCanvas(width, height) {\n        let canvas = document.createElement('canvas');\n        canvas.width = width;\n        canvas.height = height;\n        let ctx = canvas.getContext('2d');\n        return { canvas, ctx };\n    }\n\n    /*\n    export function formatStat(value) {\n        return ('' + value).padStart(2);\n    }\n    */\n\n    function formatQuantity(value, valueMax) {\n        return ('' + value).padStart(3, ' ') + '/' + valueMax;\n    }\n\n    // Text\n\n    const Text = {\n        init() {\n            // We'll dynamically recolor the font sheet whenever a new rgba color is requested,\n            // then cache it for future use.\n            this.colorways = {};\n            this.colorways[''] = Font.img;\n\n            // The \"white\" font sheet, right from the sprite.\n            Text.white = Font.img;\n\n            // Recolored versions of the original font sheet, to use when constructing our glow.\n            //\n            // The color here is #33FF00 which is roughly the glow of the Kaypro II.\n            Text.terminal = recolor(Text.white, rgba(51 + 16, 255, 0 + 16, 1));\n            Text.terminal_shadow = recolor(Text.white, rgba(51, 255, 0, 0.4));\n        },\n\n        drawText(ctx, text, u, v, color = '') {\n            //console.log(text, color);\n            if (typeof text === 'number') text = String.fromCharCode(text);\n            let scale = 1;\n            let font = this.colorways[color];\n            if (!font) {\n                this.colorways[color] = font = recolor(Font.img, color);\n            }\n\n            if (Array.isArray(text)) {\n                for (let block of text) {\n                    Text.drawText(ctx, block.text, u + block.u * scale, v + block.v * scale, font, scale);\n                }\n                return;\n            }\n\n            for (let idx = 0; idx < text.length; idx++) {\n                let c = text.charCodeAt(idx);\n                let k = (c - 0) * FONT_WIDTH;\n                let drawable = (c !== 32);\n\n                // We clear the canvas in every frame, and it's a HUGE speed advantage not to draw an\n                // empty image (this check can save 1000+ drawImage calls a frame).\n                if (drawable) {\n                    ctx.drawImage(\n                        font,\n                        (k * scale) % font.width,\n                        Math.floor((k * scale) / (font.width)) * FONT_HEIGHT * scale,\n                        FONT_WIDTH * scale,\n                        FONT_HEIGHT * scale,\n                        u ,\n                        v,\n                        FONT_WIDTH * scale,\n                        FONT_HEIGHT * scale\n                    );\n                }\n                u += FONT_WIDTH * scale;\n            }\n        },\n\n        /*\n        measureWidth(text, scale = 1) {\n            return text.split('').reduce((sum, c) => sum + FONT_WIDTH, 0) * scale;\n        },\n        */\n\n        /*\n        splitParagraph(text, w, h) {\n            let cu = 0, cv = 0;\n            let next = () => ({ text: '', u: cu, v: cv });\n            let wip = next();\n            let list = [];\n\n            for (let c of text.split('')) {\n                let cWidth = Text.measureWidth(c, 1);\n                if (c === '\\n' || cu + cWidth > w) {\n                    let saved = '';\n                    if (c !== '\\n' && c !== ' ') {\n                        let space = wip.text.split(' ');\n                        if (space.length > 1) {\n                            saved = space.pop();\n                            wip.text = space.join(' ');\n                        }\n                    }\n                    if (wip.text.length > 0) list.push(wip);\n                    cu = 0;\n                    cv += FONT_HEIGHT;\n                    wip = next();\n                    if (saved.length > 0) {\n                        wip.text = saved;\n                        cu += Text.measureWidth(wip.text, 1);\n                    }\n                } else {\n                    cu += cWidth;\n                }\n                if (c !== '\\n') {\n                    wip.text = wip.text + c;\n                }\n            }\n\n            if (wip.text.length > 0) list.push(wip);\n\n            return list.map(line => ({\n                ...line,\n                w: Text.measureWidth(line.text, 1),\n                h: FONT_HEIGHT\n            }));\n        }\n        */\n    };\n\n    // Text utility functions, for manipulating the font sheet images\n\n    function recolor(font, color) {\n        let canvas = createCanvas(font.width, font.height);\n        canvas.ctx.fillStyle = color;\n        canvas.ctx.fillRect(0, 0, font.width, font.height);\n        canvas.ctx.globalCompositeOperation = 'destination-in';\n        canvas.ctx.drawImage(font, 0, 0);\n\n        return canvas.canvas;\n    }\n\n    /**\n     * `Screen` is a singleton that represents the virtual 80x25 character screen our game\n     * lives in. Components like PlayingField will \"draw\" (write text onto) this virtual\n     * screen each frame. Once all the text is written, the text will end up rendered on\n     * the viewport (canvas) in the browser.\n     */\n\n    /*\n    const SMUDGE_OFFSETS = [3,1,2,0,4,5,1,0,2,0];\n    let smudgeIndex = 0;\n    const smudgeOffset = () => {\n        smudgeIndex = (smudgeIndex + 1) % SMUDGE_OFFSETS.length;\n        return SMUDGE_OFFSETS[smudgeIndex];\n    };\n    */\n\n    const Screen = {\n        // Terminal color codes\n        DIM:     0x00,\n        RED:     0x01,\n        GREEN:   0x02,\n        YELLOW:  0x03,\n        BLUE:    0x04,\n        MAGENTA: 0x05,\n        CYAN:    0x06,\n        WHITE:   0x07,\n        BRIGHT:  0x08,\n\n        // Useful character codes\n        SPACE:   0x20,\n\n        init() {\n            this.screen = [];\n            this.smudge = 5;\n            this.clear();\n\n            // Terminal color names to hex color mappings\n            Screen.COLORS = {\n                [Screen.DIM]:                   rgba(144, 144, 144, 1),\n                [Screen.RED]:                   rgba(214, 69,  46,  1),\n                [Screen.GREEN]:                 rgba(151, 216, 122, 1),\n                [Screen.YELLOW]:                rgba(238, 212, 83,  1),\n                [Screen.BLUE]:                  rgba(70,  151, 226, 1),\n                [Screen.WHITE]:                 rgba(214, 214, 214, 1),\n                [Screen.WHITE | Screen.BRIGHT]: rgba(255, 255, 255, 1)\n            };\n        },\n\n        clear(startX = 0, startY = 0, width = SCREEN_WIDTH, height = SCREEN_HEIGHT) {\n            for (let y = startY; y < startY + height; y++) {\n                for (let x = startX; x < startX + width; x++) {\n                    this.screen[y * SCREEN_WIDTH + x] = Screen.SPACE | (Screen.WHITE << 8);\n                }\n            }\n        },\n\n        write(x, y, text, color = Screen.WHITE, x2 = SCREEN_WIDTH) {\n            if (typeof text !== 'string') throw new Error('string');\n            //if (color === undefined) color = Screen.WHITE;\n\n            let ox = x;\n\n            for (let i = 0; i < text.length; i++) {\n                let c = text.charCodeAt(i);\n\n                if (text[i] === '\\n') {\n                    x = ox;\n                    y++;\n                    continue;\n                }\n\n                if (text[i] === '%') {\n                    switch (text[++i]) {\n                        case 'd':\n                            color = Screen.DIM;\n                            continue;\n                        case 'r':\n                            color = Screen.RED;\n                            continue;\n                        case 'g':\n                            color = Screen.GREEN;\n                            continue;\n                        case 'b':\n                            color = Screen.BLUE;\n                            continue;\n                        case 'y':\n                            color = Screen.YELLOW;\n                            continue;\n                        case 'w':\n                            color = Screen.WHITE;\n                            continue;\n                        case 'W':\n                            color = Screen.WHITE | Screen.BRIGHT;\n                            continue;\n                        case '0':\n                            c = 0xa5;\n                            break;\n                        case '1':\n                            c = 0xa4;\n                            break;\n                        default:\n                            i--;\n                    }\n                }\n\n                this.screen[y * SCREEN_WIDTH + x] = c | (color << 8);\n                x++;\n                if (x >= x2) {\n                    x = ox;\n                    y++;\n                }\n            }\n        },\n\n        writeOnMap(x, y, text, color, x2) {\n            let offset = {\n                x: 32 - Camera.pos.x,\n                y : 12 - Camera.pos.y\n            };\n\n            this.write(x + offset.x, y + offset.y, text, color, x2);\n        },\n\n        writeBox(x, y, w, h, color) {\n            if (w > 2 && h > 2) {\n                Screen.clear(x + 1, y + 1, w - 2, h - 2);\n            }\n            this.write(x, y, `\\x95${'\\x91'.repeat(w - 2)}\\x96`, color);\n            this.write(x, y + h - 1, `\\x94${'\\x91'.repeat(w - 2)}\\x93`, color);\n            for (let i = y + 1; i < y + h - 1; i++) {\n                this.write(x, i, '\\x90', color);\n                this.write(x + w - 1, i, '\\x90', color);\n            }\n        },\n\n        draw(ctx) {\n            if (Game.frame % FLICKER_FRAME_2 > 0) {\n                for (let y = 0; y < SCREEN_HEIGHT; y++) {\n                    for (let x = 0; x < SCREEN_WIDTH; x++) {\n                        let c = this.screen[y * SCREEN_WIDTH + x];\n                        let c2 = (c & 0xFF);\n                        if (c2 !== 32 /*&& c2 < 128*/ && this.smudge > 0) c2 += this.smudge;\n                        Text.drawText(ctx, c2, x * FONT_WIDTH, y * FONT_HEIGHT, Screen.COLORS[c >> 8]);\n                    }\n                }\n            }\n        }\n    };\n\n    // Log\n\n    const Log = {\n        init() {\n            this.entries = [];\n        },\n\n        add(message, formatCode = '') {\n            //console.log(message);\n            if (message[0] !== '%') {\n                message = formatCode + '\\xa5 ' + message;\n            }\n\n            this.entries.push(message.split('\\n'));\n\n            // In a real game, you'd definitely want some kind of normalized line-splitting\n            // going on here... but for JS13k, I just have carefully crafted every string in\n            // world.yaml to fit into the appropriate spaces (either the log/description\n            // area, or the inventory description area).\n\n            // For a while, I was trying to do the whole\n            /*let array = [];\n\n            while (message.length > LOG_WIDTH) {\n                array.push(message.slice(0, LOG_WIDTH));\n                message = message.slice(LOG_WIDTH);\n            }\n            if (message.length > 0) array.push(message);\n            this.entries.push(array);*/\n        },\n\n        obtainedItem(id) {\n            Log.add(`%y%0 You have obtained ${World.strings[id][0]}.`);\n        },\n\n        draw(lines = 3) {\n            let boxHeight = lines + 2;\n            let boxStart = 22 - lines;\n            let temporaryBlanks = 0;\n\n            if (this.entries[this.entries.length - 1].length < 3)\n                temporaryBlanks = 3 - this.entries[this.entries.length - 1].length;\n            let display = this.entries.flat();\n            while (temporaryBlanks-- > 0) display.push('');\n            if (display.length > lines) {\n                display = display.slice(display.length - lines);\n            }\n\n            Screen.writeBox(0, boxStart, 80, boxHeight, Screen.DIM);\n            Screen.write(STATUS_COL, boxStart, '\\x98', Screen.DIM);\n\n            for (let i = 0; i < display.length; i++) {\n                Screen.write(2, boxStart + i + 1, display[i]);\n            }\n        }\n    };\n\n    // LogScreen\n\n    class LogScreen {\n        constructor() {\n            this.lines = LOG_CLOSED_LINES;\n            this.offset = 0;\n        }\n\n        update() {\n            if (Input.pressed[Input.Action.BACK] || Input.pressed[Input.Action.LOG]) {\n                this.closing = true;\n            }\n\n            if (this.closing) {\n                this.lines -= 2;\n                if (this.lines <= LOG_CLOSED_LINES) {\n                    this.cull = true;\n                    return;\n                }\n            } else {\n                if (this.lines < LOG_OPEN_LINES) this.lines += 2;\n\n                if (Input.pressed[Input.Action.UP]) {\n                    this.offset++;\n                } else if (Input.pressed[Input.Action.DOWN]) {\n                    this.offset--;\n                }\n            }\n\n            this.offset = Math.min(this.offset, 0);\n            this.offset = Math.max(this.offset, Log.entries.flat().length - this.lines);\n        }\n\n        draw() {\n            Screen.clear(0, SCREEN_HEIGHT - this.lines - 1, SCREEN_WIDTH, this.lines + 2);\n            Log.draw(this.lines, this.offset);\n        }\n    }\n\n    // HelpScreen\n\n    class HelpScreen {\n        constructor() {\n            this.expand = 2;\n        }\n\n        update() {\n            if (Input.pressed[Input.Action.BACK] || Input.pressed[Input.Action.HELP]) {\n                this.closing = true;\n            }\n\n            if (this.closing) {\n                this.expand -= 2;\n                if (this.expand === 2) {\n                    this.cull = true;\n                    return;\n                }\n            } else {\n                if (this.expand < 22) this.expand += 2;\n            }\n        }\n\n        draw() {\n            const help = `                                  %gHELP\n\n%gCONTROLS\n  %W\\xa0\\xa1\\xa2\\xa3    %wMove / Investigate / Attack\n  %WI       %wOpen inventory\n  %WL       %wExpand logbook\n  %WH       %wToggle help (this screen)\n\n%gMAP LEGEND\n  %W@       %wYou\n  %d.       %wEmpty floors\n  %w\\x80\\x81      %wWalls\n  %b|- %d'    %wDoors (%bclosed%w / %dopen%w)\n  %b< >     %wStairways (up / down)\n\n  %b&!      %wBlue objects can be investigated\n  %y%#      %wYellow objects may need to be revisited later\n  %d=$      %wGray objects have already been investigated\n\n  %rsfVH    %wRed letters are foes`;\n\n            Screen.writeBox(2, 12 - Math.floor(this.expand / 2), 76, this.expand, Screen.GREEN);\n            Screen.write(4, 13 - Math.floor(this.expand / 2), help.split('\\n').slice(0, this.expand).join('\\n'));\n        }\n    }\n\n    // InventoryScreen\n\n    class InventoryScreen {\n        constructor(object) {\n            this.object = object;\n            this.expand = 2;\n            this.selected = 0;\n            this.list = Game.player.inventory;\n        }\n\n        update() {\n            if (Input.pressed[Input.Action.BACK]) {\n                this.closing = true;\n            } else if (Input.pressed[Input.Action.INVENTORY] && !this.object) {\n                this.closing = true;\n            } else if (Input.pressed[Input.Action.DOWN]) {\n                this.selected = (this.selected + 1) % this.list.length;\n            } else if (Input.pressed[Input.Action.UP]) {\n                this.selected = (this.selected + this.list.length - 1) % this.list.length;\n            } else if (Input.pressed[Input.Action.SELECT] && this.object) {\n                this.closing = true;\n                Game.player.useItemOn(this.object, this.list[this.selected]);\n            }\n\n            if (this.closing) {\n                this.cull = true;\n            }\n        }\n\n        draw() {\n            Screen.writeBox(5, 6, 71, 10, Screen.GREEN);\n            Screen.write(38, 6, '\\x97', Screen.GREEN);\n            Screen.write(38, 15, '\\x98', Screen.GREEN);\n            for (let y = 7; y < 15; y++) {\n                Screen.write(38, y, '\\x90', Screen.GREEN);\n            }\n\n            for (let idx = 0; idx < this.list.length; idx++) {\n                let [name, description] = World.strings[this.list[idx]];\n                if (idx === this.selected) {\n                    Screen.write(6, 7 + idx, `%0${name.padEnd(30)}%1`, Screen.GREEN);\n                    Screen.write(40, 7, description);\n                } else {\n                    Screen.write(7, 7 + idx, name);\n                }\n            }\n            if (this.object) {\n                Screen.write(6, 14, '[\\xa0\\xa1\\xa2\\xa3ENTER] Use item  [ESC] Back', Screen.DIM);\n            } else {\n                Screen.write(6, 14, '[\\xa0\\xa1\\xa2\\xa3] Examine item   [ESC] Back', Screen.DIM);\n            }\n        }\n    }\n\n    // GoodbyeScreen\n\n    class GoodbyeScreen {\n        constructor() {\n            Screen.smudge = 7;\n            Audio.mute(12);\n        }\n\n        update() {\n        }\n\n        draw() {\n            let goodbye = `                     %gSHADOW OF THE KEENING STAR\n\n%wYour uncle forgotten for now, you scrabble into the newly-opened\nhole in the floor. Your mind is singing with a clarity you have\nnever felt before as you go to meet your Goddess for the first time.\n\nYou have a feeling this is only the beginning...\n\n\n\n\n                             %d(THE END)`;\n\n            Screen.clear();\n            Screen.writeBox(4, 4, 72, 15, Screen.GREEN);\n            Screen.write(6, 5, goodbye);\n        }\n    }\n\n    // Player\n    //import { WorldParticle } from './WorldParticle';\n\n    class Player {\n        constructor(pos) {\n            this.pos = { ...pos };\n\n            this.lookingAt = this.room;\n            this.inventory = [];\n\n            this.speed = 4;\n            this.hp = this.hpMax = 100;\n            this.sp = this.spMax = 100;\n\n            // *COMBAT*\n            // this.vigor = 8;\n            // this.insight = 12;\n            // this.will = 10;\n            // this.updateStats();\n            // this.weapon = { ar: 0.5 };\n            // this.df = flood(this.pos);\n\n            // The player starts with the uncle's letter.\n            this.obtainItem($I_UNCLE_LETTER);\n\n            // The foyer door is locked.\n            World.objectsById($D_FOYER, object => object.finished = true);\n\n            // The player is in the foyer (starting room).\n            this.room = World.roomAt(this.pos);\n            Log.add(World.strings[this.room.id][1]);\n            World.makeVisible(this.room.id);\n        }\n\n        draw() {\n            Screen.writeOnMap(this.pos.x, this.pos.y, '@', Screen.WHITE | Screen.BRIGHT);\n        }\n\n        update() {\n            let move;\n\n            if (Input.held[Input.Action.LEFT] && Input.framesHeld[Input.Action.LEFT] % TURN_FRAMES === 1) {\n                move = { ...this.pos, x: this.pos.x - 1 };\n            } else if (Input.held[Input.Action.RIGHT] && Input.framesHeld[Input.Action.RIGHT] % TURN_FRAMES === 1) {\n                move = { ...this.pos, x: this.pos.x + 1 };\n            } else if (Input.held[Input.Action.UP] && Input.framesHeld[Input.Action.UP] % TURN_FRAMES === 1) {\n                move = { ...this.pos, y: this.pos.y - 1 };\n            } else if (Input.held[Input.Action.DOWN] && Input.framesHeld[Input.Action.DOWN] % TURN_FRAMES === 1) {\n                move = { ...this.pos, y: this.pos.y + 1 };\n            }\n\n            if (move) {\n                this.interactWith(move);\n            }\n            return !!move;\n        }\n\n        interactWith(pos) {\n            let tile = World.tileAt(pos);\n            let object = World.objectAt(pos);\n            let entity = Game.entityAt(pos);\n\n            if (entity) ; else if (object && object.type !== TYPE_HIDDEN) {\n                if (object.open) {\n                    this.moveInto(pos, false);\n                } else if (object.finished) {\n                    this.lookingAt = object;\n                    Log.add(World.strings[object.id]);\n                } else {\n                    /**** SPECIAL OBJECTS ****/\n                    if (object.id === $D_CLOSET) {\n                        Log.add(World.strings[object.id]);\n                        if (object.interacted) {\n                            this.openInventoryFor(object);\n                        }\n                    } else if (object.id === $D_DINING) {\n                        Log.add(World.strings[object.id]);\n                        if (object.interacted) {\n                            this.openInventoryFor(object);\n                        }\n                    } else if (object.id === $D_DRAW) {\n                        this.openDoor(object);\n                        World.makeVisible($R_DRAW);\n                    } else if (object.id === $D_KITCHEN) {\n                        Log.add(World.strings[object.id]);\n                    } else if (object.id === $D_GARAGE) {\n                        this.openDoor(object);\n                        World.makeVisible($R_GARAGE);\n                    } else if (object.id === $D_GARAGED) {\n                        Log.add(World.strings[object.id]);\n                        this.sp -= 3;\n                        Screen.smudge = 4;\n                        World.objectsById($D_GARAGED, object => object.finished = true);\n                    } else if (object.id === $D_HALLWAY) {\n                        this.openDoor(object);\n                        World.makeVisible($R_HALLWAY);\n                    } else if (object.id === $D_STUDY) {\n                        Log.add(World.strings[object.id]);\n                    } else if (object.id === $F_ALTAR) {\n                        Log.add(World.strings[object.id]);\n                        object.id = $F_ALTAR_A;\n                    } else if (object.id === $F_ALTAR_A) {\n                        object.finished = true;\n                        Log.obtainedItem($I_DOLL_SCULPTURE);\n                        this.obtainItem($I_DOLL_SCULPTURE);\n                    } else if (object.id === $F_BURNT_CHAIR) {\n                        Log.add(World.strings[object.id]);\n                        object.id = $F_BURNT_CHAIR_A;\n                    } else if (object.id === $F_BURNT_CHAIR_A) {\n                        object.finished = true;\n                        Log.obtainedItem($I_BURNT_NOTEBOOK);\n                        this.obtainItem($I_BURNT_NOTEBOOK);\n                    } else if (object.id === $F_DRAWER1) {\n                        Log.add(World.strings[object.id]);\n                        object.id = $F_DRAWER1_A;\n                    } else if (object.id === $F_DRAWER1_A) {\n                        object.finished = true;\n                        Log.obtainedItem($I_SILVER_KEY);\n                        this.obtainItem($I_SILVER_KEY);\n                    } else if (object.id === $F_DOLLHOUSE) {\n                        Log.add(World.strings[object.id]);\n                        if (object.interacted) {\n                            this.openInventoryFor(object);\n                        }\n                    } else if (object.id === $F_DOLLHOUSE_B || object.id === $F_DOLLHOUSE_E) {\n                        Log.add(World.strings[object.id]);\n                        this.openInventoryFor(object);\n                    } else if (object.id === $F_GRAFFITI) {\n                        Log.add(World.strings[object.id]);\n                        this.sp -= 3;\n                        Screen.smudge = 2;\n                        World.objectsById($F_GRAFFITI, object => object.finished = true);\n                    } else if (object.id === $F_SHELF3) {\n                        Log.add(World.strings[object.id]);\n                        object.id = $F_SHELF3_A;\n                    } else if (object.id === $F_SHELF3_A) {\n                        object.finished = true;\n                        Log.obtainedItem($I_DOLL_WORKBENCH);\n                        this.obtainItem($I_DOLL_WORKBENCH);\n                    } else if (object.id === $F_STATUE) {\n                        Log.add(World.strings[object.id]);\n                        object.id = $F_STATUE_A;\n                    } else if (object.id === $F_STATUE_A) {\n                        Log.add(World.strings[object.id]);\n                        object.id = $F_STATUE_B;\n                        object.finished = true;\n                        this.sp -= 2;\n                        this.obtainItem($I_IRON_KNIFE);\n                    } else if (object.id === $F_TABLE) {\n                        Log.add(World.strings[object.id]);\n                        World.objectsById($F_TABLE, object => object.finished = true);\n                    } else if (object.id === $H_STATUE2) {\n                        Log.add(World.strings[object.id]);\n                        object.id = $H_STATUE2_A;\n                    } else if (object.id === $H_STATUE2_A) {\n                        Log.add(World.strings[object.id]);\n                        object.id = $H_STATUE2_B;\n                        object.finished = true;\n                        this.sp -= 3;\n                        this.obtainItem($I_ENGRAVED_COIN);\n                    } else if (object.id === $F_VOTIVE) {\n                        Log.add(World.strings[object.id]);\n                        if (object.interacted) {\n                            this.openInventoryFor(object);\n                        }\n                    } else if (object.id === $H_DIG) {\n                        Log.add(World.strings[object.id]);\n                    } else if (object.id === $H_DIG_A) {\n                        // End the game!\n                        Game.screens.push(new GoodbyeScreen());\n                    } else if (object.id === $H_WORDS) {\n                        Log.add(World.strings[object.id]);\n                        object.finished = true;\n                        World.objectsById($H_DIG, object => {\n                            object.type = 0;\n                            object.char = 'X';\n                        });\n                        World.objectsById($F_DOLLHOUSE_B, object => object.id = $F_DOLLHOUSE_E);\n                    } else if (object.id === $H_WORKBENCH) {\n                        Log.add(World.strings[object.id]);\n                        World.objectsById($H_WORKBENCH, object => {\n                            object.id = $H_WORKBENCH_A;\n                            object.interacted = true;\n                        });\n                    } else if (object.id === $H_WORKBENCH_A) {\n                        World.objectsById($H_WORKBENCH_A, object => {\n                            object.finished = true;\n                        });\n                        this.sp--;\n                        Log.obtainedItem($I_SCREWDRIVER);\n                        this.obtainItem($I_SCREWDRIVER);\n                    } else if (object.type === TYPE_DOOR) {\n                        this.openDoor(object);\n                    } else if (object.type === TYPE_EXAMINE_ONLY) {\n                        Log.add(World.strings[object.id]);\n                        object.finished = true;\n                        this.sp--;\n                    } else {\n                        let action = '';\n                        if (object.action) {\n                            action = `\\n${object.action}`;\n                        } else if (object.interacted) {\n                            action = `\\n%y\\xa5 You need some kind of other item.`;\n                        }\n                        this.lookingAt = object;\n                        Log.add(World.strings[object.id] + action);\n                    }\n                }\n\n                object.interacted = true;\n            } else if (tile === World.FLOOR) {\n                this.moveInto(pos, true);\n            } else ;\n        }\n\n        moveInto(pos, updateRoom) {\n            this.pos = pos;\n            //this.df = flood(this.pos);\n            if (updateRoom) {\n                // This is a cheap, easy way to make doors part of \"both rooms\" - when you step\n                // between rooms, the current room description doesn't update until you walk\n                // past the doorway.\n                let room = World.roomAt(this.pos);\n                if (this.room !== room) {\n                    Log.add(World.strings[room.id][1]);\n                }\n                this.room = room;\n                this.lookingAt = this.room;\n            }\n        }\n\n        openInventoryFor(object) {\n            Game.screens.push(new InventoryScreen(object));\n        }\n\n        useItemOn(object, item) {\n            if (object.id === $D_CLOSET && item === $I_SCREWDRIVER) {\n                this.openDoor(object, $D_CLOSET_OPEN);\n                this.sp -= 3;\n                World.makeVisible($R_CLOSET);\n            } else if (object.id === $D_DINING && item === $I_IRON_KNIFE) {\n                this.openDoor(object, $D_DINING_OPEN);\n                World.makeVisible($R_DINING);\n            } else if (object.id === $F_DOLLHOUSE && item === $I_SILVER_KEY) {\n                Log.add(World.strings[$F_DOLLHOUSE_A]);\n                object.id = $F_DOLLHOUSE_B;\n                this.removeItem($I_SILVER_KEY);\n            } else if (object.id === $F_DOLLHOUSE_B && item === $I_DOLL_WORKBENCH) {\n                Log.add(World.strings[$F_DOLLHOUSE_C]);\n                this.removeItem($I_DOLL_WORKBENCH);\n                World.objectsById($H_WORKBENCH, object => {\n                    object.type = 0;\n                    object.char = '\\xa7';\n                });\n                World.strings[$R_GARAGE][1] = World.strings[$R_GARAGE_A][1];\n            } else if (object.id === $F_DOLLHOUSE_B && item === $I_DOLL_SCULPTURE) {\n                Log.add(World.strings[$F_DOLLHOUSE_D]);\n                this.removeItem($I_DOLL_SCULPTURE);\n                World.objectsById($H_STATUE2, object => {\n                    object.type = 0;\n                    object.char = '&';\n                });\n            } else if (object.id === $F_DOLLHOUSE_E && item === $I_IRON_KNIFE) {\n                Log.add(World.strings[$F_DOLLHOUSE_F]);\n                this.removeItem($I_IRON_KNIFE);\n                object.finished = true;\n                World.objectsById($H_DIG, object => {\n                    object.id = $H_DIG_A;\n                    object.char = '>';\n                });\n            } else if (object.id === $F_VOTIVE && item === $I_ENGRAVED_COIN) {\n                Log.add(World.strings[$F_VOTIVE_A]);\n                this.removeItem($I_ENGRAVED_COIN);\n                object.id = $F_VOTIVE_B;\n                object.finished = true;\n                this.sp -= 4;\n                Screen.smudge = 14;\n                World.strings[$R_CLOSET][1] = World.strings[$R_CLOSET_A][1];\n                World.objectsById($H_WORDS, object => {\n                    object.type = TYPE_EXAMINE_ONLY;\n                    object.char = '\\x91';\n                });\n            } else {\n                Log.add(`%y%0 That doesn't work here.`);\n            }\n        }\n\n        hasItem(id) {\n            return this.inventory.includes(id);\n        }\n\n        obtainItem(id) {\n            this.inventory.push(id);\n        }\n\n        removeItem(id) {\n            this.inventory = this.inventory.filter(objectId => objectId !== id);\n        }\n\n        openDoor(object, stringId) {\n            if (stringId) {\n                Log.add(World.strings[stringId]);\n            } else {\n                Log.add('You push the door open.', '%y');\n            }\n            object.open = object.finished = true;\n            object.char = object.char === '|' ? `'` : '\\x7f';\n        }\n\n        // *COMBAT*\n        /*\n        attack(entity) {\n            let roll = CombatSystem.rollAttack(this.vigor, this.weapon.ar);\n            if (roll.result === CombatSystem.WHIFF) {\n                Log.add('%YYou slash at the swamp rat, but miss.');\n            } else if (roll.result === CombatSystem.HIT) {\n                Log.add(`%YYou slash the ${CombatSystem.formatActeeName(entity)}, dealing ${roll.value} damage.`);\n            } else if (roll.result === CombatSystem.CRIT) {\n                Log.add(`%YFocus! You slash the ${CombatSystem.formatActeeName(entity)}, dealing ${roll.value} damage.`);\n            }\n            Game.entities.push(new WorldParticle(entity.pos, [['/', Screen.YELLOW], ['*', Screen.YELLOW]]));\n            Game.entities.push(new WorldParticle(Game.player.pos, [['@', Screen.YELLOW]]));\n        }\n\n        updateStats() {\n            this.lvl = this.vigor + this.insight + this.will;\n\n            let hpMax = this.vigor * 10 + this.lvl - 10;\n\n            if (hpMax > this.hpMax) {\n                this.hpMax = hpMax;\n                this.hp += (hpMax - this.hpMax);\n            }\n\n            let spMax = this.will * 10 + this.lvl - 30;\n\n            if (spMax > this.spMax) {\n                this.spMax = spMax;\n                this.sp += (spMax - this.spMax);\n            }\n        }\n        */\n    }\n\n    // TurnSystem\n\n    const TurnSystem = {\n        takeEntityTurns() {\n            const entities = [...Game.entities];\n\n            if (!Game.player.tp) Game.player.tp = 0;\n\n            if (Game.player.tp >= Game.player.speed) {\n                // All entities are \"paused\" until the player takes a turn.\n                let turnTaken = Game.player.update();\n\n                if (turnTaken) {\n                    Game.player.tp -= Game.player.speed;\n                }\n\n                // Entities with no speed are frame-based instead of turn-based. (For\n                // example, most spawned particles, which are also entities.)\n                /*for (let entity of entities) {\n                    if (!entity.speed) entity.update();\n                }*/\n            } else {\n                for (let entity of entities) {\n                    entity.tp = (entity.tp || 0) + 1;\n\n                    /*while (entity.tp >= entity.speed && entity !== Game.player) {\n                        entity.update();\n                        entity.tp -= entity.speed;\n                    }*/\n                }\n            }\n\n            //console.log(Game.entities.map(x => x.tp));\n        }\n    };\n\n    // Viewport\n\n    /**\n     * Viewport is a global object representing the playable pixel area of our game.\n     */\n    const Viewport = {\n        init() {\n            Viewport.canvas = document.getElementById('canvas');\n            Viewport.ctx = Viewport.canvas.getContext('2d');\n            Viewport.resize(true);\n        },\n\n        // Resize the canvas to give us approximately our desired game display size.\n        //\n        // Rather than attempt to explain it, here's a concrete example:\n        //\n        //     we start with a desired game dimension:   480x270px\n        //          get the actual browser dimensions:  1309x468px\n        //          factor in the display's DPI ratio:  2618x936px\n        //         now calculate the horizontal scale:       5.45x\n        //                     and the vertical scale:       3.46x\n        //            our new offical game scaling is:        5.4x\n        //       and our official viewport dimensions:   484x173px\n        //\n        // This approach emphasizes correct aspect ratio and maintains full-window rendering, at\n        // the potential cost of limiting visibility of the game itself in either the X or Y axis.\n        // If you use this approach, make sure your GUI can \"float\" (otherwise there may be whole\n        // UI elements the player cannot see!).\n        resize(force) {\n            let dpi = window.devicePixelRatio,\n                width = Viewport.canvas.clientWidth,\n                height = Viewport.canvas.clientHeight,\n                dpiWidth = width * dpi,\n                dpiHeight = height * dpi;\n\n            if (force || Viewport.canvas.width !== dpiWidth || Viewport.canvas.height !== dpiHeight) {\n                Viewport.canvas.width = dpiWidth;\n                Viewport.canvas.height = dpiHeight;\n\n                Viewport.scale = ((Math.min(dpiWidth / GAME_WIDTH, dpiHeight / GAME_HEIGHT) * 10) | 0) / 10;\n                Viewport.width = Math.ceil(dpiWidth / Viewport.scale);\n                Viewport.height = Math.ceil(dpiHeight / Viewport.scale);\n                Viewport.center = {\n                    u: (Viewport.width / 2) | 0,\n                    v: (Viewport.height / 2) | 0\n                };\n                Viewport.clientWidth = width;\n                Viewport.clientHeight = height;\n\n                // Note: smoothing flag gets reset on every resize by some browsers, which is why\n                // we do it here.\n                Viewport.ctx.imageSmoothingEnabled = false;\n            }\n\n            // We do this every frame, not just on resize, due to browser sometimes \"forgetting\".\n            Viewport.canvas.style.cursor = 'not-allowed';\n        }\n    };\n\n    // WelcomeScreen\n\n    class WelcomeScreen {\n        constructor() {\n            Screen.smudge = 26;\n        }\n\n        update() {\n            // Weird hack here because AudioContext constructor eats up a frame\n            // about half the time... I should fix it properly but this hack\n            // works for now.\n            if (Input.pressed[Input.Action.SELECT] || Input.enterPressed) {\n                this.closing = true;\n            }\n\n            if (this.closing) {\n                this.cull = true;\n                setTimeout(() => {\n                    Screen.smudge = 5;\n                }, 500);\n            }\n        }\n\n        draw() {\n            let welcome = `                     %gSHADOW OF THE KEENING STAR\n\n%wFor some reason, you just couldn't ignore that letter. It was wrong,\nsomehow - although estranged, you remember your uncle, and he never\nwrote like that.\n\nSo here you are, an hour southeast of Boston, still clutching your\nuncle's letter and standing in front of a weather-beaten colonial.\n\nThe creak of the front door echoes in your ears as you step into the\nhouse...\n\n%d[ENTER] Begin`;\n\n            /*welcome = welcome.split('').map(c => {\n                let code = c.charCodeAt(0);\n                if (c === 'g' || c === 'w' || c === 'd') return c;\n                if (code >= 48 && code <= 122) return String.fromCharCode(code + this.shift);\n                return c;\n            }).join('');*/\n\n            Screen.clear();\n            Screen.writeBox(4, 4, 72, 15, Screen.GREEN);\n            Screen.write(6, 5, welcome);\n        }\n    }\n\n    // Game\n\n    const Game = {\n        async init() {\n            // Initialize game components\n            await Font.init();\n            Viewport.init();\n            Screen.init();\n            Text.init();\n            Input.init();\n            World.init();\n            Log.init();\n\n            // Initial state values\n            this.frame = 0;\n            this.entities = [];\n\n            this.player = new Player(xyz2pos(...World.spawn));\n            this.entities.push(this.player);\n\n            this.screens = [new WelcomeScreen()];\n\n            Camera.init();\n\n            // Kick off game loop\n            window.requestAnimationFrame(() => this.onFrame());\n        },\n\n        onFrame() {\n            let now = new Date().getTime();\n            let lastFrame = this.lastFrame || 0;\n\n            // Note: `requestAnimationFrame` will usually call our handler 60 times per second,\n            // but it can be higher or lower (lower if the game is lagging, higher if the user's\n            // refresh settings are modified -- it can be 120Hz for example).\n            //\n            // It's safest to explicitly limit the number of frame updates to 60 per second.\n            if (now - lastFrame >= 1000 / FPS) {\n                this.frame++;\n                this.update();\n                this.lastFrame = now;\n\n                Viewport.resize();\n                this.draw();\n            }\n\n            window.requestAnimationFrame(() => this.onFrame());\n\n            //Triggers.arm('TRAT1');\n        },\n\n        update() {\n            Input.update();\n\n            if (this.screens.length > 0) {\n                this.screens[this.screens.length - 1].update();\n                this.screens = this.screens.filter(screen => !screen.cull);\n            } else if (Input.pressed[Input.Action.LOG]) {\n                this.screens.push(new LogScreen());\n            } else if (Input.pressed[Input.Action.HELP]) {\n                this.screens.push(new HelpScreen());\n            } else if (Input.pressed[Input.Action.INVENTORY]) {\n                this.screens.push(new InventoryScreen());\n            } else {\n                TurnSystem.takeEntityTurns();\n            }\n\n            Camera.update();\n\n            //Triggers.update();\n\n            // Discard any entites marked for culling at the end of the update step. They will not\n            // be drawn this frame (so, setting \"cull\" should happen AFTER the last frame of a given\n            // enemy or particle has been drawn).\n            Game.entities = Game.entities.filter(entity => !entity.cull);\n\n            if (Screen.smudge > 0) Screen.smudge--;\n        },\n\n        draw() {\n            // Reset canvas transform and scale\n            Viewport.ctx.setTransform(Viewport.scale, 0, 0, Viewport.scale, 0, 0);\n\n            // Clear canvas\n            Viewport.ctx.fillStyle = '#121212';\n            Viewport.ctx.fillRect(0, 0, Viewport.width, Viewport.height);\n\n            // Center our ASCII \"screen\" in the viewport\n            Viewport.ctx.translate((Viewport.width - GAME_WIDTH) / 2 | 0, (Viewport.height - GAME_HEIGHT) / 2 | 0);\n\n            Screen.clear();\n\n            //Screen.write(3, 3, 'hello world');\n\n            //Screen.write(0, 0, '/--------------------------------------\\\\');\n            //Screen.write(2, 10, 'You are standing in a cramped drawing room.');\n\n            //Screen.write(0, 0, '#');\n            //Screen.write(79, 0, '#');\n            //Screen.write(0, 23, '#');\n            //Screen.write(79, 23, '#');\n\n            for (let i = 0; i < 20; i++) {\n                Screen.write(64, i, '\\x90', Screen.DIM);\n            }\n\n            //Screen.write(0, 19, '\\x91'.repeat(80));\n\n            Screen.write(66, 1, `Health ${formatQuantity(Game.player.hp, Game.player.hpMax)}`);\n            Screen.write(66, 2, `Sanity ${formatQuantity(Game.player.sp, Game.player.spMax)}`);\n\n            //Screen.write(66, 4, `Vigor   ${formatStat(Game.player.vigor)}`);\n            //Screen.write(66, 5, `Insight ${formatStat(Game.player.insight)}`);\n            //Screen.write(66, 6, `Will    ${formatStat(Game.player.will)}`);\n            //Screen.write(66, 7, `Speed   ${formatStat(Game.player.speed)}`);\n\n    /*\n            Screen.write(0, 19, '#'.repeat(60));\n            Screen.write(0, 20, 'Here is something.');\n            Screen.write(0, 21, 'Here is something.');\n            Screen.write(3, 22, 'Here is some kind of something.');\n            Screen.write(4, 21, '#'.repeat(60));\n            Screen.write(5, 18, '#'.repeat(60));\n    */\n            World.draw();\n\n            // A simplistic 3-layer z-order system. We can always be more advanced\n            // and actually sort by z later!\n            /*for (let entity of this.entities) {\n                if (entity.z < 0) entity.draw();\n            }\n            for (let entity of this.entities) {\n                if (!entity.z) entity.draw();\n            }\n            for (let entity of this.entities) {\n                if (entity.z > 0) entity.draw();\n            }*/\n            //for (let entity of this.entities) entity.draw();\n            Game.player.draw();\n\n            Screen.write(66, 18, '[H] Help', Screen.DIM);\n            Log.draw(3);\n\n            for (let screen of this.screens) {\n                screen.draw();\n            }\n\n            Screen.draw(Viewport.ctx);\n        },\n\n        entityAt(pos) {\n            return this.entities.find(entity => {\n                let found = (entity.pos.x === pos.x) && (entity.pos.y === pos.y) && (entity.pos.z === pos.z);\n                return found;\n            });\n        },\n    };\n\n    // index\n\n    Game.init();\n\n}());\n//# sourceMappingURL=app.js.map\n","// Camera\n//\n// For now this is a very simple placeholder. Even if the camera never does\n// anything but follow the player, distinguishing between \"where the player is\"\n// and \"what the map camera is looking at\" is useful in other files.\n\nimport { Game } from './Game';\n\nexport const Camera = {\n    init() {\n        this.pos = { x: 0, y: 0, z: 0 };\n    },\n\n    update() {\n        this.pos = Game.player.pos;\n    }\n};\n","// Font\n//\n// This file is generated by `gulp buildAssets`.\n\nexport const Font = {\n    async init() {\n        await new Promise(resolve => {\n            let image = new Image();\n            image.onload = resolve;\n            image.src = Font.data.uri;\n            Font.img = image;\n        });\n    },\n    data:\n/* <generated> */\n{ uri:\n   'data:image/png;base64,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' }\n/* </generated> */\n};\n","// Original: https://github.com/codyebberson/pico8-music\n//\n// This is a slightly modified version. Eventually we'll work on a more\n// integrated audio player but for now I've just hacked it up (with\n// Cody's blessing).\n\nconst FX_NO_EFFECT = 0;\nconst FX_SLIDE = 1;\nconst FX_VIBRATO = 2;\nconst FX_DROP = 3;\nconst FX_FADE_IN = 4;\nconst FX_FADE_OUT = 5;\nconst FX_ARP_FAST = 6;\nconst FX_ARP_SLOW = 7;\nconst SAMPLE_RATE = 44100;\nconst BASE_SPEED = 120;\n\n/**\n * Creates a new PICO-8 AudioCart using the \"sfx\" and \"music\" data from\n * a cartridge file.\n * @param {string} sfx\n * @param {string} music\n * @param {object} options\n */\nexport function AudioCart({ sfx, music }, options = {}) {\n  // Note: some browsers don't allow creation of an AudioContext unless you're inside\n  // a user-triggered event, like a mouse click or keypress. One way to control this\n  // is to initialize the AudioCart from a user-triggered event.\n  //\n  // (If you have multiple AudioCarts, you can choose to share an AudioContext by\n  // creating it yourself and passing it into each AudioCart in the options section.)\n  const audioCtx = options.audioCtx || new AudioContext();\n\n  // Each \"line\" of sfx and music represents one of the 64 allowed patterns in PICO-8.\n  // Note that sfx data contains a lot of \"nybbles\" (a single hex character, i.e., 4\n  // bits out of an 8-bit byte), which means the obvious improvement of breaking up\n  // each byte into integers isn't quite that simple.\n  //\n  // For now, the sfx and music data is processed \"as hex\" inline while we build up\n  // the audio samples.\n  let sfxData = sfx.split('\\n');\n  let musicData = music.split('\\n');\n\n  /**\n   * Previous brown noise.\n   * Need to track this to trim frequency ranges.\n   * See the noise oscillator.\n   * @type {number}\n   */\n  let prevNoise = 0;\n\n  /**\n   * Parses a hex substring into a decimal number.\n   * @param {string} str\n   * @param {number} start\n   * @param {number} len\n   * @return {number}\n   * @noinline\n   */\n  const parseHex = (str, start, len) => parseInt(str.substr(start, len), 16);\n\n  /**\n   * Rounds a number.\n   * This compresses better than Math.round.\n   * Google Closure Compiler inlines the calls.\n   * @param {number} x Input number.\n   * @return {number} Output number.\n   */\n  const round = (x) => (x + 0.5) | 0;\n\n  /**\n   * Triangle oscillator.\n   * @param {number} t\n   * @return {number}\n   */\n  const triangleOscillator = (t) => Math.abs(2 * t - 1) - 1.0;\n\n  /**\n   * Tilted saw oscillator.\n   * @param {number} t\n   * @return {number}\n   */\n  const tiltedSawOscillator = (t) => {\n    const a = 0.9;\n    const ret = t < a ? 2.0 * t / a - 1.0 : 2.0 * (1.0 - t) / (1.0 - a) - 1.0;\n    return ret * 0.5;\n  };\n\n  /**\n   * Saw oscillator.\n   * 0->1 ramp\n   * @param {number} t\n   * @return {number}\n   */\n  const sawOscillator = (t) => 0.6 * (t < 0.5 ? t : t - 1.0);\n\n  /**\n   * Square oscillator.\n   * 50% duty cycle square wave\n   * @param {number} t\n   * @return {number}\n   */\n  const squareOscillator = (t) => t < 0.5 ? 0.5 : -0.5;\n\n  /**\n   * Pulse oscillator.\n   * 20% duty cycle square wave\n   * @param {number} t\n   * @return {number}\n   */\n  const pulseOscillator = (t) => t < 0.3 ? 0.5 : -0.5;\n\n  /**\n   * Organ oscillator.\n   * tri-uneven: 100% tri 75% tri on loop\n   * @param {number} t\n   * @return {number}\n   */\n  const organOscillator = (t) => (\n    t < 0.5 ?\n      3.0 - Math.abs(24.0 * t - 6.0) :\n      1.0 - Math.abs(16.0 * t - 12.0)\n  ) / 9.0;\n\n  /**\n   * Noise oscillator.\n   * @return {number}\n   */\n  const noiseOscillator = () => {\n    const white = Math.random() * 2 - 1;\n    const brown = (prevNoise + (0.02 * white)) / 1.02;\n    prevNoise = brown;\n    return brown * 10; // (roughly) compensate for gain\n  };\n\n  /**\n   * Phaser oscillator.\n   * @param {number} t\n   * @param {number} value\n   * @return {number}\n   */\n  const phaserOscillator = (t, value) => {\n    // This one has a subfrequency of freq/128 that appears\n    // to modulate two signals using a triangle wave\n    const k = Math.abs(2.0 * ((value / 128.0) % 1.0) - 1.0);\n    const u = (t + 0.5 * k) % 1.0;\n    const ret = Math.abs(4.0 * u - 2.0) - Math.abs(8.0 * t - 4.0);\n    return ret / 6.0;\n  };\n\n  /**\n   * Oscillators.\n   * Order and indices are important!\n   * @const {!Array.<function(number=, number=): number>}\n   */\n  const oscillators = [\n    triangleOscillator,\n    tiltedSawOscillator,\n    sawOscillator,\n    squareOscillator,\n    pulseOscillator,\n    organOscillator,\n    noiseOscillator,\n    phaserOscillator,\n  ];\n\n  /**\n   * Returns note frequency from pitch index (0-63).\n   * From C-0 to D#-5 in chromatic scale.\n   * @param {number} pitch\n   * @return {number}\n   */\n  const getFreq = (pitch) => 65 * 2 ** (pitch / 12);\n\n  /**\n   * Cache of pre-built sounds.\n   * Key is `${sfxIndex}-${pitchOffset}\n   * Value is a Float32Array.\n   * @const {!Object}\n   */\n  const soundCache = {};\n\n  /**\n   * Builds the sound from scratch.\n   * @param {!Array.<string>} sfxData\n   * @param {number} sfxIndex\n   * @param {number} pitchOffset\n   * @return {!Float32Array}\n   */\n  const buildSound = (sfxData, sfxIndex, pitchOffset) => {\n    const sfxRow = sfxData[sfxIndex];\n    const noteLength = parseHex(sfxRow, 2, 2) / BASE_SPEED;\n    const loopStart = parseHex(sfxRow, 4, 2);\n    const loopEnd = parseHex(sfxRow, 6, 2) || 32;\n    const length = loopEnd * SAMPLE_RATE;\n    const data = new Float32Array(length);\n\n    /**\n     * Returns the next note index.\n     * Handles loop start/end.\n     * @param {number} i The current note index.\n     * @return {number} The next note index.\n     */\n    const getNextIndex = (i) => i + 1 >= loopEnd ? loopStart : i + 1;\n\n    /**\n     * Returns a data element from the sfx row.\n     * @param {number} index The note index. (0-32).\n     * @param {number} offset The element offset (0-4).\n     * @param {number} len The length in hex characters.\n     * @return {number} The sfx value.\n     */\n    const getSfx = (index, offset, len) => parseHex(sfxRow, 8 + index * 5 + offset, len);\n\n    let offset = 0;\n    let phi = 0;\n    let i = 0;\n\n    let prevNote = 24;\n    let prevFreq = getFreq(24);\n    let prevWaveform = -1;\n    let prevVolume = -1;\n    let prevEffect = -1;\n\n    let currNote;\n    let currFreq;\n    let currWaveform;\n    let currVolume;\n    let currEffect;\n\n    while (offset < length) {\n      currNote = getSfx(i, 0, 2) + pitchOffset;\n      currFreq = getFreq(currNote);\n      currWaveform = getSfx(i, 2, 1);\n      currVolume = getSfx(i, 3, 1) / 8.0;\n      currEffect = getSfx(i, 4, 1);\n\n      const next = getNextIndex(i);\n      const nextNote = getSfx(next, 0, 2) + pitchOffset;\n      const nextWaveform = getSfx(next, 2, 1);\n      const nextVolume = getSfx(next, 3, 1);\n      const nextEffect = getSfx(next, 4, 1);\n\n      let attack = 0.02;\n      if (currEffect === FX_FADE_IN ||\n        (currWaveform === prevWaveform &&\n          (currNote === prevNote || currEffect === FX_SLIDE) &&\n          prevVolume > 0 &&\n          prevEffect !== FX_FADE_OUT)) {\n        attack = 0;\n      }\n      let release = 0.05;\n      if (currEffect === FX_FADE_OUT ||\n        (currWaveform === nextWaveform &&\n          (currNote === nextNote || nextEffect === FX_SLIDE) &&\n          nextVolume > 0 &&\n          nextEffect !== FX_FADE_IN)) {\n        release = 0;\n      }\n\n      const samples = round(noteLength * SAMPLE_RATE);\n      const customInstrument = currWaveform > 7 && getSound(sfxData, currWaveform - 8, pitchOffset + currNote - 24);\n      let k = 0;\n      for (let j = offset; j < offset + samples; j++) {\n        // Note factor is the percentage of completion of the note\n        // 0.0 is the beginning\n        // 1.0 is the end\n        const noteFactor = (j - offset) / samples;\n\n        let envelope = 1.0;\n        if (noteFactor < attack) {\n          envelope = noteFactor / attack;\n        } else if (noteFactor > (1.0 - release)) {\n          envelope = (1.0 - noteFactor) / release;\n        }\n\n        let freq = currFreq;\n        let volume = currVolume;\n\n        if (currEffect === FX_SLIDE) {\n          freq = (1 - noteFactor) * prevFreq + noteFactor * currFreq;\n          if (prevVolume > 0) {\n            volume = (1 - noteFactor) * prevVolume + noteFactor * currVolume;\n          }\n        }\n        if (currEffect === FX_VIBRATO) {\n          freq *= 1.0 + 0.02 * Math.sin(7.5 * noteFactor);\n        }\n        if (currEffect === FX_DROP) {\n          freq *= 1.0 - noteFactor;\n        }\n        if (currEffect === FX_FADE_IN) {\n          volume *= noteFactor;\n        }\n        if (currEffect === FX_FADE_OUT) {\n          volume *= 1.0 - noteFactor;\n        }\n        if (currEffect >= FX_ARP_FAST) {\n          // From the documentation:\n          //   6 arpeggio fast  //  Iterate over groups of 4 notes at speed of 4\n          //   7 arpeggio slow  //  Iterate over groups of 4 notes at speed of 8\n          //   If the SFX speed is <= 8, arpeggio speeds are halved to 2, 4\n          // const m = (speed <= 8 ? 32 : 16) / (effect === FX_ARP_FAST ? 4 : 8);\n          // const n = (int)(m * 7.5 * offset / offsetPerSecond);\n          // const arp_note = (note_id & ~3) | (n & 3);\n          // freq = key_to_freq(sfx.notes[arp_note].key);\n          freq = currFreq;\n        }\n\n        phi += freq / SAMPLE_RATE;\n        if (currWaveform < 8) {\n          data[j] += volume * envelope * oscillators[currWaveform](phi % 1, phi);\n        } else {\n          data[j] += volume * envelope * customInstrument[k];\n          k = (k + 1) % customInstrument.length;\n        }\n      }\n\n      offset += samples;\n      prevNote = currNote;\n      prevFreq = currFreq;\n      prevWaveform = currWaveform;\n      prevVolume = currVolume;\n      prevEffect = currEffect;\n      i = getNextIndex(i);\n    }\n    return data;\n  };\n\n  /**\n   * Returns a sound buffer.\n   * Uses a cached buffer if available.\n   * Otherwise builds the sound from scratch.\n   * @param {!Array.<string>} sfxData\n   * @param {number} sfxIndex\n   * @param {number} pitchOffset\n   * @return {!Float32Array}\n   */\n  const getSound = (sfxData, sfxIndex, pitchOffset) => {\n    const key = sfxIndex + '-' + pitchOffset;\n    let sound = soundCache[key];\n    if (!sound) {\n      sound = buildSound(sfxData, sfxIndex, pitchOffset);\n      soundCache[key] = sound;\n    }\n    return sound;\n  };\n\n  /**\n   * @param {!Array.<string>} sfxData\n   * @param {!Float32Array} data\n   * @param {number} offset\n   * @param {number} endOffset\n   * @param {number} sfxIndex\n   * @param {number=} pitchOffset\n   */\n  const buildMusic = (sfxData, data, offset, endOffset, sfxIndex, pitchOffset = 0) => {\n    const sfxBuffer = getSound(sfxData, sfxIndex, pitchOffset);\n    let i = 0;\n    while (offset < endOffset) {\n      data[offset] += sfxBuffer[i];\n      i = (i + 1) % sfxBuffer.length;\n      offset++;\n    }\n  };\n\n  /**\n   * Builds a song and returns an audio buffer that can be used to play it.\n   * You should connect up your own audio destination before starting.\n   * @param {number=} startPattern\n   * @return {!AudioBufferSourceNode}\n   */\n  const createMusic = (startPattern = 0) => {\n    // Preprocess loop\n    // Need to do 4 things on this loop:\n    // 1) Find the \"time\" channels\n    //    Channels can run at different speeds, and therefore have different lengths\n    //    The length of a pattern is defined by the first non-looping channel\n    //    See: https://www.lexaloffle.com/bbs/?pid=12781\n    // 2) Calculate the pattern lengths\n    //    After we know the time channel, we can convert that into number of samples\n    // 3) Find the loop start time (if one exists)\n    //    Find the pattern with the \"start loop\" flag set\n    //    Otherwise default to beginning of the song\n    // 4) Find the end pattern and total song length\n    //    Find the pattern with the \"end loop\" flag set\n    //    Otherwise default to end of the song\n    const timeChannels = [];\n    const patternSamples = [];\n    let loopStart = 0;\n    let songLength = 0;\n    let endPattern = musicData.length - 1;\n    for (let pattern = startPattern; pattern <= endPattern; pattern++) {\n      const musicRow = musicData[pattern];\n      const flags = parseHex(musicRow, 0, 2);\n\n      timeChannels[pattern] = 0;\n      for (let channel = 0; channel < 4; channel++) {\n        const sfxIndex = parseHex(musicRow, 3 + channel * 2, 2);\n        if (sfxIndex < sfxData.length) {\n          const sfxRow = sfxData[sfxIndex];\n          const loopEnd = parseHex(sfxRow, 6, 2);\n          if (loopEnd === 0) {\n            timeChannels[pattern] = channel;\n            break;\n          }\n        }\n      }\n\n      const sfxIndex = parseHex(musicRow, 3 + timeChannels[pattern] * 2, 2);\n      const sfxRow = sfxData[sfxIndex];\n      const noteLength = parseHex(sfxRow, 2, 2) / BASE_SPEED;\n      patternSamples[pattern] = round(32 * noteLength * SAMPLE_RATE);\n\n      if ((flags & 1) === 1) {\n        loopStart = songLength;\n      }\n\n      songLength += 32 * noteLength;\n\n      if ((flags & 2) === 2) {\n        endPattern = pattern;\n        break;\n      }\n    }\n\n    // Now we have everything we need to build the song\n    const frameCount = SAMPLE_RATE * songLength;\n    const audioBuffer = audioCtx.createBuffer(1, frameCount, SAMPLE_RATE);\n    const data = audioBuffer.getChannelData(0);\n\n    // Main music generator loop\n    let offset = 0;\n    for (let pattern = startPattern; pattern <= endPattern; pattern++) {\n      const musicRow = musicData[pattern];\n      const samples = patternSamples[pattern];\n      for (let channel = 0; channel < 4; channel++) {\n        const sfxIndex = parseHex(musicRow, 3 + channel * 2, 2);\n        if (sfxIndex < sfxData.length) {\n          buildMusic(sfxData, data, offset, offset + samples, sfxIndex);\n        }\n      }\n      offset += samples;\n    }\n\n    const source = audioCtx.createBufferSource();\n    source.buffer = audioBuffer;\n    source.loop = true;\n    source.loopStart = loopStart;\n    return source;\n  };\n\n  /**\n   * Builds a song and immediately plays it.\n   * @param {number=} startPattern\n   * @return {!AudioBufferSourceNode}\n   */\n  const playMusic = (startPattern = 0) => {\n    const source = createMusic(startPattern);\n    source.connect(audioCtx.destination);\n    source.start();\n    return source;\n  };\n\n  this.music = createMusic;\n  this.playMusic = playMusic;\n};\n","// audio.p8\nexport const AudioData = { music: '00 01424144\\n00 01444144\\n00 01024147\\n00 01024344\\n00 01024344\\n00 00024344\\n01 01020544\\n00 01020444\\n00 01020544\\n00 00020344\\n00 01020544\\n00 01020444\\n00 01020544\\n00 00020344\\n00 41024344\\n02 41024344', sfx: '011600000f5250f4150f2130f7250f5150f7350f4150f5150f6250f4150f513147250f515157350f4150f7150f5250f4150f5130f7250f5150f7350f4150f5150f6250f4150f2130f7250f515107350f4150f715\\n011600000c5250c4150c5150c7250c5150c7350c4150c5150c6250c4150c5150d7250c5150d7350c4150c7150c5250c4150c5150c7250c5150c7350c4150c5150c6250c4150c5150c7250c5150d7350c4150c715\\n011600000c073000000c043000000c023000000c003000000c073000000c053000000c033000000c013306000c073000000c043000000c023000000c003306000c073000000c053000000c033000000c01330600\\n01160000157500300015730030001571003000030000300014750030001574003000147300300014710030000c70000000000000000000000000000000000000107300300010740147001075015700107600f760\\n011600000c7500c7500f7520000011750117501375012700127501255212750007000d750000000c750000000c740000000c730000000c720000000c710000000000000000000000000000000000000000000000\\n011600000c7500c7500f7520000011750117501375012700127501250212740007001173000000127100000000000000000000000000000000000000000000000000000000000000000000000000000000000000' };","// Audio\n\n//import { AudioCart } from 'pico8-audio-player';\n//import { AudioCart } from '../../temp-pico8-music';\nimport { AudioCart } from './pico8-audio-player';\nimport { AudioData } from './AudioData-gen';\n\nexport const Audio = {\n    init() {\n        if (this.initialized) return;\n\n        // Note: unlike most init() methods, this is called from the first\n        // user-triggered event (like a keypress), not the main game loop. This\n        // avoids warnings in browsers about being unable to create an AudioContext.\n        this.initialized = true;\n\n        const AC = window.AudioContext || window.webkitAudioContext;\n        this.audioCtx = new AC();\n\n        setTimeout(() => {\n            this.globalGain = this.audioCtx.createGain(this.audioCtx, { gain: 0 });\n            this.globalGain.connect(this.audioCtx.destination);\n            this.unmute(3);\n\n            this.cart = new AudioCart(AudioData, { audioCtx: this.audioCtx });\n\n            this.music = this.cart.music();\n            this.music.connect(this.globalGain);\n            this.music.start();\n        }, 1);\n    },\n\n    mute(seconds = 1) {\n        this.globalGain.gain.linearRampToValueAtTime(0, this.audioCtx.currentTime + seconds);\n    },\n\n    unmute(seconds = 1) {\n        this.globalGain.gain.linearRampToValueAtTime(1, this.audioCtx.currentTime + seconds);\n    }\n\n    // If I supported sound effects, I'd list them here.\n    // Due to lack of space, not yet implemented :)\n    //\n    /*playStuff() {\n        let sfx = this.cart.sfx(2);\n        sfx.connect(this.globalGain);\n        sfx.start();\n    }\n    */\n};\n","// Input\n\nimport { Audio } from './Audio';\n\nexport const Input = {\n    Action: {\n        UP:        11,\n        DOWN:      12,\n        LEFT:      13,\n        RIGHT:     14,\n        CAST:      15,\n        SELECT:    25,\n        INVENTORY: 26,\n        LOG:       27,\n        HELP:      28,\n        BACK:      29\n    },\n\n    init() {\n        // Key action up/down state\n        this.keyboard = {};\n\n        // \"Pressed\" means an input was pressed THIS FRAME.\n        this.pressed = {};\n\n        // \"Released\" means an input was released THIS FRAME.\n        this.released = {};\n\n        // \"Held\" means an input is held down. The input was \"Pressed\" either\n        // this frame or in a past frame, and has not been \"Released\" yet.\n        this.held = {};\n\n        // How many frames was this input held down by the player. If [held]\n        // is false, it represents how long the input was last held down.\n        this.framesHeld = {};\n\n        this.keyMapping = {\n            ArrowUp: Input.Action.UP,\n            ArrowLeft: Input.Action.LEFT,\n            ArrowDown: Input.Action.DOWN,\n            ArrowRight: Input.Action.RIGHT,\n            KeyC: Input.Action.CAST,\n            KeyL: Input.Action.LOG,\n            KeyH: Input.Action.HELP,\n            KeyI: Input.Action.INVENTORY,\n            Enter: Input.Action.SELECT,\n            Escape: Input.Action.BACK\n        };\n\n        window.addEventListener('keydown', event => {\n            let action = this.keyMapping[event.code];\n            if (action) {\n                this.keyboard[action] = true;\n\n                if (action === Input.Action.SELECT) {\n                    Audio.init();\n                    Input.enterPressed = true;\n                }\n            }\n        });\n\n        window.addEventListener('keyup', event => {\n            let action = this.keyMapping[event.code];\n            if (action) {\n                this.keyboard[action] = false;\n            }\n        });\n    },\n\n    update() {\n        for (let action of Object.values(Input.Action)) {\n            let held = this.keyboard[action];\n\n            this.pressed[action] = !this.held[action] && held;\n            this.released[action] = this.held[action] && !held;\n\n            if (this.pressed[action]) {\n                this.framesHeld[action] = 1;\n            } else if (this.held[action] && held) {\n                this.framesHeld[action]++;\n            }\n\n            this.held[action] = held;\n        }\n    }\n};\n","// WorldData\n//\n// This file is generated by `gulp buildAssets`.\n\n/* <generated-constants> */\nexport const $D_CLOSET = 1;\nexport const $D_CLOSET_OPEN = 2;\nexport const $D_DINING = 3;\nexport const $D_DINING_OPEN = 4;\nexport const $D_DRAW = 5;\nexport const $D_FOYER = 6;\nexport const $D_GARAGE = 7;\nexport const $D_GARAGED = 8;\nexport const $D_HALLWAY = 9;\nexport const $D_KITCHEN = 10;\nexport const $D_STUDY = 11;\nexport const $F_ALTAR = 12;\nexport const $F_ALTAR_A = 13;\nexport const $F_BURNT_CHAIR = 14;\nexport const $F_BURNT_CHAIR_A = 15;\nexport const $F_CHAIR1 = 16;\nexport const $F_DOLLHOUSE = 17;\nexport const $F_DOLLHOUSE_A = 18;\nexport const $F_DOLLHOUSE_B = 19;\nexport const $F_DOLLHOUSE_C = 20;\nexport const $F_DOLLHOUSE_D = 21;\nexport const $F_DOLLHOUSE_E = 22;\nexport const $F_DOLLHOUSE_F = 23;\nexport const $F_DRAWER1 = 24;\nexport const $F_DRAWER1_A = 25;\nexport const $F_GRAFFITI = 26;\nexport const $F_PAINTING1 = 27;\nexport const $F_PAINTING2 = 28;\nexport const $F_SHELF1 = 29;\nexport const $F_SHELF2 = 30;\nexport const $F_SHELF3 = 31;\nexport const $F_SHELF3_A = 32;\nexport const $F_SHELF4 = 33;\nexport const $F_STAIR1 = 34;\nexport const $F_STATUE = 35;\nexport const $F_STATUE_A = 36;\nexport const $F_STATUE_B = 37;\nexport const $F_TABLE = 38;\nexport const $F_VOTIVE = 39;\nexport const $F_VOTIVE_A = 40;\nexport const $F_VOTIVE_B = 41;\nexport const $H_DIG = 42;\nexport const $H_DIG_A = 43;\nexport const $H_STATUE2 = 44;\nexport const $H_STATUE2_A = 45;\nexport const $H_STATUE2_B = 46;\nexport const $H_WORDS = 47;\nexport const $H_WORKBENCH = 48;\nexport const $H_WORKBENCH_A = 49;\nexport const $I_BURNT_NOTEBOOK = 74;\nexport const $I_DOLL_SCULPTURE = 76;\nexport const $I_DOLL_WORKBENCH = 75;\nexport const $I_ENGRAVED_COIN = 78;\nexport const $I_IRON_KNIFE = 71;\nexport const $I_SCREWDRIVER = 77;\nexport const $I_SILVER_KEY = 72;\nexport const $I_UNCLE_LETTER = 73;\nexport const $R_CLOSET = 58;\nexport const $R_CLOSET_A = 59;\nexport const $R_DINING = 60;\nexport const $R_DRAW = 61;\nexport const $R_FOYER = 62;\nexport const $R_GARAGE = 63;\nexport const $R_GARAGE_A = 64;\nexport const $R_HALLWAY = 65;\n/* </generated-constants> */\n\nexport const WorldData =\n/* <generated-data> */\n{\n    \"floors\": [\n        {\n            \"name\": \"1F\",\n            \"tiles\": [\n                [\n                    32,\n                    32,\n                    32,\n                    129,\n                    129,\n                    129,\n                    129,\n                    129,\n                    129,\n                    129,\n                    134,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32\n                ],\n                [\n                    32,\n                    32,\n                    32,\n                    128,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    137,\n                    129,\n                    129,\n                    45,\n                    129,\n                    129,\n                    129,\n                    129,\n                    129,\n                    135,\n                    129,\n                    134,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32\n                ],\n                [\n                    32,\n                    32,\n                    32,\n                    128,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    124,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    93,\n                    128,\n                    168,\n                    128,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32\n                ],\n                [\n                    32,\n                    32,\n                    32,\n                    128,\n                    46,\n                    46,\n                    166,\n                    46,\n                    46,\n                    168,\n                    137,\n                    129,\n                    45,\n                    129,\n                    129,\n                    135,\n                    45,\n                    129,\n                    129,\n                    131,\n                    46,\n                    132,\n                    129,\n                    129,\n                    134,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32\n                ],\n                [\n                    32,\n                    32,\n                    32,\n                    129,\n                    129,\n                    129,\n                    129,\n                    129,\n                    129,\n                    129,\n                    138,\n                    46,\n                    46,\n                    46,\n                    46,\n                    128,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    167,\n                    137,\n                    129,\n                    129,\n                    129,\n                    45,\n                    129,\n                    129,\n                    138,\n                    32\n                ],\n                [\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    144,\n                    46,\n                    35,\n                    37,\n                    46,\n                    137,\n                    129,\n                    135,\n                    129,\n                    129,\n                    129,\n                    129,\n                    129,\n                    129,\n                    138,\n                    61,\n                    61,\n                    46,\n                    46,\n                    46,\n                    61,\n                    128,\n                    32\n                ],\n                [\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    133,\n                    131,\n                    46,\n                    37,\n                    35,\n                    46,\n                    128,\n                    60,\n                    132,\n                    46,\n                    46,\n                    46,\n                    46,\n                    35,\n                    46,\n                    128,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    132,\n                    134\n                ],\n                [\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    128,\n                    46,\n                    46,\n                    35,\n                    37,\n                    46,\n                    128,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    124,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    38,\n                    128\n                ],\n                [\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    132,\n                    134,\n                    46,\n                    46,\n                    46,\n                    46,\n                    124,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    128,\n                    91,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    133,\n                    131\n                ],\n                [\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    132,\n                    129,\n                    129,\n                    129,\n                    129,\n                    138,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    137,\n                    129,\n                    129,\n                    145,\n                    145,\n                    145,\n                    129,\n                    131,\n                    32\n                ],\n                [\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    132,\n                    129,\n                    129,\n                    129,\n                    45,\n                    129,\n                    129,\n                    145,\n                    129,\n                    131,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32\n                ]\n            ],\n            \"rooms\": [\n                [\n                    63,\n                    3,\n                    0,\n                    8,\n                    5\n                ],\n                [\n                    61,\n                    25,\n                    4,\n                    8,\n                    6\n                ],\n                [\n                    60,\n                    10,\n                    3,\n                    6,\n                    7\n                ],\n                [\n                    65,\n                    10,\n                    1,\n                    10,\n                    3\n                ],\n                [\n                    62,\n                    15,\n                    5,\n                    10,\n                    6\n                ],\n                [\n                    61,\n                    24,\n                    4,\n                    4,\n                    2\n                ],\n                [\n                    60,\n                    9,\n                    6,\n                    2,\n                    3\n                ],\n                [\n                    58,\n                    15,\n                    3,\n                    10,\n                    2\n                ],\n                [\n                    58,\n                    19,\n                    1,\n                    3,\n                    3\n                ]\n            ],\n            \"objects\": [\n                [\n                    5,\n                    24,\n                    7\n                ],\n                [\n                    9,\n                    12,\n                    3,\n                    2\n                ],\n                [\n                    3,\n                    15,\n                    8,\n                    2\n                ],\n                [\n                    17,\n                    22,\n                    6\n                ],\n                [\n                    7,\n                    10,\n                    2,\n                    2\n                ],\n                [\n                    10,\n                    13,\n                    1,\n                    2\n                ],\n                [\n                    29,\n                    6,\n                    3,\n                    4\n                ],\n                [\n                    6,\n                    19,\n                    10,\n                    2\n                ],\n                [\n                    34,\n                    16,\n                    6,\n                    4\n                ],\n                [\n                    35,\n                    31,\n                    7\n                ],\n                [\n                    14,\n                    18,\n                    2\n                ],\n                [\n                    30,\n                    25,\n                    5,\n                    4\n                ],\n                [\n                    31,\n                    26,\n                    5\n                ],\n                [\n                    8,\n                    3,\n                    3\n                ],\n                [\n                    8,\n                    3,\n                    2\n                ],\n                [\n                    8,\n                    3,\n                    1\n                ],\n                [\n                    24,\n                    9,\n                    3\n                ],\n                [\n                    48,\n                    7,\n                    3,\n                    3\n                ],\n                [\n                    48,\n                    8,\n                    3,\n                    3\n                ],\n                [\n                    26,\n                    27,\n                    9\n                ],\n                [\n                    26,\n                    28,\n                    9\n                ],\n                [\n                    26,\n                    29,\n                    9\n                ],\n                [\n                    16,\n                    25,\n                    8,\n                    4\n                ],\n                [\n                    33,\n                    30,\n                    5,\n                    4\n                ],\n                [\n                    44,\n                    10,\n                    7,\n                    3\n                ],\n                [\n                    1,\n                    16,\n                    3,\n                    2\n                ],\n                [\n                    12,\n                    23,\n                    4\n                ],\n                [\n                    27,\n                    22,\n                    10,\n                    4\n                ],\n                [\n                    11,\n                    28,\n                    4,\n                    2\n                ],\n                [\n                    38,\n                    13,\n                    7\n                ],\n                [\n                    38,\n                    12,\n                    5\n                ],\n                [\n                    38,\n                    13,\n                    6\n                ],\n                [\n                    38,\n                    12,\n                    7\n                ],\n                [\n                    38,\n                    12,\n                    6\n                ],\n                [\n                    38,\n                    13,\n                    5\n                ],\n                [\n                    39,\n                    20,\n                    2\n                ],\n                [\n                    47,\n                    18,\n                    3,\n                    3\n                ],\n                [\n                    42,\n                    20,\n                    8,\n                    3\n                ],\n                [\n                    28,\n                    10,\n                    5,\n                    4\n                ]\n            ],\n            \"triggers\": [],\n            \"id\": 0\n        }\n    ],\n    \"bounds\": [\n        [\n            0,\n            0\n        ],\n        [\n            33,\n            11\n        ]\n    ],\n    \"spawn\": [\n        19,\n        8,\n        0\n    ],\n    \"strings\": [\n        0,\n        \"The door is barred by a metal plate, held in place by a series of screws.\\nYou could open it with the right tool.\",\n        \"You unscrew several screws and the metal plate clatters to the floor.\\n%y%0 You push the door open.\",\n        \"The lock is broken and the door won't budge. With the right tool, you can\\nprobably pry it open.\",\n        \"You wedge the knife between the door and frame. With a little effort, you\\nforce the broken lock away from the strike plate.\\n%y%0 You push the door open.\",\n        0,\n        \"The front door has jammed behind you and won't budge.\",\n        0,\n        \"The garage door is heavy and immobile. In the center of the door is\\na spray-painted eye, surrounded by rings of tiny symbols. It's hard\\nto breathe in this room, it's too small somehow.\",\n        0,\n        \"It seems to be locked from the other side.\",\n        \"It seems to be locked from the other side.\",\n        \"A makeshift altar rests against the back wall. Tiny animal bones and black\\nfeathers hang from every corner and crevice.\\nA miniature sculpture sits in the middle of the altar.\",\n        \"A makeshift altar rests against the back wall. Tiny animal bones and black\\nfeathers hang from every corner and crevice.\",\n        \"The charred remnants of a rocking chair.\\nA half-burnt notebook is resting on the melted seat cushion.\",\n        \"The charred remnants of a rocking chair.\",\n        \"This chair is covered in mildew, but otherwise uninteresting.\",\n        \"A vintage dollhouse. Normally you could open it up and take a look inside,\\nbut it's been locked with a small silver padlock.\",\n        \"You carefully unlock the padlock and swing the dollhouse open. Eerily, it\\nseems to be a miniature version of the house you stand in. Even the\\nfurniture is in the same locations.\",\n        \"The open dollhouse watches you impatiently.\",\n        \"The miniature workbench fits perfectly into a space in the garage. The\\ndollhouse accepts your gift eagerly.\",\n        \"The miniature sculpture fits perfectly into an alcove in the dining\\nroom. You feel your bond with the dollhouse deepen.\",\n        \"The open dollhouse welcomes you, waiting patiently.\",\n        \"Gauging carefully, you line up your knife and plunge it into the floor\\nof the dollhouse. Wood and concrete scream with glee behind you as\\nthe floor opens up.\",\n        \"A small dresser-drawer is sitting in the corner.\\nA small silver key is lying on top, attached to note.\",\n        \"A small dresser-drawer is sitting in the corner.\",\n        \"The wall is strangely spongy here, more like moss than wallpaper.\\nThe phrase %rHER CHILDREN %whas been spray-painted across the wall.\",\n        \"An oil painting hangs on the wall, out of place in this shabby room. It\\nseems to depict a planet being devoured by... something.\\nThe less you look at it, the better.\",\n        \"A painting used to hang here. %rAZATHOTH squirms, we will burst from\\n%rthis dimension like locusts on the old ones %whas been written\\nhere in thick red marker.\",\n        \"A rusty garage shelf.\",\n        \"The shelf is covered with dust, but not much else.\",\n        \"Someone has touched this shelf recently, the dust is noticeably absent.\\nA realistic miniature workbench rests on the shelf.\",\n        \"The shelf seems to have been recently used, most of the dust is wiped off.\",\n        \"The shelf is covered with dust, but not much else.\",\n        \"The stairs to the second floor are a wreck - you can't go up this way.\",\n        \"A crude, life-sized sculpture of a pregnant woman. One hand rests on her\\nbelly, and the other holds an iron knife.\\nThe sculpture's grip looks loose - perhaps you could take the knife.\",\n        \"With a tug, the sculpture releases the knife.\\n%y%0 You have obtained iron knife.\",\n        \"A crude, life-sized sculpture of a pregnant woman. One hand rests on her\\nbelly.\",\n        \"The dining room table is smashed to splinters. A black, sticky substance\\nthat smells like burning hair covers most of the table.\",\n        \"An armoire has been repurposed to hold dozens of votive candles. A message\\nis written on the back panel: %rSay her words%w.\\nYour spine tingles. You feel like you could recite something here.\",\n        \"Your voice echoes as you recite the words engraved on the coin.\\nYou shield your eyes as the candles burst into flame, the room lit bright\\nas day. Your mind is reeling, grasping for something it can't quite hold.\",\n        \"An old armoire holding dozens of burning votive candles. Her candles.\",\n        \"This is the spot, you can feel it under your feet. But your knife barely\\nmakes a dent in the old hardwood - there must be a better way.\",\n        \"This is the spot.\",\n        \"A life-sized sculpture of a woman. She holds in her arms a creature, all\\nlegs, heads, and arms, reaching upwards in celebration.\\nOne baby fist is clutching something round and shiny.\",\n        \"You reach carefully through the tangled limbs.\\n%y%0 You have obtained engraved coin.\",\n        \"A life-sized sculpture of a woman. She holds in her arms a creature, all\\nlegs, heads, and arms, reaching upwards in celebration.\",\n        \"Your goddess has left instructions on the wall for you. The old passages\\nare still alive under the entrance hallway. Your knife will do.\",\n        \"A sturdy wood and metal workbench, littered with debris.\\nLying amidst the junk and broken tools, you spot a screwdriver.\",\n        \"A sturdy wood and metal workbench, littered with debris.\",\n        0,\n        0,\n        0,\n        0,\n        0,\n        0,\n        0,\n        0,\n        [\n            \"SHRINE\",\n            \"This storage closet has been converted into some kind of shrine. The\\nunpainted wooden walls are carved with words, but none of them make\\nany sense to you.\"\n        ],\n        [\n            \"SHRINE\",\n            \"Her shrine. The walls are carved with instructions for her children.\"\n        ],\n        [\n            \"DINING ROOM\",\n            \"The dining room is somber and quiet. The walls are covered with\\nfaded squares where paintings used to hang.\"\n        ],\n        [\n            \"DRAWING ROOM\",\n            \"You are in a dimly lit drawing room filled with faded furniture.\\nThe room smells of musty upholstery.\"\n        ],\n        [\n            \"FOYER\",\n            \"You are in the foyer. The peeling paint and threadbare rugs seem even\\nolder than the outside of the house.\\nA dollhouse sits on a pedestal in the far corner of the room.\"\n        ],\n        [\n            \"GARAGE\",\n            \"The garage is empty, save for a few rusty shelves and the usual cobwebs.\\nThere must have been other furniture here recently, you can see lines\\nin the dust where a workbench used to be.\"\n        ],\n        [\n            \"GARAGE\",\n            \"The garage is empty, save for a few rusty shelves and the usual cobwebs.\\nThere is a sturdy workbench near the door.\"\n        ],\n        [\n            \"CHARRED HALLWAY\",\n            \"There must have been a fire at some point. Soot and grime coat the walls,\\nand the air stinks of burnt fabric.\"\n        ],\n        0,\n        0,\n        0,\n        0,\n        0,\n        [\n            \"iron knife\",\n            \"A large iron knife etched with\\ntiny symbols. It feels heavy\\nin your hand.\"\n        ],\n        [\n            \"small silver key\",\n            \"A small silver key. A note is\\nattached with a piece of twine.\\n\\n%r\\\"N is still here, stay on this\\n%r side.\\\"\"\n        ],\n        [\n            \"your uncle's letter\",\n            \"%r\\\"Dearest Emily,\\n\\n%r We are all in grave danger and\\n%r I am running out of time. I\\n%r cannot explain here but I need\\nyour help.\\\"\\n%w[The rest of the letter has been\\ncrossed out and is illegible.]\"\n        ],\n        [\n            \"half-burnt notebook\",\n            \"Most of the pages are too burnt\\nto read, but somehow one page\\nis crystal clear:\\n\\n%r\\\"Our Goddess walks the hills\\n%r in the shadow of the keening star\\n%r and we follow in her path\\\"\"\n        ],\n        [\n            \"miniature workbench\",\n            \"A curiously realistic miniature\\nworkbench, made of wood and metal.\\nMaybe there's some use for it.\"\n        ],\n        [\n            \"miniature sculpture\",\n            \"A miniature sculpture of a woman,\\nvery like the one you saw in\\nthe drawing room.\\nMaybe there's some use for it.\"\n        ],\n        [\n            \"screwdriver\",\n            \"A rusty, but still functional,\\ncrosshead screwdriver.\"\n        ],\n        [\n            \"engraved coin\",\n            \"An ancient coin engraved on both\\nsides with a short verse:\\n\\n%r\\\"Yidhra, Dream Witch,\\n%r I am your child.\\n%r Walk with me.\\\"\"\n        ]\n    ]\n}\n/* </generated-data> */\n;\n","// World\n\nimport { FLICKER_FRAME_1, STATUS_COL, TYPE_HIDDEN } from './Constants';\nimport { Game } from './Game';\nimport { Screen } from './Screen';\nimport { WorldData } from './WorldData-gen';\n\nexport const World = {\n    FLOOR: 46, // '.'\n\n    init() {\n        this.reset();\n        this.visions = [];\n    },\n\n    draw() {\n        if (Game.frame % FLICKER_FRAME_1 > 1) {\n            let tiles = this.floors[0].tiles;\n            for (let y = 0; y < tiles.length; y++) {\n                for (let x = 0; x < tiles[y].length; x++) {\n                    if (this.floors[0].visible[y][x]) {\n                        let object = this.objectAt({ x, y, z: 0 });\n                        if (object && object.type !== TYPE_HIDDEN) {\n                            Screen.writeOnMap(x, y, object.char, this.colorForObject(object));\n                        } else {\n                            let c = String.fromCharCode(tiles[y][x]);\n                            Screen.writeOnMap(x, y, c, this.colorForTile(c));\n                        }\n                    }\n                }\n            }\n        }\n\n        Screen.write(0, 0, ' '.repeat(STATUS_COL));\n        Screen.write(0, 1, ' '.repeat(STATUS_COL));\n        Screen.write(0, 2, ' '.repeat(STATUS_COL));\n\n        if (Game.player.room) {\n            let name = World.strings[Game.player.room.id][0];\n            Screen.write(Math.floor((STATUS_COL - name.length) / 2), 1, name, Screen.GREEN);\n        }\n\n        /*\n        if (Game.frame % 133 === 0) {\n            //console.log('generating visions');\n            this.visions = [];\n            for (let i = 0; i < 10; i++) {\n                this.visions.push([\n                    Math.floor(Math.random() * tiles[0].length),\n                    Math.floor(Math.random() * tiles.length),\n                    String.fromCharCode(97 + Math.floor(Math.random() * 26))\n                ]);\n            }\n        } else if (Game.frame % 133 >= 5 && Game.frame % 133 <= 25) {\n            for (let vision of this.visions) {\n                Screen.writeOnMap(vision[0], vision[1], vision[2], Screen.RED);\n            }\n        }\n        */\n    },\n\n    reset() {\n        // We want to be careful and CLONE (not reference) the world data, because\n        // this will be our \"working copy\" -- rooms and objects and even tiles might\n        // get updated and moved during game logic.\n        this.floors = WorldData.floors.map(floor => {\n            return {\n                tiles: floor.tiles.map(row => [...row]),\n                visible: floor.tiles.map(row => row.map(c => false)),\n                objects: floor.objects.map(object => ({ id: object[0], x: object[1], y: object[2], type: object[3] })),\n                rooms: floor.rooms.map(room => ({ id: room[0], x: room[1], y: room[2], width: room[3], height: room[4] })),\n                // *COMBAT*\n                //triggers: floor.triggers.map(trigger => ({ ...trigger }))\n            };\n        });\n        this.bounds = WorldData.bounds;\n        this.spawn = WorldData.spawn;\n        this.strings = WorldData.strings;\n\n        for (let floor of this.floors) {\n            // \"Lift\" all objects off the floor, and get their default character\n            for (let object of floor.objects) {\n                if (object.type !== TYPE_HIDDEN) {\n                    object.char = String.fromCharCode(floor.tiles[object.y][object.x]);\n                    floor.tiles[object.y][object.x] = World.FLOOR;\n                }\n            }\n        }\n    },\n\n    roomAt(pos) {\n        return this.floors[pos.z].rooms.find(room =>\n            pos.x >= room.x && pos.y >= room.y && pos.x < room.x + room.width && pos.y < room.y + room.height\n        );\n    },\n\n    objectAt(pos) {\n        return this.floors[pos.z].objects.find(object => object.x === pos.x && object.y === pos.y);\n    },\n\n    objectsById(id, map) {\n        let list = [];\n        for (let floor of this.floors) {\n            for (let object of floor.objects) {\n                if (object.id === id) {\n                    list.push(object);\n                    if (map) map(object);\n                }\n            }\n        }\n        return list;\n    },\n\n    roomsById(id, map) {\n        let list = [];\n        for (let floor of this.floors) {\n            for (let room of floor.rooms) {\n                if (room.id === id) {\n                    list.push(room);\n                    if (map) map(room);\n                }\n            }\n        }\n        return list;\n    },\n\n    tileAt(pos) {\n        let tiles = this.floors[pos.z].tiles;\n        if (pos.x < 0 || pos.y < 0 || pos.x >= tiles[0].length || pos.y >= tiles.length) return ' ';\n        return tiles[pos.y][pos.x];\n    },\n\n    canMoveInto(pos) {\n        let tile = this.tileAt(pos);\n        if (tile === 46 /* . */) return true;\n        return false;\n    },\n\n    colorForObject(object) {\n        if (object.finished) return Screen.DIM;\n        if (object.interacted) return Screen.YELLOW;\n        return Screen.BLUE;\n    },\n\n    colorForTile(tile) {\n        return tile === '.' ? Screen.DIM : Screen.WHITE;\n    },\n\n    makeVisible(roomId) {\n        for (let floor of this.floors) {\n            for (let room of floor.rooms) {\n                if (room.id === roomId) {\n                    for (let y = room.y; y < room.y + room.height; y++) {\n                        for (let x = room.x; x < room.x + room.width; x++) {\n                            floor.visible[y][x] = true;\n                        }\n                    }\n                }\n            }\n        }\n    },\n};\n","// Constants\n//\n// Where possible, global values are all kept here in spot for easy tweaking.\n// Don't worry about constant length -- our terser configuration in the build step\n// is going to mangle all of our constants into tiny variable names.\n\n// The \"screen area\", in ASCII characters.\nexport const SCREEN_WIDTH = 80;\nexport const SCREEN_HEIGHT = 24;\n\n// The size in pixels of each character in our monospaced font.\nexport const FONT_WIDTH = 8;\nexport const FONT_HEIGHT = 16;\n\n// The number of rows/columns of characters in the font sheet.\nexport const FONT_COLS = 16;\nexport const FONT_ROWS = 16;\n\n// Screen scaling -- currently not used.\nexport const SCREEN_SCALE = 1;\n\n// Playable area in pixels. Note that actual on-screen dimensions may differ to maintain\n// aspect ratio -- see `Viewport.width` & `Viewport.height`.\n//\n// We add a little bit of padding to make sure we don't draw a character right on top of\n// of the edge of the user's browser window.\nexport const GAME_WIDTH = (SCREEN_WIDTH + 1) * FONT_WIDTH * SCREEN_SCALE;\nexport const GAME_HEIGHT = (SCREEN_HEIGHT + 1) * FONT_HEIGHT * SCREEN_SCALE;\n\n// Global frames per second\nexport const FPS = 60;\n\n// How many frames does a turn take? This game is essentially turn-based (enemies don't\n// move unless the player moves). So this value really boils down to how fast the player\n// moves if they hold down an arrow key.\n//\n// 12 frames = 5 tiles per second.\nexport const TURN_FRAMES = 2;\n\n// The number of lines of recent history to show to the player, in the normal (closed)\n// case and the open (reviewing history) case.\nexport const LOG_CLOSED_LINES = 3;\nexport const LOG_OPEN_LINES = 15;\n\n// Horizontal column for the divider between map and status area.\nexport const STATUS_COL = 64;\n\n// Crit\nexport const COMBAT_WHIFF = 1;\nexport const COMBAT_HIT = 2;\nexport const COMBAT_CRIT = 3;\nexport const COMBAT_CRIT_MULTIPLIER = 1.5;\n\n// Object types\nexport const TYPE_DOOR = 2;\nexport const TYPE_HIDDEN = 3;\nexport const TYPE_EXAMINE_ONLY = 4;\n\n// Screen flickers\nexport const FLICKER_FRAME_1 = 169;\nexport const FLICKER_FRAME_2 = 221;\n","// Util\n//\n// Miscellaneous utility functions that don't fit anywhere else.\n\nimport { World } from './World';\n\nexport function rgba(r, g, b, a) {\n    return `rgba(${r},${g},${b},${a})`;\n}\n\nexport function xyz2pos(x, y, z) {\n    return { x, y, z };\n}\n\n// To avoid having this mapping, for now I just point directly at the location of\n// chars in my font sheet -- i.e. `\\x86` etc. But in a game with more room, I'd\n// definitely use this approach just to have fun in my source code.\n/*\nexport function uni(chars) {\n    // In our character sheet, chars 0x00-0x7F are standard ASCII, below that we put whatever\n    // characters are convenient for us. Here we can choose to map unicode characters to positions\n    // 0x80+ in the charsheet, making it easy for us to render things like special characters,\n    // box drawing characters, etc.\n    //\n    // Note that this technically isn't necessary; the font sheet might map 0x81 to \"wall corner\",\n    // for example, and in Tiled the value 0x81 will display that wall corner. But it's nice to\n    // be able to put _actual wall corners_ in strings inside your JavaScript code, and in your\n    // editor that character will be more like 0x251C. I could just type '\\x81' in code, but\n    // this convert lets me convert 0x251C to 0x81.\n    //\n    // If you choose to do this, don't forget to tell the browser your encoding in your <script> tag!\n    const SUPPORTED_UNICODE_CHARS = [\n        '',\n        '',\n        ''\n    ].join('');\n    const UNICODE_CHAR_MAP = SUPPORTED_UNICODE_CHARS.split('').reduce((map, char, idx) => {\n        map[char] = 0x80 + idx;\n        return map;\n    }, {});\n    return chars.split('').map(c => String.fromCharCode(UNICODE_CHAR_MAP[c]) || c).join('');\n}\n*/\n\n// *COMBAT*\n/*\nexport function flood(pos, maxDistance = Infinity) {\n    let result = World.floors.map(floor => array2d(World.bounds[1][0], World.bounds[1][1], () => Infinity));\n    let stack = [{ ...pos, cost: 0 }];\n\n    while (stack.length > 0) {\n        let { x, y, z, cost } = stack.shift();\n        if (result[z][y][x] <= cost) continue;\n        result[z][y][x] = cost++;\n        if (result[z][y][x] >= maxDistance) continue;\n        if (World.floors[z].tiles[y][x + 1] === World.FLOOR && result[z][y][x + 1] > cost)\n            stack.push({ x: x + 1, y, z, cost });\n        if (World.floors[z].tiles[y][x - 1] === World.FLOOR && result[z][y][x - 1] > cost)\n            stack.push({ x: x - 1, y, z, cost });\n        if (World.floors[z].tiles[y + 1][x] === World.FLOOR && result[z][y + 1][x] > cost)\n            stack.push({ x, y: y + 1, z, cost });\n        if (World.floors[z].tiles[y - 1][x] === World.FLOOR && result[z][y - 1][x] > cost)\n            stack.push({ x, y: y - 1, z, cost });\n    }\n\n    return result;\n}\n*/\n\nexport function array2d(width, height, fn) {\n    return Array.from({ length: height }, () => Array.from({ length: width }, fn));\n}\n\nexport function createCanvas(width, height) {\n    let canvas = document.createElement('canvas');\n    canvas.width = width;\n    canvas.height = height;\n    let ctx = canvas.getContext('2d');\n    return { canvas, ctx };\n}\n\n/*\nexport function formatStat(value) {\n    return ('' + value).padStart(2);\n}\n*/\n\nexport function formatQuantity(value, valueMax) {\n    return ('' + value).padStart(3, ' ') + '/' + valueMax;\n}\n","// Text\n//\n// Global object responsible for drawing text characters from our font sheet onto the\n// Viewport. This includes generating recolored versions of the characters, measuring/\n// wrapping long lines, etc.\n\nimport { FONT_WIDTH, FONT_HEIGHT } from './Constants';\nimport { Font } from './Font-gen';\nimport { rgba, createCanvas } from './Util';\n\nexport const Text = {\n    init() {\n        // We'll dynamically recolor the font sheet whenever a new rgba color is requested,\n        // then cache it for future use.\n        this.colorways = {};\n        this.colorways[''] = Font.img;\n\n        // The \"white\" font sheet, right from the sprite.\n        Text.white = Font.img;\n\n        // Recolored versions of the original font sheet, to use when constructing our glow.\n        //\n        // The color here is #33FF00 which is roughly the glow of the Kaypro II.\n        Text.terminal = recolor(Text.white, rgba(51 + 16, 255, 0 + 16, 1));\n        Text.terminal_shadow = recolor(Text.white, rgba(51, 255, 0, 0.4));\n    },\n\n    drawText(ctx, text, u, v, color = '') {\n        //console.log(text, color);\n        if (typeof text === 'number') text = String.fromCharCode(text);\n        let scale = 1;\n        let font = this.colorways[color];\n        if (!font) {\n            this.colorways[color] = font = recolor(Font.img, color);\n        }\n\n        if (Array.isArray(text)) {\n            for (let block of text) {\n                Text.drawText(ctx, block.text, u + block.u * scale, v + block.v * scale, font, scale);\n            }\n            return;\n        }\n\n        for (let idx = 0; idx < text.length; idx++) {\n            let c = text.charCodeAt(idx);\n            let k = (c - 0) * FONT_WIDTH;\n            let drawable = (c !== 32);\n\n            // We clear the canvas in every frame, and it's a HUGE speed advantage not to draw an\n            // empty image (this check can save 1000+ drawImage calls a frame).\n            if (drawable) {\n                ctx.drawImage(\n                    font,\n                    (k * scale) % font.width,\n                    Math.floor((k * scale) / (font.width)) * FONT_HEIGHT * scale,\n                    FONT_WIDTH * scale,\n                    FONT_HEIGHT * scale,\n                    u ,\n                    v,\n                    FONT_WIDTH * scale,\n                    FONT_HEIGHT * scale\n                );\n            }\n            u += FONT_WIDTH * scale;\n        }\n    },\n\n    /*\n    measureWidth(text, scale = 1) {\n        return text.split('').reduce((sum, c) => sum + FONT_WIDTH, 0) * scale;\n    },\n    */\n\n    /*\n    splitParagraph(text, w, h) {\n        let cu = 0, cv = 0;\n        let next = () => ({ text: '', u: cu, v: cv });\n        let wip = next();\n        let list = [];\n\n        for (let c of text.split('')) {\n            let cWidth = Text.measureWidth(c, 1);\n            if (c === '\\n' || cu + cWidth > w) {\n                let saved = '';\n                if (c !== '\\n' && c !== ' ') {\n                    let space = wip.text.split(' ');\n                    if (space.length > 1) {\n                        saved = space.pop();\n                        wip.text = space.join(' ');\n                    }\n                }\n                if (wip.text.length > 0) list.push(wip);\n                cu = 0;\n                cv += FONT_HEIGHT;\n                wip = next();\n                if (saved.length > 0) {\n                    wip.text = saved;\n                    cu += Text.measureWidth(wip.text, 1);\n                }\n            } else {\n                cu += cWidth;\n            }\n            if (c !== '\\n') {\n                wip.text = wip.text + c;\n            }\n        }\n\n        if (wip.text.length > 0) list.push(wip);\n\n        return list.map(line => ({\n            ...line,\n            w: Text.measureWidth(line.text, 1),\n            h: FONT_HEIGHT\n        }));\n    }\n    */\n};\n\n// Text utility functions, for manipulating the font sheet images\n\nfunction recolor(font, color) {\n    let canvas = createCanvas(font.width, font.height);\n    canvas.ctx.fillStyle = color;\n    canvas.ctx.fillRect(0, 0, font.width, font.height);\n    canvas.ctx.globalCompositeOperation = 'destination-in';\n    canvas.ctx.drawImage(font, 0, 0);\n\n    return canvas.canvas;\n}\n","/**\n * `Screen` is a singleton that represents the virtual 80x25 character screen our game\n * lives in. Components like PlayingField will \"draw\" (write text onto) this virtual\n * screen each frame. Once all the text is written, the text will end up rendered on\n * the viewport (canvas) in the browser.\n */\n\nimport { Camera } from './Camera';\nimport { SCREEN_WIDTH, SCREEN_HEIGHT, FONT_WIDTH, FONT_HEIGHT, FLICKER_FRAME_2 } from './Constants';\nimport { Game } from './Game';\nimport { Text } from './Text';\nimport { rgba } from './Util';\n\n/*\nconst SMUDGE_OFFSETS = [3,1,2,0,4,5,1,0,2,0];\nlet smudgeIndex = 0;\nconst smudgeOffset = () => {\n    smudgeIndex = (smudgeIndex + 1) % SMUDGE_OFFSETS.length;\n    return SMUDGE_OFFSETS[smudgeIndex];\n};\n*/\n\nexport const Screen = {\n    // Terminal color codes\n    DIM:     0x00,\n    RED:     0x01,\n    GREEN:   0x02,\n    YELLOW:  0x03,\n    BLUE:    0x04,\n    MAGENTA: 0x05,\n    CYAN:    0x06,\n    WHITE:   0x07,\n    BRIGHT:  0x08,\n\n    // Useful character codes\n    SPACE:   0x20,\n\n    init() {\n        this.screen = [];\n        this.smudge = 5;\n        this.clear();\n\n        // Terminal color names to hex color mappings\n        Screen.COLORS = {\n            [Screen.DIM]:                   rgba(144, 144, 144, 1),\n            [Screen.RED]:                   rgba(214, 69,  46,  1),\n            [Screen.GREEN]:                 rgba(151, 216, 122, 1),\n            [Screen.YELLOW]:                rgba(238, 212, 83,  1),\n            [Screen.BLUE]:                  rgba(70,  151, 226, 1),\n            [Screen.WHITE]:                 rgba(214, 214, 214, 1),\n            [Screen.WHITE | Screen.BRIGHT]: rgba(255, 255, 255, 1)\n        };\n    },\n\n    clear(startX = 0, startY = 0, width = SCREEN_WIDTH, height = SCREEN_HEIGHT) {\n        for (let y = startY; y < startY + height; y++) {\n            for (let x = startX; x < startX + width; x++) {\n                this.screen[y * SCREEN_WIDTH + x] = Screen.SPACE | (Screen.WHITE << 8);\n            }\n        }\n    },\n\n    write(x, y, text, color = Screen.WHITE, x2 = SCREEN_WIDTH) {\n        if (typeof text !== 'string') throw new Error('string');\n        //if (color === undefined) color = Screen.WHITE;\n\n        let ox = x, oy = y;\n\n        for (let i = 0; i < text.length; i++) {\n            let c = text.charCodeAt(i);\n\n            if (text[i] === '\\n') {\n                x = ox;\n                y++;\n                continue;\n            }\n\n            if (text[i] === '%') {\n                switch (text[++i]) {\n                    case 'd':\n                        color = Screen.DIM;\n                        continue;\n                    case 'r':\n                        color = Screen.RED;\n                        continue;\n                    case 'g':\n                        color = Screen.GREEN;\n                        continue;\n                    case 'b':\n                        color = Screen.BLUE;\n                        continue;\n                    case 'y':\n                        color = Screen.YELLOW;\n                        continue;\n                    case 'w':\n                        color = Screen.WHITE;\n                        continue;\n                    case 'W':\n                        color = Screen.WHITE | Screen.BRIGHT;\n                        continue;\n                    case '0':\n                        c = 0xa5;\n                        break;\n                    case '1':\n                        c = 0xa4;\n                        break;\n                    default:\n                        i--;\n                }\n            }\n\n            this.screen[y * SCREEN_WIDTH + x] = c | (color << 8);\n            x++;\n            if (x >= x2) {\n                x = ox;\n                y++;\n            }\n        }\n    },\n\n    writeOnMap(x, y, text, color, x2) {\n        let offset = {\n            x: 32 - Camera.pos.x,\n            y : 12 - Camera.pos.y\n        };\n\n        this.write(x + offset.x, y + offset.y, text, color, x2);\n    },\n\n    writeBox(x, y, w, h, color) {\n        if (w > 2 && h > 2) {\n            Screen.clear(x + 1, y + 1, w - 2, h - 2);\n        }\n        this.write(x, y, `\\x95${'\\x91'.repeat(w - 2)}\\x96`, color);\n        this.write(x, y + h - 1, `\\x94${'\\x91'.repeat(w - 2)}\\x93`, color);\n        for (let i = y + 1; i < y + h - 1; i++) {\n            this.write(x, i, '\\x90', color);\n            this.write(x + w - 1, i, '\\x90', color);\n        }\n    },\n\n    draw(ctx) {\n        if (Game.frame % FLICKER_FRAME_2 > 0) {\n            for (let y = 0; y < SCREEN_HEIGHT; y++) {\n                for (let x = 0; x < SCREEN_WIDTH; x++) {\n                    let c = this.screen[y * SCREEN_WIDTH + x];\n                    let c2 = (c & 0xFF);\n                    if (c2 !== 32 /*&& c2 < 128*/ && this.smudge > 0) c2 += this.smudge;\n                    Text.drawText(ctx, c2, x * FONT_WIDTH, y * FONT_HEIGHT, Screen.COLORS[c >> 8]);\n                }\n            }\n        }\n    }\n};\n","// Log\n\nimport { STATUS_COL } from './Constants';\nimport { Screen } from './Screen';\nimport { World } from './World';\n\nexport const Log = {\n    init() {\n        this.entries = [];\n    },\n\n    add(message, formatCode = '') {\n        //console.log(message);\n        if (message[0] !== '%') {\n            message = formatCode + '\\xa5 ' + message;\n        }\n\n        this.entries.push(message.split('\\n'));\n\n        // In a real game, you'd definitely want some kind of normalized line-splitting\n        // going on here... but for JS13k, I just have carefully crafted every string in\n        // world.yaml to fit into the appropriate spaces (either the log/description\n        // area, or the inventory description area).\n\n        // For a while, I was trying to do the whole\n        /*let array = [];\n\n        while (message.length > LOG_WIDTH) {\n            array.push(message.slice(0, LOG_WIDTH));\n            message = message.slice(LOG_WIDTH);\n        }\n        if (message.length > 0) array.push(message);\n        this.entries.push(array);*/\n    },\n\n    obtainedItem(id) {\n        Log.add(`%y%0 You have obtained ${World.strings[id][0]}.`);\n    },\n\n    draw(lines = 3) {\n        let boxHeight = lines + 2;\n        let boxStart = 22 - lines;\n        let temporaryBlanks = 0;\n\n        if (this.entries[this.entries.length - 1].length < 3)\n            temporaryBlanks = 3 - this.entries[this.entries.length - 1].length;\n        let display = this.entries.flat();\n        while (temporaryBlanks-- > 0) display.push('');\n        if (display.length > lines) {\n            display = display.slice(display.length - lines);\n        }\n\n        Screen.writeBox(0, boxStart, 80, boxHeight, Screen.DIM);\n        Screen.write(STATUS_COL, boxStart, '\\x98', Screen.DIM);\n\n        for (let i = 0; i < display.length; i++) {\n            Screen.write(2, boxStart + i + 1, display[i]);\n        }\n    }\n};\n","// LogScreen\n\nimport { LOG_CLOSED_LINES, LOG_OPEN_LINES, SCREEN_WIDTH, SCREEN_HEIGHT } from './Constants';\nimport { Input } from './Input';\nimport { Log } from './Log';\nimport { Screen } from './Screen';\n\nexport class LogScreen {\n    constructor() {\n        this.lines = LOG_CLOSED_LINES;\n        this.offset = 0;\n    }\n\n    update() {\n        if (Input.pressed[Input.Action.BACK] || Input.pressed[Input.Action.LOG]) {\n            this.closing = true;\n        }\n\n        if (this.closing) {\n            this.lines -= 2;\n            if (this.lines <= LOG_CLOSED_LINES) {\n                this.cull = true;\n                return;\n            }\n        } else {\n            if (this.lines < LOG_OPEN_LINES) this.lines += 2;\n\n            if (Input.pressed[Input.Action.UP]) {\n                this.offset++;\n            } else if (Input.pressed[Input.Action.DOWN]) {\n                this.offset--;\n            }\n        }\n\n        this.offset = Math.min(this.offset, 0);\n        this.offset = Math.max(this.offset, Log.entries.flat().length - this.lines);\n    }\n\n    draw() {\n        Screen.clear(0, SCREEN_HEIGHT - this.lines - 1, SCREEN_WIDTH, this.lines + 2);\n        Log.draw(this.lines, this.offset);\n    }\n}\n","// HelpScreen\n\nimport { LOG_CLOSED_LINES, LOG_OPEN_LINES, SCREEN_WIDTH, SCREEN_HEIGHT } from './Constants';\nimport { Input } from './Input';\nimport { Log } from './Log';\nimport { Screen } from './Screen';\n\nexport class HelpScreen {\n    constructor() {\n        this.expand = 2;\n    }\n\n    update() {\n        if (Input.pressed[Input.Action.BACK] || Input.pressed[Input.Action.HELP]) {\n            this.closing = true;\n        }\n\n        if (this.closing) {\n            this.expand -= 2;\n            if (this.expand === 2) {\n                this.cull = true;\n                return;\n            }\n        } else {\n            if (this.expand < 22) this.expand += 2;\n        }\n    }\n\n    draw() {\n        const help = `                                  %gHELP\n\n%gCONTROLS\n  %W\\xa0\\xa1\\xa2\\xa3    %wMove / Investigate / Attack\n  %WI       %wOpen inventory\n  %WL       %wExpand logbook\n  %WH       %wToggle help (this screen)\n\n%gMAP LEGEND\n  %W@       %wYou\n  %d.       %wEmpty floors\n  %w\\x80\\x81      %wWalls\n  %b|- %d'    %wDoors (%bclosed%w / %dopen%w)\n  %b< >     %wStairways (up / down)\n\n  %b&!      %wBlue objects can be investigated\n  %y%#      %wYellow objects may need to be revisited later\n  %d=$      %wGray objects have already been investigated\n\n  %rsfVH    %wRed letters are foes`;\n\n        Screen.writeBox(2, 12 - Math.floor(this.expand / 2), 76, this.expand, Screen.GREEN);\n        Screen.write(4, 13 - Math.floor(this.expand / 2), help.split('\\n').slice(0, this.expand).join('\\n'));\n    }\n}\n","// InventoryScreen\n//\n// The inventory screen has two modes -- if it's passed an object during construction\n// then it's actually the \"use inventory\" screen, if it's not, it's the \"examine\n// inventory\" screen.\n\nimport { LOG_CLOSED_LINES, LOG_OPEN_LINES, SCREEN_WIDTH, SCREEN_HEIGHT } from './Constants';\nimport { Game } from './Game';\nimport { Input } from './Input';\nimport { Log } from './Log';\nimport { Screen } from './Screen';\nimport { World } from './World';\n\nexport class InventoryScreen {\n    constructor(object) {\n        this.object = object;\n        this.expand = 2;\n        this.selected = 0;\n        this.list = Game.player.inventory;\n    }\n\n    update() {\n        if (Input.pressed[Input.Action.BACK]) {\n            this.closing = true;\n        } else if (Input.pressed[Input.Action.INVENTORY] && !this.object) {\n            this.closing = true;\n        } else if (Input.pressed[Input.Action.DOWN]) {\n            this.selected = (this.selected + 1) % this.list.length;\n        } else if (Input.pressed[Input.Action.UP]) {\n            this.selected = (this.selected + this.list.length - 1) % this.list.length;\n        } else if (Input.pressed[Input.Action.SELECT] && this.object) {\n            this.closing = true;\n            Game.player.useItemOn(this.object, this.list[this.selected]);\n        }\n\n        if (this.closing) {\n            this.cull = true;\n        }\n    }\n\n    draw() {\n        Screen.writeBox(5, 6, 71, 10, Screen.GREEN);\n        Screen.write(38, 6, '\\x97', Screen.GREEN);\n        Screen.write(38, 15, '\\x98', Screen.GREEN);\n        for (let y = 7; y < 15; y++) {\n            Screen.write(38, y, '\\x90', Screen.GREEN);\n        }\n\n        for (let idx = 0; idx < this.list.length; idx++) {\n            let [name, description] = World.strings[this.list[idx]];\n            if (idx === this.selected) {\n                Screen.write(6, 7 + idx, `%0${name.padEnd(30)}%1`, Screen.GREEN);\n                Screen.write(40, 7, description);\n            } else {\n                Screen.write(7, 7 + idx, name);\n            }\n        }\n        if (this.object) {\n            Screen.write(6, 14, '[\\xa0\\xa1\\xa2\\xa3ENTER] Use item  [ESC] Back', Screen.DIM);\n        } else {\n            Screen.write(6, 14, '[\\xa0\\xa1\\xa2\\xa3] Examine item   [ESC] Back', Screen.DIM);\n        }\n    }\n}\n","// GoodbyeScreen\n\nimport { Audio } from './Audio';\nimport { Screen } from './Screen';\n\nexport class GoodbyeScreen {\n    constructor() {\n        Screen.smudge = 7;\n        Audio.mute(12);\n    }\n\n    update() {\n    }\n\n    draw() {\n        let goodbye = `                     %gSHADOW OF THE KEENING STAR\n\n%wYour uncle forgotten for now, you scrabble into the newly-opened\nhole in the floor. Your mind is singing with a clarity you have\nnever felt before as you go to meet your Goddess for the first time.\n\nYou have a feeling this is only the beginning...\n\n\n\n\n                             %d(THE END)`;\n\n        Screen.clear();\n        Screen.writeBox(4, 4, 72, 15, Screen.GREEN);\n        Screen.write(6, 5, goodbye);\n    }\n}\n","// Player\n\nimport { Audio } from './Audio';\n//import { CombatSystem } from './CombatSystem';\nimport {\n    TURN_FRAMES,\n    TYPE_DOOR,\n    TYPE_HIDDEN,\n    TYPE_EXAMINE_ONLY\n} from './Constants';\nimport { Game } from './Game';\nimport { GoodbyeScreen } from './GoodbyeScreen';\nimport { Input } from './Input';\nimport { InventoryScreen } from './InventoryScreen';\nimport { Log } from './Log';\nimport { Screen } from './Screen';\nimport { World } from './World';\nimport {\n    $D_CLOSET,\n    $D_CLOSET_OPEN,\n    $D_DINING,\n    $D_DINING_OPEN,\n    $D_DRAW,\n    $D_FOYER,\n    $D_GARAGE,\n    $D_GARAGED,\n    $D_KITCHEN,\n    $D_HALLWAY,\n    $D_STUDY,\n    $F_ALTAR,\n    $F_ALTAR_A,\n    $F_BURNT_CHAIR,\n    $F_BURNT_CHAIR_A,\n    $F_DRAWER1,\n    $F_DRAWER1_A,\n    $F_DOLLHOUSE,\n    $F_DOLLHOUSE_A,\n    $F_DOLLHOUSE_B,\n    $F_DOLLHOUSE_C,\n    $F_DOLLHOUSE_D,\n    $F_DOLLHOUSE_E,\n    $F_DOLLHOUSE_F,\n    $F_GRAFFITI,\n    $F_SHELF3,\n    $F_SHELF3_A,\n    $F_STATUE,\n    $F_STATUE_A,\n    $F_STATUE_B,\n    $F_TABLE,\n    $F_VOTIVE,\n    $F_VOTIVE_A,\n    $F_VOTIVE_B,\n    $H_DIG,\n    $H_DIG_A,\n    $H_WORKBENCH,\n    $H_WORKBENCH_A,\n    $H_STATUE2,\n    $H_STATUE2_A,\n    $H_STATUE2_B,\n    $H_WORDS,\n    $I_BURNT_NOTEBOOK,\n    $I_DOLL_WORKBENCH,\n    $I_DOLL_SCULPTURE,\n    $I_ENGRAVED_COIN,\n    $I_IRON_KNIFE,\n    $I_SCREWDRIVER,\n    $I_SILVER_KEY,\n    $I_UNCLE_LETTER,\n    $R_CLOSET,\n    $R_CLOSET_A,\n    $R_DRAW,\n    $R_DINING,\n    $R_GARAGE,\n    $R_GARAGE_A,\n    $R_HALLWAY\n} from './WorldData-gen';\n//import { WorldParticle } from './WorldParticle';\n\nexport class Player {\n    constructor(pos) {\n        this.pos = { ...pos };\n\n        this.lookingAt = this.room;\n        this.inventory = [];\n\n        this.speed = 4;\n        this.hp = this.hpMax = 100;\n        this.sp = this.spMax = 100;\n\n        // *COMBAT*\n        // this.vigor = 8;\n        // this.insight = 12;\n        // this.will = 10;\n        // this.updateStats();\n        // this.weapon = { ar: 0.5 };\n        // this.df = flood(this.pos);\n\n        // The player starts with the uncle's letter.\n        this.obtainItem($I_UNCLE_LETTER);\n\n        // The foyer door is locked.\n        World.objectsById($D_FOYER, object => object.finished = true);\n\n        // The player is in the foyer (starting room).\n        this.room = World.roomAt(this.pos);\n        Log.add(World.strings[this.room.id][1]);\n        World.makeVisible(this.room.id);\n    }\n\n    draw() {\n        Screen.writeOnMap(this.pos.x, this.pos.y, '@', Screen.WHITE | Screen.BRIGHT);\n    }\n\n    update() {\n        let move;\n\n        if (Input.held[Input.Action.LEFT] && Input.framesHeld[Input.Action.LEFT] % TURN_FRAMES === 1) {\n            move = { ...this.pos, x: this.pos.x - 1 };\n        } else if (Input.held[Input.Action.RIGHT] && Input.framesHeld[Input.Action.RIGHT] % TURN_FRAMES === 1) {\n            move = { ...this.pos, x: this.pos.x + 1 };\n        } else if (Input.held[Input.Action.UP] && Input.framesHeld[Input.Action.UP] % TURN_FRAMES === 1) {\n            move = { ...this.pos, y: this.pos.y - 1 };\n        } else if (Input.held[Input.Action.DOWN] && Input.framesHeld[Input.Action.DOWN] % TURN_FRAMES === 1) {\n            move = { ...this.pos, y: this.pos.y + 1 };\n        }\n\n        if (move) {\n            this.interactWith(move);\n        }\n        return !!move;\n    }\n\n    interactWith(pos) {\n        let tile = World.tileAt(pos);\n        let object = World.objectAt(pos);\n        let entity = Game.entityAt(pos);\n\n        if (entity) {\n            // *COMBAT*\n            // this.attack(entity);\n        } else if (object && object.type !== TYPE_HIDDEN) {\n            if (object.open) {\n                this.moveInto(pos, false);\n            } else if (object.finished) {\n                this.lookingAt = object;\n                Log.add(World.strings[object.id]);\n            } else {\n                /**** SPECIAL OBJECTS ****/\n                if (object.id === $D_CLOSET) {\n                    Log.add(World.strings[object.id]);\n                    if (object.interacted) {\n                        this.openInventoryFor(object);\n                    }\n                } else if (object.id === $D_DINING) {\n                    Log.add(World.strings[object.id]);\n                    if (object.interacted) {\n                        this.openInventoryFor(object);\n                    }\n                } else if (object.id === $D_DRAW) {\n                    this.openDoor(object);\n                    World.makeVisible($R_DRAW);\n                } else if (object.id === $D_KITCHEN) {\n                    Log.add(World.strings[object.id]);\n                } else if (object.id === $D_GARAGE) {\n                    this.openDoor(object);\n                    World.makeVisible($R_GARAGE);\n                } else if (object.id === $D_GARAGED) {\n                    Log.add(World.strings[object.id]);\n                    this.sp -= 3;\n                    Screen.smudge = 4;\n                    World.objectsById($D_GARAGED, object => object.finished = true);\n                } else if (object.id === $D_HALLWAY) {\n                    this.openDoor(object);\n                    World.makeVisible($R_HALLWAY);\n                } else if (object.id === $D_STUDY) {\n                    Log.add(World.strings[object.id]);\n                } else if (object.id === $F_ALTAR) {\n                    Log.add(World.strings[object.id]);\n                    object.id = $F_ALTAR_A;\n                } else if (object.id === $F_ALTAR_A) {\n                    object.finished = true;\n                    Log.obtainedItem($I_DOLL_SCULPTURE);\n                    this.obtainItem($I_DOLL_SCULPTURE);\n                } else if (object.id === $F_BURNT_CHAIR) {\n                    Log.add(World.strings[object.id]);\n                    object.id = $F_BURNT_CHAIR_A;\n                } else if (object.id === $F_BURNT_CHAIR_A) {\n                    object.finished = true;\n                    Log.obtainedItem($I_BURNT_NOTEBOOK);\n                    this.obtainItem($I_BURNT_NOTEBOOK);\n                } else if (object.id === $F_DRAWER1) {\n                    Log.add(World.strings[object.id]);\n                    object.id = $F_DRAWER1_A;\n                } else if (object.id === $F_DRAWER1_A) {\n                    object.finished = true;\n                    Log.obtainedItem($I_SILVER_KEY);\n                    this.obtainItem($I_SILVER_KEY);\n                } else if (object.id === $F_DOLLHOUSE) {\n                    Log.add(World.strings[object.id]);\n                    if (object.interacted) {\n                        this.openInventoryFor(object);\n                    }\n                } else if (object.id === $F_DOLLHOUSE_B || object.id === $F_DOLLHOUSE_E) {\n                    Log.add(World.strings[object.id]);\n                    this.openInventoryFor(object);\n                } else if (object.id === $F_GRAFFITI) {\n                    Log.add(World.strings[object.id]);\n                    this.sp -= 3;\n                    Screen.smudge = 2;\n                    World.objectsById($F_GRAFFITI, object => object.finished = true);\n                } else if (object.id === $F_SHELF3) {\n                    Log.add(World.strings[object.id]);\n                    object.id = $F_SHELF3_A;\n                } else if (object.id === $F_SHELF3_A) {\n                    object.finished = true;\n                    Log.obtainedItem($I_DOLL_WORKBENCH);\n                    this.obtainItem($I_DOLL_WORKBENCH);\n                } else if (object.id === $F_STATUE) {\n                    Log.add(World.strings[object.id]);\n                    object.id = $F_STATUE_A;\n                } else if (object.id === $F_STATUE_A) {\n                    Log.add(World.strings[object.id]);\n                    object.id = $F_STATUE_B;\n                    object.finished = true;\n                    this.sp -= 2;\n                    this.obtainItem($I_IRON_KNIFE);\n                } else if (object.id === $F_TABLE) {\n                    Log.add(World.strings[object.id]);\n                    World.objectsById($F_TABLE, object => object.finished = true);\n                } else if (object.id === $H_STATUE2) {\n                    Log.add(World.strings[object.id]);\n                    object.id = $H_STATUE2_A;\n                } else if (object.id === $H_STATUE2_A) {\n                    Log.add(World.strings[object.id]);\n                    object.id = $H_STATUE2_B;\n                    object.finished = true;\n                    this.sp -= 3;\n                    this.obtainItem($I_ENGRAVED_COIN);\n                } else if (object.id === $F_VOTIVE) {\n                    Log.add(World.strings[object.id]);\n                    if (object.interacted) {\n                        this.openInventoryFor(object);\n                    }\n                } else if (object.id === $H_DIG) {\n                    Log.add(World.strings[object.id]);\n                } else if (object.id === $H_DIG_A) {\n                    // End the game!\n                    Game.screens.push(new GoodbyeScreen());\n                } else if (object.id === $H_WORDS) {\n                    Log.add(World.strings[object.id]);\n                    object.finished = true;\n                    World.objectsById($H_DIG, object => {\n                        object.type = 0;\n                        object.char = 'X';\n                    });\n                    World.objectsById($F_DOLLHOUSE_B, object => object.id = $F_DOLLHOUSE_E);\n                } else if (object.id === $H_WORKBENCH) {\n                    Log.add(World.strings[object.id]);\n                    World.objectsById($H_WORKBENCH, object => {\n                        object.id = $H_WORKBENCH_A;\n                        object.interacted = true;\n                    });\n                } else if (object.id === $H_WORKBENCH_A) {\n                    World.objectsById($H_WORKBENCH_A, object => {\n                        object.finished = true;\n                    });\n                    this.sp--;\n                    Log.obtainedItem($I_SCREWDRIVER);\n                    this.obtainItem($I_SCREWDRIVER);\n                } else if (object.type === TYPE_DOOR) {\n                    this.openDoor(object);\n                } else if (object.type === TYPE_EXAMINE_ONLY) {\n                    Log.add(World.strings[object.id]);\n                    object.finished = true;\n                    this.sp--;\n                } else {\n                    let action = '';\n                    if (object.action) {\n                        action = `\\n${object.action}`;\n                    } else if (object.interacted) {\n                        action = `\\n%y\\xa5 You need some kind of other item.`;\n                    }\n                    this.lookingAt = object;\n                    Log.add(World.strings[object.id] + action);\n                }\n            }\n\n            object.interacted = true;\n        } else if (tile === World.FLOOR) {\n            this.moveInto(pos, true);\n        } else {\n            // UNUSED\n        }\n    }\n\n    moveInto(pos, updateRoom) {\n        this.pos = pos;\n        //this.df = flood(this.pos);\n        if (updateRoom) {\n            // This is a cheap, easy way to make doors part of \"both rooms\" - when you step\n            // between rooms, the current room description doesn't update until you walk\n            // past the doorway.\n            let room = World.roomAt(this.pos);\n            if (this.room !== room) {\n                Log.add(World.strings[room.id][1]);\n            }\n            this.room = room;\n            this.lookingAt = this.room;\n        }\n    }\n\n    openInventoryFor(object) {\n        Game.screens.push(new InventoryScreen(object));\n    }\n\n    useItemOn(object, item) {\n        if (object.id === $D_CLOSET && item === $I_SCREWDRIVER) {\n            this.openDoor(object, $D_CLOSET_OPEN);\n            this.sp -= 3;\n            World.makeVisible($R_CLOSET);\n        } else if (object.id === $D_DINING && item === $I_IRON_KNIFE) {\n            this.openDoor(object, $D_DINING_OPEN);\n            World.makeVisible($R_DINING);\n        } else if (object.id === $F_DOLLHOUSE && item === $I_SILVER_KEY) {\n            Log.add(World.strings[$F_DOLLHOUSE_A]);\n            object.id = $F_DOLLHOUSE_B;\n            this.removeItem($I_SILVER_KEY);\n        } else if (object.id === $F_DOLLHOUSE_B && item === $I_DOLL_WORKBENCH) {\n            Log.add(World.strings[$F_DOLLHOUSE_C]);\n            this.removeItem($I_DOLL_WORKBENCH);\n            World.objectsById($H_WORKBENCH, object => {\n                object.type = 0;\n                object.char = '\\xa7';\n            });\n            World.strings[$R_GARAGE][1] = World.strings[$R_GARAGE_A][1];\n        } else if (object.id === $F_DOLLHOUSE_B && item === $I_DOLL_SCULPTURE) {\n            Log.add(World.strings[$F_DOLLHOUSE_D]);\n            this.removeItem($I_DOLL_SCULPTURE);\n            World.objectsById($H_STATUE2, object => {\n                object.type = 0;\n                object.char = '&';\n            });\n        } else if (object.id === $F_DOLLHOUSE_E && item === $I_IRON_KNIFE) {\n            Log.add(World.strings[$F_DOLLHOUSE_F]);\n            this.removeItem($I_IRON_KNIFE);\n            object.finished = true;\n            World.objectsById($H_DIG, object => {\n                object.id = $H_DIG_A;\n                object.char = '>';\n            });\n        } else if (object.id === $F_VOTIVE && item === $I_ENGRAVED_COIN) {\n            Log.add(World.strings[$F_VOTIVE_A]);\n            this.removeItem($I_ENGRAVED_COIN);\n            object.id = $F_VOTIVE_B;\n            object.finished = true;\n            this.sp -= 4;\n            Screen.smudge = 14;\n            World.strings[$R_CLOSET][1] = World.strings[$R_CLOSET_A][1];\n            World.objectsById($H_WORDS, object => {\n                object.type = TYPE_EXAMINE_ONLY;\n                object.char = '\\x91';\n            });\n        } else {\n            Log.add(`%y%0 That doesn't work here.`);\n        }\n    }\n\n    hasItem(id) {\n        return this.inventory.includes(id);\n    }\n\n    obtainItem(id) {\n        this.inventory.push(id);\n    }\n\n    removeItem(id) {\n        this.inventory = this.inventory.filter(objectId => objectId !== id);\n    }\n\n    openDoor(object, stringId) {\n        if (stringId) {\n            Log.add(World.strings[stringId]);\n        } else {\n            Log.add('You push the door open.', '%y');\n        }\n        object.open = object.finished = true;\n        object.char = object.char === '|' ? `'` : '\\x7f';\n    }\n\n    // *COMBAT*\n    /*\n    attack(entity) {\n        let roll = CombatSystem.rollAttack(this.vigor, this.weapon.ar);\n        if (roll.result === CombatSystem.WHIFF) {\n            Log.add('%YYou slash at the swamp rat, but miss.');\n        } else if (roll.result === CombatSystem.HIT) {\n            Log.add(`%YYou slash the ${CombatSystem.formatActeeName(entity)}, dealing ${roll.value} damage.`);\n        } else if (roll.result === CombatSystem.CRIT) {\n            Log.add(`%YFocus! You slash the ${CombatSystem.formatActeeName(entity)}, dealing ${roll.value} damage.`);\n        }\n        Game.entities.push(new WorldParticle(entity.pos, [['/', Screen.YELLOW], ['*', Screen.YELLOW]]));\n        Game.entities.push(new WorldParticle(Game.player.pos, [['@', Screen.YELLOW]]));\n    }\n\n    updateStats() {\n        this.lvl = this.vigor + this.insight + this.will;\n\n        let hpMax = this.vigor * 10 + this.lvl - 10;\n\n        if (hpMax > this.hpMax) {\n            this.hpMax = hpMax;\n            this.hp += (hpMax - this.hpMax);\n        }\n\n        let spMax = this.will * 10 + this.lvl - 30;\n\n        if (spMax > this.spMax) {\n            this.spMax = spMax;\n            this.sp += (spMax - this.spMax);\n        }\n    }\n    */\n}\n","// TurnSystem\n\nimport { Game } from './Game';\n\nexport const TurnSystem = {\n    takeEntityTurns() {\n        const entities = [...Game.entities];\n\n        if (!Game.player.tp) Game.player.tp = 0;\n\n        if (Game.player.tp >= Game.player.speed) {\n            // All entities are \"paused\" until the player takes a turn.\n            let turnTaken = Game.player.update();\n\n            if (turnTaken) {\n                Game.player.tp -= Game.player.speed;\n            }\n\n            // Entities with no speed are frame-based instead of turn-based. (For\n            // example, most spawned particles, which are also entities.)\n            /*for (let entity of entities) {\n                if (!entity.speed) entity.update();\n            }*/\n        } else {\n            for (let entity of entities) {\n                entity.tp = (entity.tp || 0) + 1;\n\n                /*while (entity.tp >= entity.speed && entity !== Game.player) {\n                    entity.update();\n                    entity.tp -= entity.speed;\n                }*/\n            }\n        }\n\n        //console.log(Game.entities.map(x => x.tp));\n    }\n};\n","// Viewport\n\nimport { GAME_WIDTH, GAME_HEIGHT } from './Constants';\n\n/**\n * Viewport is a global object representing the playable pixel area of our game.\n */\nexport const Viewport = {\n    init() {\n        Viewport.canvas = document.getElementById('canvas');\n        Viewport.ctx = Viewport.canvas.getContext('2d');\n        Viewport.resize(true);\n    },\n\n    // Resize the canvas to give us approximately our desired game display size.\n    //\n    // Rather than attempt to explain it, here's a concrete example:\n    //\n    //     we start with a desired game dimension:   480x270px\n    //          get the actual browser dimensions:  1309x468px\n    //          factor in the display's DPI ratio:  2618x936px\n    //         now calculate the horizontal scale:       5.45x\n    //                     and the vertical scale:       3.46x\n    //            our new offical game scaling is:        5.4x\n    //       and our official viewport dimensions:   484x173px\n    //\n    // This approach emphasizes correct aspect ratio and maintains full-window rendering, at\n    // the potential cost of limiting visibility of the game itself in either the X or Y axis.\n    // If you use this approach, make sure your GUI can \"float\" (otherwise there may be whole\n    // UI elements the player cannot see!).\n    resize(force) {\n        let dpi = window.devicePixelRatio,\n            width = Viewport.canvas.clientWidth,\n            height = Viewport.canvas.clientHeight,\n            dpiWidth = width * dpi,\n            dpiHeight = height * dpi;\n\n        if (force || Viewport.canvas.width !== dpiWidth || Viewport.canvas.height !== dpiHeight) {\n            Viewport.canvas.width = dpiWidth;\n            Viewport.canvas.height = dpiHeight;\n\n            Viewport.scale = ((Math.min(dpiWidth / GAME_WIDTH, dpiHeight / GAME_HEIGHT) * 10) | 0) / 10;\n            Viewport.width = Math.ceil(dpiWidth / Viewport.scale);\n            Viewport.height = Math.ceil(dpiHeight / Viewport.scale);\n            Viewport.center = {\n                u: (Viewport.width / 2) | 0,\n                v: (Viewport.height / 2) | 0\n            };\n            Viewport.clientWidth = width;\n            Viewport.clientHeight = height;\n\n            // Note: smoothing flag gets reset on every resize by some browsers, which is why\n            // we do it here.\n            Viewport.ctx.imageSmoothingEnabled = false;\n        }\n\n        // We do this every frame, not just on resize, due to browser sometimes \"forgetting\".\n        Viewport.canvas.style.cursor = 'not-allowed';\n    }\n};\n","// WelcomeScreen\n\nimport { Audio } from './Audio';\nimport { LOG_CLOSED_LINES, LOG_OPEN_LINES, SCREEN_WIDTH, SCREEN_HEIGHT } from './Constants';\nimport { Input } from './Input';\nimport { Log } from './Log';\nimport { Screen } from './Screen';\n\nexport class WelcomeScreen {\n    constructor() {\n        Screen.smudge = 26;\n    }\n\n    update() {\n        // Weird hack here because AudioContext constructor eats up a frame\n        // about half the time... I should fix it properly but this hack\n        // works for now.\n        if (Input.pressed[Input.Action.SELECT] || Input.enterPressed) {\n            this.closing = true;\n        }\n\n        if (this.closing) {\n            this.cull = true;\n            setTimeout(() => {\n                Screen.smudge = 5;\n            }, 500);\n        }\n    }\n\n    draw() {\n        let welcome = `                     %gSHADOW OF THE KEENING STAR\n\n%wFor some reason, you just couldn't ignore that letter. It was wrong,\nsomehow - although estranged, you remember your uncle, and he never\nwrote like that.\n\nSo here you are, an hour southeast of Boston, still clutching your\nuncle's letter and standing in front of a weather-beaten colonial.\n\nThe creak of the front door echoes in your ears as you step into the\nhouse...\n\n%d[ENTER] Begin`;\n\n        /*welcome = welcome.split('').map(c => {\n            let code = c.charCodeAt(0);\n            if (c === 'g' || c === 'w' || c === 'd') return c;\n            if (code >= 48 && code <= 122) return String.fromCharCode(code + this.shift);\n            return c;\n        }).join('');*/\n\n        Screen.clear();\n        Screen.writeBox(4, 4, 72, 15, Screen.GREEN);\n        Screen.write(6, 5, welcome);\n    }\n}\n","// Game\n//\n// A global object representing the state of the current game in progress. Game owns\n// the high-level game loop and orchestrates everything that happens each frame.\n\nimport { Camera } from './Camera';\nimport { FPS, GAME_WIDTH, GAME_HEIGHT } from './Constants';\nimport { Font } from './Font-gen';\nimport { Input } from './Input';\nimport { Log } from './Log';\nimport { LogScreen } from './LogScreen';\nimport { HelpScreen } from './HelpScreen';\nimport { InventoryScreen } from './InventoryScreen';\nimport { Player } from './Player';\nimport { Screen } from './Screen';\nimport { Text } from './Text';\n//import { Triggers } from './Triggers';\nimport { TurnSystem } from './TurnSystem';\nimport { Viewport } from './Viewport';\nimport { WelcomeScreen } from './WelcomeScreen';\nimport { World } from './World';\nimport { xyz2pos, formatQuantity } from './Util';\n\nexport const Game = {\n    async init() {\n        // Initialize game components\n        await Font.init();\n        Viewport.init();\n        Screen.init();\n        Text.init();\n        Input.init();\n        World.init();\n        Log.init();\n\n        // Initial state values\n        this.frame = 0;\n        this.entities = [];\n\n        this.player = new Player(xyz2pos(...World.spawn));\n        this.entities.push(this.player);\n\n        this.screens = [new WelcomeScreen()];\n\n        Camera.init();\n\n        // Kick off game loop\n        window.requestAnimationFrame(() => this.onFrame());\n    },\n\n    onFrame() {\n        let now = new Date().getTime();\n        let lastFrame = this.lastFrame || 0;\n\n        // Note: `requestAnimationFrame` will usually call our handler 60 times per second,\n        // but it can be higher or lower (lower if the game is lagging, higher if the user's\n        // refresh settings are modified -- it can be 120Hz for example).\n        //\n        // It's safest to explicitly limit the number of frame updates to 60 per second.\n        if (now - lastFrame >= 1000 / FPS) {\n            this.frame++;\n            this.update();\n            this.lastFrame = now;\n\n            Viewport.resize();\n            this.draw();\n        }\n\n        window.requestAnimationFrame(() => this.onFrame());\n\n        //Triggers.arm('TRAT1');\n    },\n\n    update() {\n        Input.update();\n\n        if (this.screens.length > 0) {\n            this.screens[this.screens.length - 1].update();\n            this.screens = this.screens.filter(screen => !screen.cull);\n        } else if (Input.pressed[Input.Action.LOG]) {\n            this.screens.push(new LogScreen());\n        } else if (Input.pressed[Input.Action.HELP]) {\n            this.screens.push(new HelpScreen());\n        } else if (Input.pressed[Input.Action.INVENTORY]) {\n            this.screens.push(new InventoryScreen());\n        } else {\n            TurnSystem.takeEntityTurns();\n        }\n\n        Camera.update();\n\n        //Triggers.update();\n\n        // Discard any entites marked for culling at the end of the update step. They will not\n        // be drawn this frame (so, setting \"cull\" should happen AFTER the last frame of a given\n        // enemy or particle has been drawn).\n        Game.entities = Game.entities.filter(entity => !entity.cull);\n\n        if (Screen.smudge > 0) Screen.smudge--;\n    },\n\n    draw() {\n        // Reset canvas transform and scale\n        Viewport.ctx.setTransform(Viewport.scale, 0, 0, Viewport.scale, 0, 0);\n\n        // Clear canvas\n        Viewport.ctx.fillStyle = '#121212';\n        Viewport.ctx.fillRect(0, 0, Viewport.width, Viewport.height);\n\n        // Center our ASCII \"screen\" in the viewport\n        Viewport.ctx.translate((Viewport.width - GAME_WIDTH) / 2 | 0, (Viewport.height - GAME_HEIGHT) / 2 | 0);\n\n        Screen.clear();\n\n        //Screen.write(3, 3, 'hello world');\n\n        //Screen.write(0, 0, '/--------------------------------------\\\\');\n        //Screen.write(2, 10, 'You are standing in a cramped drawing room.');\n\n        //Screen.write(0, 0, '#');\n        //Screen.write(79, 0, '#');\n        //Screen.write(0, 23, '#');\n        //Screen.write(79, 23, '#');\n\n        for (let i = 0; i < 20; i++) {\n            Screen.write(64, i, '\\x90', Screen.DIM);\n        }\n\n        //Screen.write(0, 19, '\\x91'.repeat(80));\n\n        Screen.write(66, 1, `Health ${formatQuantity(Game.player.hp, Game.player.hpMax)}`);\n        Screen.write(66, 2, `Sanity ${formatQuantity(Game.player.sp, Game.player.spMax)}`);\n\n        //Screen.write(66, 4, `Vigor   ${formatStat(Game.player.vigor)}`);\n        //Screen.write(66, 5, `Insight ${formatStat(Game.player.insight)}`);\n        //Screen.write(66, 6, `Will    ${formatStat(Game.player.will)}`);\n        //Screen.write(66, 7, `Speed   ${formatStat(Game.player.speed)}`);\n\n/*\n        Screen.write(0, 19, '#'.repeat(60));\n        Screen.write(0, 20, 'Here is something.');\n        Screen.write(0, 21, 'Here is something.');\n        Screen.write(3, 22, 'Here is some kind of something.');\n        Screen.write(4, 21, '#'.repeat(60));\n        Screen.write(5, 18, '#'.repeat(60));\n*/\n        World.draw();\n\n        // A simplistic 3-layer z-order system. We can always be more advanced\n        // and actually sort by z later!\n        /*for (let entity of this.entities) {\n            if (entity.z < 0) entity.draw();\n        }\n        for (let entity of this.entities) {\n            if (!entity.z) entity.draw();\n        }\n        for (let entity of this.entities) {\n            if (entity.z > 0) entity.draw();\n        }*/\n        //for (let entity of this.entities) entity.draw();\n        Game.player.draw();\n\n        Screen.write(66, 18, '[H] Help', Screen.DIM);\n        Log.draw(3);\n\n        for (let screen of this.screens) {\n            screen.draw();\n        }\n\n        Screen.draw(Viewport.ctx);\n    },\n\n    entityAt(pos) {\n        return this.entities.find(entity => {\n            let found = (entity.pos.x === pos.x) && (entity.pos.y === pos.y) && (entity.pos.z === pos.z);\n            return found;\n        });\n    },\n};\n","// index\n//\n// Entry point into our game. Our only job is to initialize our Game object.\n\nimport { Game } from './Game';\n\nGame.init();\n"]}