{"version":3,"sources":["app.js","../../src/js/Camera.js","../../src/js/Constants.js","../../src/js/Font-gen.js","../../temp-pico8-music/index.js","../../src/js/AudioData-gen.js","../../src/js/Audio.js","../../src/js/Input.js","../../src/js/WorldData-gen.js","../../src/js/World.js","../../src/js/Util.js","../../src/js/Text.js","../../src/js/Screen.js","../../src/js/Log.js","../../src/js/LogScreen.js","../../src/js/HelpScreen.js","../../src/js/InventoryScreen.js","../../src/js/Player.js","../../src/js/TurnSystem.js","../../src/js/Viewport.js","../../src/js/WelcomeScreen.js","../../src/js/Game.js","../../src/js/index.js"],"names":["Camera","[object Object]","this","pos","x","y","z","Game","player","SCREEN_WIDTH","FONT_HEIGHT","Font","Promise","resolve","image","Image","onload","src","data","uri","img","SAMPLE_RATE","AudioCart","h","sfx","l","music","options","audioCtx","AudioContext","sfxData","split","musicData","prevNoise","parseHex","str","start","len","parseInt","substr","round","oscillators","t","Math","abs","white","random","brown","value","u","getFreq","pitch","soundCache","getSound","sfxIndex","pitchOffset","key","sound","sfxRow","noteLength","loopStart","loopEnd","length","Float32Array","getNextIndex","i","getSfx","index","offset","currNote","currFreq","currWaveform","currVolume","currEffect","phi","prevNote","prevFreq","prevWaveform","prevVolume","prevEffect","next","nextNote","nextWaveform","nextVolume","nextEffect","attack","release","samples","customInstrument","k","j","noteFactor","envelope","freq","volume","sin","buildSound","buildMusic","endOffset","sfxBuffer","createMusic","startPattern","timeChannels","patternSamples","songLength","endPattern","pattern","musicRow","flags","channel","frameCount","audioBuffer","createBuffer","getChannelData","source","createBufferSource","buffer","loop","playMusic","connect","destination","AudioData","Audio","initialized","AC","window","webkitAudioContext","setTimeout","globalGain","createGain","gain","linearRampToValueAtTime","currentTime","cart","Input","p","I","v","B","D","T","SELECT","O","C","H","BACK","keyboard","pressed","released","held","framesHeld","keyMapping","ArrowUp","Action","UP","ArrowLeft","LEFT","ArrowDown","DOWN","ArrowRight","RIGHT","KeyC","CAST","KeyL","LOG","KeyH","HELP","KeyI","INVENTORY","Enter","Escape","addEventListener","event","action","code","init","Object","values","WorldData","W","name","F","L","J","Y","id","bounds","G","X","World","reset","visions","frame","tiles","floors","visible","object","objectAt","Screen","writeOnMap","char","colorForObject","c","String","fromCharCode","colorForTile","write","repeat","room","strings","floor","GREEN","map","row","objects","type","rooms","width","height","triggers","trigger","spawn","FLOOR","find","list","push","tileAt","N","finished","DIM","interacted","YELLOW","BLUE","q","tile","WHITE","roomId","rgba","r","g","b","a","formatQuantity","padStart","Text","colorways","terminal","recolor","terminal_shadow","ctx","text","color","font","Array","isArray","block","drawText","idx","charCodeAt","drawImage","FONT_WIDTH","bt","scale","reduce","sum","w","cu","cv","gt","yt","wip","cWidth","measureWidth","saved","space","pop","join","line","It","canvas","document","createElement","getContext","vt","createCanvas","fillStyle","fillRect","globalCompositeOperation","nt","RED","_","ht","rt","Et","Bt","at","Dt","Tt","screen","smudge","clear","COLORS","BRIGHT","startX","startY","SPACE","x2","Error","ox","maxlen","slice","c2","Log","entries","message","formatCode","console","log","add","lines","boxHeight","boxStart","temporaryBlanks","display","flat","writeBox","LogScreen","closing","cull","min","max","draw","HelpScreen","expand","help","InventoryScreen","selected","inventory","useItemOn","description","padEnd","Player","lookingAt","speed","hp","hpMax","sp","spMax","obtainItem","objectsById","roomAt","makeVisible","move","interactWith","entityAt","open","moveInto","openInventoryFor","openDoor","obtainedItem","updateRoom","screens","item","includes","stringId","TurnSystem","entities","tp","update","entity","Viewport","getElementById","resize","force","dpi","devicePixelRatio","clientWidth","clientHeight","dpiWidth","dpiHeight","ceil","center","imageSmoothingEnabled","style","cursor","WelcomeScreen","xyz2pos","requestAnimationFrame","onFrame","now","Date","getTime","lastFrame","filter","takeEntityTurns","setTransform","translate","writeTypewriter"],"mappings":"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IAAIJ,EAAOnJ,KAAKgJ,SAAS2B,GAEzB3K,KAAKiJ,QAAQ0B,IAAW3K,KAAKmJ,EAAKwB,IAAWxB,EAC7CnJ,KAAKkJ,EAASyB,GAAU3K,KAAKmJ,EAAKwB,KAAYxB,EAE1CnJ,KAAKiJ,QAAQ0B,GACb3K,KAAKoJ,EAAWuB,GAAU,EACnB3K,KAAKmJ,EAAKwB,IAAWxB,GAC5BnJ,KAAKoJ,EAAWuB,KAGpB3K,KAAKmJ,EAAKwB,GAAUxB,KCrCnB6B,EAEb,CACIC,EAAU,CACN,CACIC,KAAQ,KACRC,EAAS,CACL,CACI,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IAEJ,CACI,GACA,GACA,GACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IAEJ,CACI,GACA,GACA,GACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,IACA,IACA,IACA,GACA,IACA,IACA,IACA,IACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IAEJ,CACI,GACA,GACA,GACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IAEJ,CACI,GACA,GACA,GACA,IACA,GACA,GACA,IACA,GACA,GACA,IACA,IACA,IACA,IACA,IACA,GACA,IACA,IACA,IACA,IACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IAEJ,CACI,GACA,GACA,GACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,GACA,GACA,GACA,GACA,IACA,GACA,GACA,GACA,IACA,IACA,IACA,GACA,GACA,IACA,IACA,IACA,IACA,GACA,IACA,IACA,IACA,IAEJ,CACI,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,IACA,GACA,GACA,GACA,GACA,IACA,IACA,IACA,IACA,IACA,GACA,IACA,IACA,IACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,IAEJ,CACI,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,GACA,GACA,GACA,GACA,GACA,IACA,GACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,KAEJ,CACI,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,IACA,GACA,GACA,GACA,GACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,KAEJ,CACI,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,GACA,GACA,GACA,GACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,KAEJ,CACI,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,IACA,IACA,IACA,IACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IAEJ,CACI,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,IACA,IACA,IACA,GACA,IACA,IACA,IACA,IACA,IACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IAEJ,CACI,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IAEJ,CACI,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,KAGRC,EAAS,CACL,CACI,GACA,EACA,EACA,EACA,GAEJ,CACI,GACA,GACA,EACA,EACA,GAEJ,CACI,GACA,GACA,EACA,EACA,GAEJ,CACI,GACA,GACA,EACA,EACA,GAEJ,CACI,GACA,GACA,EACA,GACA,GAEJ,CACI,GACA,GACA,EACA,GACA,GAEJ,CACI,GACA,GACA,EACA,EACA,GAEJ,CACI,GACA,EACA,EACA,EACA,IAGRC,EAAW,CACP,CACI,EACA,GACA,EACA,GAEJ,CACI,EACA,GACA,EACA,GAEJ,CACI,GACA,GACA,GAEJ,CACI,GACA,GACA,GAEJ,CACI,EACA,GACA,EACA,GAEJ,CACI,GACA,GACA,GAEJ,CACI,GACA,GACA,GAEJ,CACI,EACA,GACA,EACA,GAEJ,CACI,EACA,GACA,EACA,GAEJ,CACI,GACA,EACA,GAEJ,CACI,EACA,GACA,GACA,GAEJ,CACI,GACA,GACA,GAEJ,CACI,GACA,GACA,GAEJ,CACI,EACA,GACA,GAEJ,CACI,GACA,GACA,GAEJ,CACI,GACA,GACA,IAGRC,EAAY,GACZC,GAAM,IAGdC,OAAU,CACN,CACI,EACA,GAEJ,CACI,GACA,KAGRC,EAAS,CACL,GACA,EACA,GAEJC,EAAW,CACP,EACA,mGACA,6JACA,EACA,wDACA,EACA,EACA,6CACA,yGACA,2CACA,gIACA,0CACA,yKACA,6JACA,uOACA,2LACA,gLACA,wBACA,qDACA,kIACA,6EACA,yEACA,4LACA,oFACA,mFACA,EACA,EACA,EACA,EACA,EACA,CACI,cACA,iOAEJ,CACI,eACA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","file":"app.js","sourcesContent":["(function () {\n    'use strict';\n\n    // Camera\n\n    const Camera = {\n        init() {\n            this.pos = { x: 0, y: 0, z: 0 };\n        },\n\n        update() {\n            this.pos = Game.player.pos;\n        }\n    };\n\n    // Constants\n    //\n    // Where possible, global values are all kept here in spot for easy tweaking.\n    // Don't worry about constant length -- our terser configuration in the build step\n    // is going to mangle all of our constants into tiny variable names.\n\n    // The \"screen area\", in ASCII characters.\n    const SCREEN_WIDTH = 80;\n    const SCREEN_HEIGHT = 24;\n\n    // The size in pixels of each character in our monospaced font.\n    const FONT_WIDTH = 8;\n    const FONT_HEIGHT = 16;\n\n    // Screen scaling -- currently not used.\n    const SCREEN_SCALE = 1;\n\n    // Playable area in pixels. Note that actual on-screen dimensions may differ to maintain\n    // aspect ratio -- see `Viewport.width` & `Viewport.height`.\n    //\n    // We add a little bit of padding to make sure we don't draw a character right on top of\n    // of the edge of the user's browser window.\n    const GAME_WIDTH = (SCREEN_WIDTH + 1) * FONT_WIDTH * SCREEN_SCALE;\n    const GAME_HEIGHT = (SCREEN_HEIGHT + 1) * FONT_HEIGHT * SCREEN_SCALE;\n\n    // Global frames per second\n    const FPS = 60;\n\n    // How many frames does a turn take? This game is essentially turn-based (enemies don't\n    // move unless the player moves). So this value really boils down to how fast the player\n    // moves if they hold down an arrow key.\n    //\n    // 12 frames = 5 tiles per second.\n    const TURN_FRAMES = 2;\n\n    // The number of lines of recent history to show to the player, in the normal (closed)\n    // case and the open (reviewing history) case.\n    const LOG_CLOSED_LINES = 3;\n    const LOG_OPEN_LINES = 15;\n\n    // Horizontal column for the divider between map and status area.\n    const STATUS_COL = 64;\n\n    // Object types\n    const TYPE_DOOR = 2;\n\n    // Screen flickers\n    const FLICKER_FRAME_1 = 169;\n    const FLICKER_FRAME_2 = 221;\n\n    // Font\n    //\n    // This file is generated by `gulp buildAssets`.\n\n    const Font = {\n        async init() {\n            await new Promise(resolve => {\n                let image = new Image();\n                image.onload = resolve;\n                image.src = Font.data.uri;\n                Font.img = image;\n            });\n        },\n        data:\n    /* <generated> */\n    { uri:\n       'data:image/png;base64,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' }\n    /* </generated> */\n    };\n\n    const FX_SLIDE = 1;\n    const FX_VIBRATO = 2;\n    const FX_DROP = 3;\n    const FX_FADE_IN = 4;\n    const FX_FADE_OUT = 5;\n    const FX_ARP_FAST = 6;\n    const SAMPLE_RATE = 44100;\n    const BASE_SPEED = 120;\n\n    /**\n     * Creates a new PICO-8 AudioCart using the \"sfx\" and \"music\" data from\n     * a cartridge file.\n     * @param {string} sfx\n     * @param {string} music\n     * @param {object} options\n     */\n    function AudioCart({ sfx, music }, options = {}) {\n      // Note: some browsers don't allow creation of an AudioContext unless you're inside\n      // a user-triggered event, like a mouse click or keypress. One way to control this\n      // is to initialize the AudioCart from a user-triggered event.\n      //\n      // (If you have multiple AudioCarts, you can choose to share an AudioContext by\n      // creating it yourself and passing it into each AudioCart in the options section.)\n      const audioCtx = options.audioCtx || new AudioContext();\n\n      // Each \"line\" of sfx and music represents one of the 64 allowed patterns in PICO-8.\n      // Note that sfx data contains a lot of \"nybbles\" (a single hex character, i.e., 4\n      // bits out of an 8-bit byte), which means the obvious improvement of breaking up\n      // each byte into integers isn't quite that simple.\n      //\n      // For now, the sfx and music data is processed \"as hex\" inline while we build up\n      // the audio samples.\n      let sfxData = sfx.split('\\n');\n      let musicData = music.split('\\n');\n\n      /**\n       * Previous brown noise.\n       * Need to track this to trim frequency ranges.\n       * See the noise oscillator.\n       * @type {number}\n       */\n      let prevNoise = 0;\n\n      /**\n       * Parses a hex substring into a decimal number.\n       * @param {string} str\n       * @param {number} start\n       * @param {number} len\n       * @return {number}\n       * @noinline\n       */\n      const parseHex = (str, start, len) => parseInt(str.substr(start, len), 16);\n\n      /**\n       * Rounds a number.\n       * This compresses better than Math.round.\n       * Google Closure Compiler inlines the calls.\n       * @param {number} x Input number.\n       * @return {number} Output number.\n       */\n      const round = (x) => (x + 0.5) | 0;\n\n      /**\n       * Triangle oscillator.\n       * @param {number} t\n       * @return {number}\n       */\n      const triangleOscillator = (t) => Math.abs(2 * t - 1) - 1.0;\n\n      /**\n       * Tilted saw oscillator.\n       * @param {number} t\n       * @return {number}\n       */\n      const tiltedSawOscillator = (t) => {\n        const a = 0.9;\n        const ret = t < a ? 2.0 * t / a - 1.0 : 2.0 * (1.0 - t) / (1.0 - a) - 1.0;\n        return ret * 0.5;\n      };\n\n      /**\n       * Saw oscillator.\n       * 0->1 ramp\n       * @param {number} t\n       * @return {number}\n       */\n      const sawOscillator = (t) => 0.6 * (t < 0.5 ? t : t - 1.0);\n\n      /**\n       * Square oscillator.\n       * 50% duty cycle square wave\n       * @param {number} t\n       * @return {number}\n       */\n      const squareOscillator = (t) => t < 0.5 ? 0.5 : -0.5;\n\n      /**\n       * Pulse oscillator.\n       * 20% duty cycle square wave\n       * @param {number} t\n       * @return {number}\n       */\n      const pulseOscillator = (t) => t < 0.3 ? 0.5 : -0.5;\n\n      /**\n       * Organ oscillator.\n       * tri-uneven: 100% tri 75% tri on loop\n       * @param {number} t\n       * @return {number}\n       */\n      const organOscillator = (t) => (\n        t < 0.5 ?\n          3.0 - Math.abs(24.0 * t - 6.0) :\n          1.0 - Math.abs(16.0 * t - 12.0)\n      ) / 9.0;\n\n      /**\n       * Noise oscillator.\n       * @return {number}\n       */\n      const noiseOscillator = () => {\n        const white = Math.random() * 2 - 1;\n        const brown = (prevNoise + (0.02 * white)) / 1.02;\n        prevNoise = brown;\n        return brown * 10; // (roughly) compensate for gain\n      };\n\n      /**\n       * Phaser oscillator.\n       * @param {number} t\n       * @param {number} value\n       * @return {number}\n       */\n      const phaserOscillator = (t, value) => {\n        // This one has a subfrequency of freq/128 that appears\n        // to modulate two signals using a triangle wave\n        const k = Math.abs(2.0 * ((value / 128.0) % 1.0) - 1.0);\n        const u = (t + 0.5 * k) % 1.0;\n        const ret = Math.abs(4.0 * u - 2.0) - Math.abs(8.0 * t - 4.0);\n        return ret / 6.0;\n      };\n\n      /**\n       * Oscillators.\n       * Order and indices are important!\n       * @const {!Array.<function(number=, number=): number>}\n       */\n      const oscillators = [\n        triangleOscillator,\n        tiltedSawOscillator,\n        sawOscillator,\n        squareOscillator,\n        pulseOscillator,\n        organOscillator,\n        noiseOscillator,\n        phaserOscillator,\n      ];\n\n      /**\n       * Returns note frequency from pitch index (0-63).\n       * From C-0 to D#-5 in chromatic scale.\n       * @param {number} pitch\n       * @return {number}\n       */\n      const getFreq = (pitch) => 65 * 2 ** (pitch / 12);\n\n      /**\n       * Cache of pre-built sounds.\n       * Key is `${sfxIndex}-${pitchOffset}\n       * Value is a Float32Array.\n       * @const {!Object}\n       */\n      const soundCache = {};\n\n      /**\n       * Builds the sound from scratch.\n       * @param {!Array.<string>} sfxData\n       * @param {number} sfxIndex\n       * @param {number} pitchOffset\n       * @return {!Float32Array}\n       */\n      const buildSound = (sfxData, sfxIndex, pitchOffset) => {\n        const sfxRow = sfxData[sfxIndex];\n        const noteLength = parseHex(sfxRow, 2, 2) / BASE_SPEED;\n        const loopStart = parseHex(sfxRow, 4, 2);\n        const loopEnd = parseHex(sfxRow, 6, 2) || 32;\n        const length = loopEnd * SAMPLE_RATE;\n        const data = new Float32Array(length);\n\n        /**\n         * Returns the next note index.\n         * Handles loop start/end.\n         * @param {number} i The current note index.\n         * @return {number} The next note index.\n         */\n        const getNextIndex = (i) => i + 1 >= loopEnd ? loopStart : i + 1;\n\n        /**\n         * Returns a data element from the sfx row.\n         * @param {number} index The note index. (0-32).\n         * @param {number} offset The element offset (0-4).\n         * @param {number} len The length in hex characters.\n         * @return {number} The sfx value.\n         */\n        const getSfx = (index, offset, len) => parseHex(sfxRow, 8 + index * 5 + offset, len);\n\n        let offset = 0;\n        let phi = 0;\n        let i = 0;\n\n        let prevNote = 24;\n        let prevFreq = getFreq(24);\n        let prevWaveform = -1;\n        let prevVolume = -1;\n        let prevEffect = -1;\n\n        let currNote;\n        let currFreq;\n        let currWaveform;\n        let currVolume;\n        let currEffect;\n\n        while (offset < length) {\n          currNote = getSfx(i, 0, 2) + pitchOffset;\n          currFreq = getFreq(currNote);\n          currWaveform = getSfx(i, 2, 1);\n          currVolume = getSfx(i, 3, 1) / 8.0;\n          currEffect = getSfx(i, 4, 1);\n\n          const next = getNextIndex(i);\n          const nextNote = getSfx(next, 0, 2) + pitchOffset;\n          const nextWaveform = getSfx(next, 2, 1);\n          const nextVolume = getSfx(next, 3, 1);\n          const nextEffect = getSfx(next, 4, 1);\n\n          let attack = 0.02;\n          if (currEffect === FX_FADE_IN ||\n            (currWaveform === prevWaveform &&\n              (currNote === prevNote || currEffect === FX_SLIDE) &&\n              prevVolume > 0 &&\n              prevEffect !== FX_FADE_OUT)) {\n            attack = 0;\n          }\n          let release = 0.05;\n          if (currEffect === FX_FADE_OUT ||\n            (currWaveform === nextWaveform &&\n              (currNote === nextNote || nextEffect === FX_SLIDE) &&\n              nextVolume > 0 &&\n              nextEffect !== FX_FADE_IN)) {\n            release = 0;\n          }\n\n          const samples = round(noteLength * SAMPLE_RATE);\n          const customInstrument = currWaveform > 7 && getSound(sfxData, currWaveform - 8, pitchOffset + currNote - 24);\n          let k = 0;\n          for (let j = offset; j < offset + samples; j++) {\n            // Note factor is the percentage of completion of the note\n            // 0.0 is the beginning\n            // 1.0 is the end\n            const noteFactor = (j - offset) / samples;\n\n            let envelope = 1.0;\n            if (noteFactor < attack) {\n              envelope = noteFactor / attack;\n            } else if (noteFactor > (1.0 - release)) {\n              envelope = (1.0 - noteFactor) / release;\n            }\n\n            let freq = currFreq;\n            let volume = currVolume;\n\n            if (currEffect === FX_SLIDE) {\n              freq = (1 - noteFactor) * prevFreq + noteFactor * currFreq;\n              if (prevVolume > 0) {\n                volume = (1 - noteFactor) * prevVolume + noteFactor * currVolume;\n              }\n            }\n            if (currEffect === FX_VIBRATO) {\n              freq *= 1.0 + 0.02 * Math.sin(7.5 * noteFactor);\n            }\n            if (currEffect === FX_DROP) {\n              freq *= 1.0 - noteFactor;\n            }\n            if (currEffect === FX_FADE_IN) {\n              volume *= noteFactor;\n            }\n            if (currEffect === FX_FADE_OUT) {\n              volume *= 1.0 - noteFactor;\n            }\n            if (currEffect >= FX_ARP_FAST) {\n              // From the documentation:\n              //   6 arpeggio fast  //  Iterate over groups of 4 notes at speed of 4\n              //   7 arpeggio slow  //  Iterate over groups of 4 notes at speed of 8\n              //   If the SFX speed is <= 8, arpeggio speeds are halved to 2, 4\n              // const m = (speed <= 8 ? 32 : 16) / (effect === FX_ARP_FAST ? 4 : 8);\n              // const n = (int)(m * 7.5 * offset / offsetPerSecond);\n              // const arp_note = (note_id & ~3) | (n & 3);\n              // freq = key_to_freq(sfx.notes[arp_note].key);\n              freq = currFreq;\n            }\n\n            phi += freq / SAMPLE_RATE;\n            if (currWaveform < 8) {\n              data[j] += volume * envelope * oscillators[currWaveform](phi % 1, phi);\n            } else {\n              data[j] += volume * envelope * customInstrument[k];\n              k = (k + 1) % customInstrument.length;\n            }\n          }\n\n          offset += samples;\n          prevNote = currNote;\n          prevFreq = currFreq;\n          prevWaveform = currWaveform;\n          prevVolume = currVolume;\n          prevEffect = currEffect;\n          i = getNextIndex(i);\n        }\n        return data;\n      };\n\n      /**\n       * Returns a sound buffer.\n       * Uses a cached buffer if available.\n       * Otherwise builds the sound from scratch.\n       * @param {!Array.<string>} sfxData\n       * @param {number} sfxIndex\n       * @param {number} pitchOffset\n       * @return {!Float32Array}\n       */\n      const getSound = (sfxData, sfxIndex, pitchOffset) => {\n        const key = sfxIndex + '-' + pitchOffset;\n        let sound = soundCache[key];\n        if (!sound) {\n          sound = buildSound(sfxData, sfxIndex, pitchOffset);\n          soundCache[key] = sound;\n        }\n        return sound;\n      };\n\n      /**\n       * @param {!Array.<string>} sfxData\n       * @param {!Float32Array} data\n       * @param {number} offset\n       * @param {number} endOffset\n       * @param {number} sfxIndex\n       * @param {number=} pitchOffset\n       */\n      const buildMusic = (sfxData, data, offset, endOffset, sfxIndex, pitchOffset = 0) => {\n        const sfxBuffer = getSound(sfxData, sfxIndex, pitchOffset);\n        let i = 0;\n        while (offset < endOffset) {\n          data[offset] += sfxBuffer[i];\n          i = (i + 1) % sfxBuffer.length;\n          offset++;\n        }\n      };\n\n      /**\n       * Builds a song and returns an audio buffer that can be used to play it.\n       * You should connect up your own audio destination before starting.\n       * @param {number=} startPattern\n       * @return {!AudioBufferSourceNode}\n       */\n      const createMusic = (startPattern = 0) => {\n        // Preprocess loop\n        // Need to do 4 things on this loop:\n        // 1) Find the \"time\" channels\n        //    Channels can run at different speeds, and therefore have different lengths\n        //    The length of a pattern is defined by the first non-looping channel\n        //    See: https://www.lexaloffle.com/bbs/?pid=12781\n        // 2) Calculate the pattern lengths\n        //    After we know the time channel, we can convert that into number of samples\n        // 3) Find the loop start time (if one exists)\n        //    Find the pattern with the \"start loop\" flag set\n        //    Otherwise default to beginning of the song\n        // 4) Find the end pattern and total song length\n        //    Find the pattern with the \"end loop\" flag set\n        //    Otherwise default to end of the song\n        const timeChannels = [];\n        const patternSamples = [];\n        let loopStart = 0;\n        let songLength = 0;\n        let endPattern = musicData.length - 1;\n        for (let pattern = startPattern; pattern <= endPattern; pattern++) {\n          const musicRow = musicData[pattern];\n          const flags = parseHex(musicRow, 0, 2);\n\n          timeChannels[pattern] = 0;\n          for (let channel = 0; channel < 4; channel++) {\n            const sfxIndex = parseHex(musicRow, 3 + channel * 2, 2);\n            if (sfxIndex < sfxData.length) {\n              const sfxRow = sfxData[sfxIndex];\n              const loopEnd = parseHex(sfxRow, 6, 2);\n              if (loopEnd === 0) {\n                timeChannels[pattern] = channel;\n                break;\n              }\n            }\n          }\n\n          const sfxIndex = parseHex(musicRow, 3 + timeChannels[pattern] * 2, 2);\n          const sfxRow = sfxData[sfxIndex];\n          const noteLength = parseHex(sfxRow, 2, 2) / BASE_SPEED;\n          patternSamples[pattern] = round(32 * noteLength * SAMPLE_RATE);\n\n          if ((flags & 1) === 1) {\n            loopStart = songLength;\n          }\n\n          songLength += 32 * noteLength;\n\n          if ((flags & 2) === 2) {\n            endPattern = pattern;\n            break;\n          }\n        }\n\n        // Now we have everything we need to build the song\n        const frameCount = SAMPLE_RATE * songLength;\n        const audioBuffer = audioCtx.createBuffer(1, frameCount, SAMPLE_RATE);\n        const data = audioBuffer.getChannelData(0);\n\n        // Main music generator loop\n        let offset = 0;\n        for (let pattern = startPattern; pattern <= endPattern; pattern++) {\n          const musicRow = musicData[pattern];\n          const samples = patternSamples[pattern];\n          for (let channel = 0; channel < 4; channel++) {\n            const sfxIndex = parseHex(musicRow, 3 + channel * 2, 2);\n            if (sfxIndex < sfxData.length) {\n              buildMusic(sfxData, data, offset, offset + samples, sfxIndex);\n            }\n          }\n          offset += samples;\n        }\n\n        const source = audioCtx.createBufferSource();\n        source.buffer = audioBuffer;\n        source.loop = true;\n        source.loopStart = loopStart;\n        return source;\n      };\n\n      /**\n       * Builds a song and immediately plays it.\n       * @param {number=} startPattern\n       * @return {!AudioBufferSourceNode}\n       */\n      const playMusic = (startPattern = 0) => {\n        const source = createMusic(startPattern);\n        source.connect(audioCtx.destination);\n        source.start();\n        return source;\n      };\n\n      this.music = createMusic;\n      this.playMusic = playMusic;\n    }\n\n    // audio5.p8\n    const AudioData = { music: '00 01424144\\n00 01444144\\n00 01044147\\n00 01044344\\n00 01044344\\n00 00044344\\n01 01040944\\n00 01040844\\n00 01040944\\n02 00040744', sfx: '011600000f5250f4150f2130f7250f5150f7350f4150f5150f6250f4150f513147250f515157350f4150f7150f5250f4150f5130f7250f5150f7350f4150f5150f6250f4150f2130f7250f515107350f4150f715\\n011600000c5250c4150c5150c7250c5150c7350c4150c5150c6250c4150c5150d7250c5150d7350c4150c7150c5250c4150c5150c7250c5150c7350c4150c5150c6250c4150c5150c7250c5150d7350c4150c715\\n011600000c60012500115000c6000c0002a0002a000290000c60012500115000c6000c0002a00029000240000c60012500115000c6000c00012500115000c5000c5100d0100c7200d02018030195301804019740\\n011600000f0300c030115400c0311803212730110400c5300f0300c030117400c0311803212530110400c7300f0300c030115400c0311803212730110400c5300f0300c030117400c03118032195301804019730\\n011600000c073000000c043000000c023000000c003000000c073000000c053000000c033000000c013306000c073000000c043000000c023000000c003306000c073000000c053000000c033000000c01330600\\n01160000150301203017540120311e032187301704012530150301203017740120311e032185301704012730150301203017540120311e032187301704012530150301203017740120311e0321f5301e0401f730\\n001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\\n01160000157500300015730030001571003000030000300014750030001474003000147300300014710030000c700000000000000000000000000000000000001073003000107401470010750157001076015500\\n011600000c7500c7500f7520000011750117501375012700127501255212750007000d750000000c750000000c740000000c730000000c720000000c710000000000000000000000000000000000000000000000\\n011600000c7500c7500f7520000011750117501375012700127501250212740007001273000000127100000000000000000000000000000000000000000000000000000000000000000000000000000000000000' };\n\n    // Audio\n\n    const Audio = {\n        init() {\n            if (this.initialized) return;\n\n            // Note: unlike most init() methods, this is called from the first\n            // user-triggered event (like a keypress), not the main game loop. This\n            // avoids warnings in browsers about being unable to create an AudioContext.\n            this.initialized = true;\n\n            const AC = window.AudioContext || window.webkitAudioContext;\n            this.audioCtx = new AC();\n\n            setTimeout(() => {\n                this.globalGain = this.audioCtx.createGain(this.audioCtx, { gain: 0 });\n                this.globalGain.connect(this.audioCtx.destination);\n                this.globalGain.gain.linearRampToValueAtTime(1, this.audioCtx.currentTime + 2);\n\n                this.cart = new AudioCart(AudioData, { audioCtx: this.audioCtx });\n\n                this.music = this.cart.music();\n                this.music.connect(this.globalGain);\n                this.music.start();\n            }, 1);\n        }\n    };\n\n    // Input\n\n    const Input = {\n        Action: {\n            UP:        11,\n            DOWN:      12,\n            LEFT:      13,\n            RIGHT:     14,\n            CAST:      15,\n            SELECT:    25,\n            INVENTORY: 26,\n            LOG:       27,\n            HELP:      28,\n            BACK:      29\n        },\n\n        init() {\n            // Key action up/down state\n            this.keyboard = {};\n\n            // \"Pressed\" means an input was pressed THIS FRAME.\n            this.pressed = {};\n\n            // \"Released\" means an input was released THIS FRAME.\n            this.released = {};\n\n            // \"Held\" means an input is held down. The input was \"Pressed\" either\n            // this frame or in a past frame, and has not been \"Released\" yet.\n            this.held = {};\n\n            // How many frames was this input held down by the player. If [held]\n            // is false, it represents how long the input was last held down.\n            this.framesHeld = {};\n\n            this.keyMapping = {\n                ArrowUp: Input.Action.UP,\n                ArrowLeft: Input.Action.LEFT,\n                ArrowDown: Input.Action.DOWN,\n                ArrowRight: Input.Action.RIGHT,\n                KeyC: Input.Action.CAST,\n                KeyL: Input.Action.LOG,\n                KeyH: Input.Action.HELP,\n                KeyI: Input.Action.INVENTORY,\n                Enter: Input.Action.SELECT,\n                Escape: Input.Action.BACK\n            };\n\n            window.addEventListener('keydown', event => {\n                let action = this.keyMapping[event.code];\n                if (action) {\n                    this.keyboard[action] = true;\n                }\n\n                Audio.init();\n            });\n\n            window.addEventListener('keyup', event => {\n                let action = this.keyMapping[event.code];\n                if (action) {\n                    this.keyboard[action] = false;\n                }\n            });\n        },\n\n        update() {\n            for (let action of Object.values(Input.Action)) {\n                let held = this.keyboard[action];\n\n                this.pressed[action] = !this.held[action] && held;\n                this.released[action] = this.held[action] && !held;\n\n                if (this.pressed[action]) {\n                    this.framesHeld[action] = 1;\n                } else if (this.held[action] && held) {\n                    this.framesHeld[action]++;\n                }\n\n                this.held[action] = held;\n            }\n        }\n    };\n\n    // WorldData\n    //\n    // This file is generated by `gulp buildAssets`.\n\n    /* <generated-constants> */\n    const $D_DINING = 1;\n    const $D_DINING_OPEN = 2;\n    const $D_DRAW = 3;\n    const $D_FOYER = 4;\n    const $D_GARAGE = 5;\n    const $D_HALLWAY = 6;\n    const $D_KITCHEN = 7;\n    const $F_BURNT_CHAIR = 8;\n    const $F_BURNT_CHAIR_A = 9;\n    const $F_FIRE3 = 14;\n    const $F_FIRE3_A = 15;\n    const $F_FIRE3_B = 16;\n    const $F_SHELF1 = 17;\n    const $F_SHELF2 = 18;\n    const $F_SHELF3 = 19;\n    const $F_SHELF3_A = 20;\n    const $F_STAIR1 = 21;\n    const $F_STATUE = 22;\n    const $F_STATUE_A = 23;\n    const $F_STATUE_B = 24;\n    const $I_BURNT_NOTEBOOK = 44;\n    const $I_DOLL_WORKBENCH = 45;\n    const $I_IRON_KNIFE = 41;\n    const $I_SILVER_KEY = 42;\n    const $I_UNCLE_LETTER = 43;\n    const $R_DINING = 30;\n    const $R_DRAW = 31;\n    const $R_GARAGE = 33;\n    const $R_HALLWAY = 34;\n    /* </generated-constants> */\n\n    const WorldData =\n    /* <generated-data> */\n    {\n        \"floors\": [\n            {\n                \"name\": \"1F\",\n                \"tiles\": [\n                    [\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32\n                    ],\n                    [\n                        32,\n                        32,\n                        32,\n                        129,\n                        129,\n                        129,\n                        129,\n                        129,\n                        129,\n                        129,\n                        134,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32\n                    ],\n                    [\n                        32,\n                        32,\n                        32,\n                        128,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        137,\n                        129,\n                        129,\n                        129,\n                        45,\n                        129,\n                        129,\n                        129,\n                        129,\n                        134,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32\n                    ],\n                    [\n                        32,\n                        32,\n                        32,\n                        128,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        124,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        93,\n                        128,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32\n                    ],\n                    [\n                        32,\n                        32,\n                        32,\n                        128,\n                        46,\n                        46,\n                        166,\n                        46,\n                        46,\n                        168,\n                        137,\n                        129,\n                        129,\n                        129,\n                        45,\n                        135,\n                        129,\n                        129,\n                        129,\n                        131,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32\n                    ],\n                    [\n                        32,\n                        32,\n                        32,\n                        129,\n                        129,\n                        129,\n                        129,\n                        129,\n                        129,\n                        129,\n                        138,\n                        46,\n                        46,\n                        46,\n                        46,\n                        128,\n                        32,\n                        32,\n                        32,\n                        133,\n                        129,\n                        134,\n                        32,\n                        32,\n                        130,\n                        129,\n                        129,\n                        129,\n                        45,\n                        129,\n                        129,\n                        138,\n                        32\n                    ],\n                    [\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        133,\n                        131,\n                        46,\n                        35,\n                        35,\n                        46,\n                        137,\n                        129,\n                        135,\n                        129,\n                        131,\n                        37,\n                        132,\n                        129,\n                        129,\n                        138,\n                        61,\n                        61,\n                        46,\n                        46,\n                        46,\n                        61,\n                        128,\n                        32\n                    ],\n                    [\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        128,\n                        37,\n                        46,\n                        35,\n                        35,\n                        46,\n                        128,\n                        60,\n                        132,\n                        46,\n                        46,\n                        46,\n                        46,\n                        35,\n                        46,\n                        128,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        132,\n                        134\n                    ],\n                    [\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        132,\n                        134,\n                        46,\n                        35,\n                        35,\n                        46,\n                        128,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        124,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        37,\n                        128\n                    ],\n                    [\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        128,\n                        46,\n                        46,\n                        46,\n                        46,\n                        124,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        128,\n                        91,\n                        93,\n                        46,\n                        46,\n                        38,\n                        46,\n                        133,\n                        131\n                    ],\n                    [\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        132,\n                        129,\n                        129,\n                        129,\n                        129,\n                        138,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        46,\n                        38,\n                        46,\n                        137,\n                        129,\n                        129,\n                        145,\n                        129,\n                        129,\n                        129,\n                        131,\n                        32\n                    ],\n                    [\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        132,\n                        129,\n                        129,\n                        129,\n                        45,\n                        129,\n                        129,\n                        129,\n                        129,\n                        131,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32\n                    ],\n                    [\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32\n                    ],\n                    [\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32,\n                        32\n                    ]\n                ],\n                \"rooms\": [\n                    [\n                        33,\n                        3,\n                        1,\n                        8,\n                        5\n                    ],\n                    [\n                        31,\n                        25,\n                        5,\n                        8,\n                        6\n                    ],\n                    [\n                        30,\n                        10,\n                        4,\n                        6,\n                        7\n                    ],\n                    [\n                        32,\n                        19,\n                        5,\n                        3,\n                        2\n                    ],\n                    [\n                        34,\n                        10,\n                        2,\n                        10,\n                        3\n                    ],\n                    [\n                        32,\n                        15,\n                        6,\n                        10,\n                        6\n                    ],\n                    [\n                        31,\n                        24,\n                        5,\n                        4,\n                        2\n                    ],\n                    [\n                        30,\n                        9,\n                        6,\n                        2,\n                        3\n                    ]\n                ],\n                \"objects\": [\n                    [\n                        3,\n                        24,\n                        8,\n                        2\n                    ],\n                    [\n                        6,\n                        14,\n                        4,\n                        2\n                    ],\n                    [\n                        12,\n                        20,\n                        6\n                    ],\n                    [\n                        14,\n                        31,\n                        8\n                    ],\n                    [\n                        1,\n                        15,\n                        9,\n                        2\n                    ],\n                    [\n                        13,\n                        10,\n                        7\n                    ],\n                    [\n                        10,\n                        22,\n                        7\n                    ],\n                    [\n                        5,\n                        10,\n                        3,\n                        2\n                    ],\n                    [\n                        7,\n                        14,\n                        2,\n                        2\n                    ],\n                    [\n                        17,\n                        6,\n                        4\n                    ],\n                    [\n                        4,\n                        19,\n                        11,\n                        2\n                    ],\n                    [\n                        21,\n                        16,\n                        7\n                    ],\n                    [\n                        22,\n                        29,\n                        9\n                    ],\n                    [\n                        8,\n                        18,\n                        3\n                    ],\n                    [\n                        18,\n                        25,\n                        6\n                    ],\n                    [\n                        19,\n                        26,\n                        6\n                    ]\n                ],\n                \"triggers\": [],\n                \"id\": 0\n            }\n        ],\n        \"bounds\": [\n            [\n                0,\n                0\n            ],\n            [\n                33,\n                14\n            ]\n        ],\n        \"spawn\": [\n            19,\n            9,\n            0\n        ],\n        \"strings\": [\n            0,\n            \"The lock is broken and the door won't budge. With the right tool, you can\\nprobably pry it open.\",\n            \"You wedge the knife between the door and frame. With a little effort, you\\nforce the broken lock away from the strike plate.\\n%y%0 You push the door open.\",\n            0,\n            \"The front door has jammed behind you and won't budge.\",\n            0,\n            0,\n            \"It seems to be locked from the other side.\",\n            \"The charred remnants of a rocking chair.\\nA half-burnt notebook is resting on the melted seat cushion.\",\n            \"The charred remnants of a rocking chair.\",\n            \"A vintage dollhouse. Normally you could open it up and take a look inside,\\nbut it's been locked with a small silver padlock.\",\n            \"You need some kind of key to open this.\",\n            \"A massive stone fireplace. Above it hangs a portrait of a woman with long,\\nstraight black hair. She has one hand on her visibly pregnant belly.\\nThe embers are cold.\",\n            \"An impressive granite fireplace. Above the mantle hangs a brightly colored\\npainting of a newborn, out of place in such a drab room.\\nThe embers are cold.\",\n            \"Above a brick-and-onyx hearth hangs an unpleasant painting of a small child\\nbeing devoured whole by a tall, dimly-lit creature. It is hard to look at.\\nA knife has been left jammed into the canvas. You can probably pull it out.\",\n            \"With a tug, the painting releases a long iron knife. Hundreds of tiny\\nsymbols have been etched up and down the blade, but you don't recognize them.\\n%y%0 You have obtained iron knife.\",\n            \"Above a brick-and-onyx hearth hangs an unpleasant painting of a small child\\nbeing devoured whole by a tall, dimly-lit creature. It is hard to look at.\\nThe embers are cold.\",\n            \"A rusty garage shelf.\",\n            \"The shelf is covered with dust, but not much else.\",\n            \"The shelf seems to have been recently used, most of the dust is wiped off.\\nA realistic miniature workbench rests on the shelf.\",\n            \"The shelf seems to have been recently used, most of the dust is wiped off.\",\n            \"The stairs to the second floor are a wreck - you can't go up this way.\",\n            \"A crude, life-sized sculpture of a pregnant woman. One hand rests on her\\nbelly, and the other holds an iron knife.\\nThe sculpture's grip looks loose - perhaps you could take the knife.\",\n            \"With a tug, the sculpture releases the knife.\\n%y%0 You have obtained iron knife.\",\n            \"A crude, life-sized sculpture of a pregnant woman. One hand rests on her\\nbelly.\",\n            0,\n            0,\n            0,\n            0,\n            0,\n            [\n                \"DINING ROOM\",\n                \"The dining room is dominated by an oak table, which appears to have been\\nused recently as a butcher's block. Flies buzz above fresh animal entrails\\nlittering the table. The table and the carpet below is soaked in blood.\"\n            ],\n            [\n                \"DRAWING ROOM\",\n                \"You are in a dimly lit drawing room filled with faded furniture.\\nThe room smells of musty upholstery.\"\n            ],\n            [\n                \"FOYER\",\n                \"You are in the foyer of the farmhouse. The peeling paint and threadbare\\nrugs make it seem older than the outside of the house.\\nA large dollhouse sits on a pedestal in the far corner of the room.\"\n            ],\n            [\n                \"GARAGE\",\n                \"The garage is empty, save for a few rusty shelves and the usual cobwebs.\\nThere must have been other furniture here recently, you can see lines\\nin the dust where a workbench used to be.\"\n            ],\n            [\n                \"CHARRED HALLWAY\",\n                \"There must have been a fire at some point. Soot and grime coat the walls,\\nand the air stinks of burnt fabric.\"\n            ],\n            [\n                \"???\",\n                \"A nice old room.\\nWhat a nice place it is.\\nFuck it.\"\n            ],\n            0,\n            0,\n            0,\n            0,\n            0,\n            [\n                \"iron knife\",\n                \"A large iron knife etched with\\nhundreds of tiny symbols. It feels\\nheavy in your hand.\"\n            ],\n            [\n                \"silver key\",\n                \"A small, delicate silver key.\"\n            ],\n            [\n                \"your uncle's letter\",\n                \"Dearest Emily,\\n\\nYou may think me mad but I need\\nyour help. We all do. Together\\nwe can stop them or it's not\\n[the rest is crossed out...]\"\n            ],\n            [\n                \"a half-burnt notebook\",\n                \"Most of the pages are too burnt\\nto read, but somehow one page\\nis crystal clear:\\n\\n\\\"Our Goddess walks the hills\\n in the shadow of the wailing star\\n and we follow in her path\\\"\"\n            ],\n            [\n                \"miniature workbench\",\n                \"A curiously realistic miniature\\nworkbench, made of wood and metal.\\nMaybe there's some use for it.\"\n            ]\n        ]\n    }\n    /* </generated-data> */\n    ;\n\n    // World\n\n    const World = {\n        FLOOR: 46, // '.'\n\n        init() {\n            this.reset();\n            this.visions = [];\n        },\n\n        draw() {\n            if (Game.frame % FLICKER_FRAME_1 > 1) {\n                let tiles = this.floors[0].tiles;\n                for (let y = 0; y < tiles.length; y++) {\n                    for (let x = 0; x < tiles[y].length; x++) {\n                        if (this.floors[0].visible[y][x]) {\n                            let object = this.objectAt({ x, y, z: 0 });\n                            if (object) {\n                                Screen.writeOnMap(x, y, object.char, this.colorForObject(object));\n                            } else {\n                                let c = String.fromCharCode(tiles[y][x]);\n                                Screen.writeOnMap(x, y, c, this.colorForTile(c));\n                            }\n                        }\n                    }\n                }\n            }\n\n            Screen.write(0, 0, ' '.repeat(STATUS_COL));\n            Screen.write(0, 1, ' '.repeat(STATUS_COL));\n            Screen.write(0, 2, ' '.repeat(STATUS_COL));\n\n            if (Game.player.room) {\n                let name = World.strings[Game.player.room.id][0];\n                Screen.write(Math.floor((STATUS_COL - name.length) / 2), 1, name, Screen.GREEN);\n            }\n\n            /*\n            if (Game.frame % 133 === 0) {\n                console.log('generating visions');\n                this.visions = [];\n                for (let i = 0; i < 10; i++) {\n                    this.visions.push([\n                        Math.floor(Math.random() * tiles[0].length),\n                        Math.floor(Math.random() * tiles.length),\n                        String.fromCharCode(97 + Math.floor(Math.random() * 26))\n                    ]);\n                }\n            } else if (Game.frame % 133 >= 5 && Game.frame % 133 <= 25) {\n                for (let vision of this.visions) {\n                    Screen.writeOnMap(vision[0], vision[1], vision[2], Screen.RED);\n                }\n            }\n            */\n        },\n\n        reset() {\n            // We want to be careful and CLONE (not reference) the world data, because\n            // this will be our \"working copy\" -- rooms and objects and even tiles might\n            // get updated and moved during game logic.\n            this.floors = WorldData.floors.map(floor => {\n                return {\n                    tiles: floor.tiles.map(row => [...row]),\n                    visible: floor.tiles.map(row => row.map(c => false)),\n                    objects: floor.objects.map(object => ({ id: object[0], x: object[1], y: object[2], type: object[3] })),\n                    rooms: floor.rooms.map(room => ({ id: room[0], x: room[1], y: room[2], width: room[3], height: room[4] })),\n                    triggers: floor.triggers.map(trigger => ({ ...trigger }))\n                };\n            });\n            this.bounds = WorldData.bounds;\n            this.spawn = WorldData.spawn;\n            this.strings = WorldData.strings;\n\n            for (let floor of this.floors) {\n                // \"Lift\" all objects off the floor, and get their default character\n                for (let object of floor.objects) {\n                    object.char = String.fromCharCode(floor.tiles[object.y][object.x]);\n                    floor.tiles[object.y][object.x] = World.FLOOR;\n                }\n            }\n        },\n\n        roomAt(pos) {\n            return this.floors[pos.z].rooms.find(room =>\n                pos.x >= room.x && pos.y >= room.y && pos.x < room.x + room.width && pos.y < room.y + room.height\n            );\n        },\n\n        objectAt(pos) {\n            return this.floors[pos.z].objects.find(object => object.x === pos.x && object.y === pos.y);\n        },\n\n        objectsById(id, map) {\n            let list = [];\n            for (let floor of this.floors) {\n                for (let object of floor.objects) {\n                    if (object.id === id) list.push(object);\n                }\n            }\n            return map ? list.map(map) : list;\n        },\n\n        tileAt(pos) {\n            let tiles = this.floors[pos.z].tiles;\n            if (pos.x < 0 || pos.y < 0 || pos.x >= tiles[0].length || pos.y >= tiles.length) return ' ';\n            return tiles[pos.y][pos.x];\n        },\n\n        canMoveInto(pos) {\n            let tile = this.tileAt(pos);\n            if (tile === 46 /* . */) return true;\n            return false;\n        },\n\n        colorForObject(object) {\n            if (object.finished) return Screen.DIM;\n            if (object.interacted) return Screen.YELLOW;\n            return Screen.BLUE;\n        },\n\n        colorForTile(tile) {\n            return tile === '.' ? Screen.DIM : Screen.WHITE;\n        },\n\n        makeVisible(roomId) {\n            for (let floor of this.floors) {\n                for (let room of floor.rooms) {\n                    if (room.id === roomId) {\n                        for (let y = room.y; y < room.y + room.height; y++) {\n                            for (let x = room.x; x < room.x + room.width; x++) {\n                                floor.visible[y][x] = true;\n                            }\n                        }\n                    }\n                }\n            }\n        },\n    };\n\n    // Util\n\n    function rgba(r, g, b, a) {\n        return `rgba(${r},${g},${b},${a})`;\n    }\n\n    function xyz2pos(x, y, z) {\n        return { x, y, z };\n    }\n\n    function createCanvas(width, height) {\n        let canvas = document.createElement('canvas');\n        canvas.width = width;\n        canvas.height = height;\n        let ctx = canvas.getContext('2d');\n        return { canvas, ctx };\n    }\n\n    function formatQuantity(value) {\n        return ('' + value).padStart(3, '0');\n    }\n\n    // Text\n\n    const Text = {\n        init() {\n            // We'll dynamically recolor the font sheet whenever a new rgba color is requested,\n            // then cache it for future use.\n            this.colorways = {};\n            this.colorways[''] = Font.img;\n\n            // The \"white\" font sheet, right from the sprite.\n            Text.white = Font.img;\n\n            // Recolored versions of the original font sheet, to use when constructing our glow.\n            //\n            // The color here is #33FF00 which is roughly the glow of the Kaypro II.\n            Text.terminal = recolor(Text.white, rgba(51 + 16, 255, 0 + 16, 1));\n            Text.terminal_shadow = recolor(Text.white, rgba(51, 255, 0, 0.4));\n        },\n\n        drawText(ctx, text, u, v, color = '') {\n            //console.log(text, color);\n            if (typeof text === 'number') text = String.fromCharCode(text);\n            let scale = 1;\n            let font = this.colorways[color];\n            if (!font) {\n                this.colorways[color] = font = recolor(Font.img, color);\n            }\n\n            if (Array.isArray(text)) {\n                for (let block of text) {\n                    Text.drawText(ctx, block.text, u + block.u * scale, v + block.v * scale, font, scale);\n                }\n                return;\n            }\n\n            for (let idx = 0; idx < text.length; idx++) {\n                let c = text.charCodeAt(idx);\n                let k = (c - 0) * FONT_WIDTH;\n                let drawable = (c !== 32);\n\n                // We clear the canvas in every frame, and it's a HUGE speed advantage not to draw an\n                // empty image (this check can save 1000+ drawImage calls a frame).\n                if (drawable) {\n                    ctx.drawImage(\n                        font,\n                        (k * scale) % font.width,\n                        Math.floor((k * scale) / (font.width)) * FONT_HEIGHT * scale,\n                        FONT_WIDTH * scale,\n                        FONT_HEIGHT * scale,\n                        u ,\n                        v,\n                        FONT_WIDTH * scale,\n                        FONT_HEIGHT * scale\n                    );\n                }\n                u += FONT_WIDTH * scale;\n            }\n        },\n\n        measureWidth(text, scale = 1) {\n            return text.split('').reduce((sum, c) => sum + FONT_WIDTH, 0) * scale;\n        },\n\n        splitParagraph(text, w, h) {\n            let cu = 0, cv = 0;\n            let next = () => ({ text: '', u: cu, v: cv });\n            let wip = next();\n            let list = [];\n\n            for (let c of text.split('')) {\n                let cWidth = Text.measureWidth(c, 1);\n                if (c === '\\n' || cu + cWidth > w) {\n                    let saved = '';\n                    if (c !== '\\n' && c !== ' ') {\n                        let space = wip.text.split(' ');\n                        if (space.length > 1) {\n                            saved = space.pop();\n                            wip.text = space.join(' ');\n                        }\n                    }\n                    if (wip.text.length > 0) list.push(wip);\n                    cu = 0;\n                    cv += FONT_HEIGHT;\n                    wip = next();\n                    if (saved.length > 0) {\n                        wip.text = saved;\n                        cu += Text.measureWidth(wip.text, 1);\n                    }\n                } else {\n                    cu += cWidth;\n                }\n                if (c !== '\\n') {\n                    wip.text = wip.text + c;\n                }\n            }\n\n            if (wip.text.length > 0) list.push(wip);\n\n            return list.map(line => ({\n                ...line,\n                w: Text.measureWidth(line.text, 1),\n                h: FONT_HEIGHT\n            }));\n        }\n    };\n\n    // Text utility functions, for manipulating the font sheet images\n\n    function recolor(font, color) {\n        let canvas = createCanvas(font.width, font.height);\n        canvas.ctx.fillStyle = color;\n        canvas.ctx.fillRect(0, 0, font.width, font.height);\n        canvas.ctx.globalCompositeOperation = 'destination-in';\n        canvas.ctx.drawImage(font, 0, 0);\n\n        return canvas.canvas;\n    }\n\n    /**\n     * `Screen` is a singleton that represents the virtual 80x25 character screen our game\n     * lives in. Components like PlayingField will \"draw\" (write text onto) this virtual\n     * screen each frame. Once all the text is written, the text will end up rendered on\n     * the viewport (canvas) in the browser.\n     */\n\n    const Screen = {\n        // Terminal color codes\n        DIM:     0x00,\n        RED:     0x01,\n        GREEN:   0x02,\n        YELLOW:  0x03,\n        BLUE:    0x04,\n        MAGENTA: 0x05,\n        CYAN:    0x06,\n        WHITE:   0x07,\n        BRIGHT:  0x08,\n\n        // Useful character codes\n        SPACE:   0x20,\n\n        init() {\n            this.screen = [];\n            this.smudge = 5;\n            this.clear();\n\n            // Terminal color names to hex color mappings\n            Screen.COLORS = {\n                [Screen.DIM]:                   rgba(144, 144, 144, 1),\n                [Screen.RED]:                   rgba(214, 69,  46,  1),\n                [Screen.GREEN]:                 rgba(151, 216, 122, 1),\n                [Screen.YELLOW]:                rgba(238, 212, 83,  1),\n                [Screen.BLUE]:                  rgba(70,  151, 226, 1),\n                [Screen.WHITE]:                 rgba(214, 214, 214, 1),\n                [Screen.WHITE | Screen.BRIGHT]: rgba(255, 255, 255, 1)\n            };\n        },\n\n        clear(startX = 0, startY = 0, width = SCREEN_WIDTH, height = SCREEN_HEIGHT) {\n            for (let y = startY; y < startY + height; y++) {\n                for (let x = startX; x < startX + width; x++) {\n                    this.screen[y * SCREEN_WIDTH + x] = Screen.SPACE | (Screen.WHITE << 8);\n                }\n            }\n        },\n\n        write(x, y, text, color = Screen.WHITE, x2 = SCREEN_WIDTH) {\n            if (typeof text !== 'string') throw new Error('string');\n            //if (color === undefined) color = Screen.WHITE;\n\n            let ox = x;\n\n            for (let i = 0; i < text.length; i++) {\n                let c = text.charCodeAt(i);\n\n                if (text[i] === '\\n') {\n                    x = ox;\n                    y++;\n                    continue;\n                }\n\n                if (text[i] === '%') {\n                    switch (text[++i]) {\n                        case 'd':\n                            color = Screen.DIM;\n                            continue;\n                        case 'r':\n                            color = Screen.RED;\n                            continue;\n                        case 'g':\n                            color = Screen.GREEN;\n                            continue;\n                        case 'b':\n                            color = Screen.BLUE;\n                            continue;\n                        case 'y':\n                            color = Screen.YELLOW;\n                            continue;\n                        case 'w':\n                            color = Screen.WHITE;\n                            continue;\n                        case 'W':\n                            color = Screen.WHITE | Screen.BRIGHT;\n                            continue;\n                        case '0':\n                            c = 0xa5;\n                            break;\n                        case '1':\n                            c = 0xa4;\n                            break;\n                        default:\n                            i--;\n                    }\n                }\n\n                this.screen[y * SCREEN_WIDTH + x] = c | (color << 8);\n                x++;\n                if (x >= x2) {\n                    x = ox;\n                    y++;\n                }\n            }\n        },\n\n        writeTypewriter(x, y, text, maxlen) {\n            if (maxlen > 0) {\n                text = text.slice(0, maxlen | 0);\n                this.write(x, y, text);\n            }\n        },\n\n        writeOnMap(x, y, text, color, x2) {\n            let offset = {\n                x: 32 - Camera.pos.x,\n                y : 12 - Camera.pos.y\n            };\n\n            this.write(x + offset.x, y + offset.y, text, color, x2);\n        },\n\n        writeBox(x, y, w, h, color) {\n            if (w > 2 && h > 2) {\n                Screen.clear(x + 1, y + 1, w - 2, h - 2);\n            }\n            this.write(x, y, `\\x95${'\\x91'.repeat(w - 2)}\\x96`, color);\n            this.write(x, y + h - 1, `\\x94${'\\x91'.repeat(w - 2)}\\x93`, color);\n            for (let i = y + 1; i < y + h - 1; i++) {\n                this.write(x, i, '\\x90', color);\n                this.write(x + w - 1, i, '\\x90', color);\n            }\n        },\n\n        draw(ctx) {\n            if (Game.frame % FLICKER_FRAME_2 > 0) {\n                for (let y = 0; y < SCREEN_HEIGHT; y++) {\n                    for (let x = 0; x < SCREEN_WIDTH; x++) {\n                        let c = this.screen[y * SCREEN_WIDTH + x];\n                        let c2 = (c & 0xFF);\n                        if (c2 !== 32 && c2 < 128) c2 += this.smudge;\n                        Text.drawText(ctx, c2, x * FONT_WIDTH, y * FONT_HEIGHT, Screen.COLORS[c >> 8]);\n                    }\n                }\n            }\n        }\n    };\n\n    // Log\n\n    const Log = {\n        init() {\n            this.entries = [];\n        },\n\n        add(message, formatCode = '') {\n            console.log(message);\n            if (message[0] !== '%') {\n                message = formatCode + '\\xa5 ' + message;\n            }\n\n            this.entries.push(message.split('\\n'));\n\n            // In a real game, you'd definitely want some kind of normalized line-splitting\n            // going on here... but for JS13k, I just have carefully crafted every string in\n            // world.yaml to fit into the appropriate spaces (either the log/description\n            // area, or the inventory description area).\n\n            // For a while, I was trying to do the whole\n            /*let array = [];\n\n            while (message.length > LOG_WIDTH) {\n                array.push(message.slice(0, LOG_WIDTH));\n                message = message.slice(LOG_WIDTH);\n            }\n            if (message.length > 0) array.push(message);\n            this.entries.push(array);*/\n        },\n\n        obtainedItem(id) {\n            Log.add(`%y%0 You have obtained ${World.strings[id][0]}.`);\n        },\n\n        draw(lines = 3) {\n            let boxHeight = lines + 2;\n            let boxStart = 22 - lines;\n            let temporaryBlanks = 0;\n\n            if (this.entries[this.entries.length - 1].length < 3)\n                temporaryBlanks = 3 - this.entries[this.entries.length - 1].length;\n            let display = this.entries.flat();\n            while (temporaryBlanks-- > 0) display.push('');\n            if (display.length > lines) {\n                display = display.slice(display.length - lines);\n            }\n\n            Screen.writeBox(0, boxStart, 80, boxHeight, Screen.DIM);\n            Screen.write(STATUS_COL, boxStart, '\\x98', Screen.DIM);\n\n            for (let i = 0; i < display.length; i++) {\n                Screen.write(2, boxStart + i + 1, display[i]);\n            }\n        }\n    };\n\n    // LogScreen\n\n    class LogScreen {\n        constructor() {\n            this.lines = LOG_CLOSED_LINES;\n            this.offset = 0;\n        }\n\n        update() {\n            if (Input.pressed[Input.Action.BACK] || Input.pressed[Input.Action.LOG]) {\n                this.closing = true;\n            }\n\n            if (this.closing) {\n                this.lines -= 2;\n                if (this.lines <= LOG_CLOSED_LINES) {\n                    this.cull = true;\n                    return;\n                }\n            } else {\n                if (this.lines < LOG_OPEN_LINES) this.lines += 2;\n\n                if (Input.pressed[Input.Action.UP]) {\n                    this.offset++;\n                } else if (Input.pressed[Input.Action.DOWN]) {\n                    this.offset--;\n                }\n            }\n\n            this.offset = Math.min(this.offset, 0);\n            this.offset = Math.max(this.offset, Log.entries.flat().length - this.lines);\n        }\n\n        draw() {\n            Screen.clear(0, SCREEN_HEIGHT - this.lines - 1, SCREEN_WIDTH, this.lines + 2);\n            Log.draw(this.lines, this.offset);\n        }\n    }\n\n    // HelpScreen\n\n    class HelpScreen {\n        constructor() {\n            this.expand = 2;\n        }\n\n        update() {\n            if (Input.pressed[Input.Action.BACK] || Input.pressed[Input.Action.HELP]) {\n                this.closing = true;\n            }\n\n            if (this.closing) {\n                this.expand -= 2;\n                if (this.expand === 2) {\n                    this.cull = true;\n                    return;\n                }\n            } else {\n                if (this.expand < 22) this.expand += 2;\n            }\n        }\n\n        draw() {\n            const help = `                                  %gHELP\n\n%gCONTROLS\n  %W\\xa0\\xa1\\xa2\\xa3    %wMove / Investigate / Attack\n  %WI       %wOpen inventory\n  %WL       %wExpand logbook\n  %WH       %wToggle help (this screen)\n\n%gMAP LEGEND\n  %W@       %wYou\n  %d.       %wEmpty floors\n  %w\\x80\\x81      %wWalls\n  %b|- %d'    %wDoors (%bclosed%w / %dopen%w)\n  %b< >     %wStairways (up / down)\n\n  %b&!      %wBlue objects can be investigated\n  %y%#      %wYellow objects may need to be revisited later\n  %d=$      %wGray objects have already been investigated\n\n  %rsfVH    %wRed letters are foes`;\n\n            Screen.writeBox(2, 12 - Math.floor(this.expand / 2), 76, this.expand, Screen.GREEN);\n            Screen.write(4, 13 - Math.floor(this.expand / 2), help.split('\\n').slice(0, this.expand).join('\\n'));\n        }\n    }\n\n    // InventoryScreen\n\n    class InventoryScreen {\n        constructor(object) {\n            this.object = object;\n            this.expand = 2;\n            this.selected = 0;\n            this.list = Game.player.inventory;\n        }\n\n        update() {\n            console.log(['update', Input.pressed[Input.Action.DOWN]]);\n            if (Input.pressed[Input.Action.BACK]) {\n                this.closing = true;\n            } else if (Input.pressed[Input.Action.INVENTORY] && !this.object) {\n                this.closing = true;\n            } else if (Input.pressed[Input.Action.DOWN]) {\n                this.selected = (this.selected + 1) % this.list.length;\n            } else if (Input.pressed[Input.Action.UP]) {\n                this.selected = (this.selected + this.list.length - 1) % this.list.length;\n            } else if (Input.pressed[Input.Action.SELECT] && this.object) {\n                this.closing = true;\n                Game.player.useItemOn(this.object, this.list[this.selected]);\n            }\n\n            if (this.closing) {\n                this.cull = true;\n            }\n        }\n\n        draw() {\n            Screen.writeBox(5, 6, 71, 10, Screen.GREEN);\n            Screen.write(38, 6, '\\x97', Screen.GREEN);\n            Screen.write(38, 15, '\\x98', Screen.GREEN);\n            for (let y = 7; y < 15; y++) {\n                Screen.write(38, y, '\\x90', Screen.GREEN);\n            }\n\n            for (let idx = 0; idx < this.list.length; idx++) {\n                let [name, description] = World.strings[this.list[idx]];\n                if (idx === this.selected) {\n                    Screen.write(6, 7 + idx, `%0${name.padEnd(30)}%1`, Screen.GREEN);\n                    Screen.write(40, 7, description);\n                } else {\n                    Screen.write(7, 7 + idx, name);\n                }\n            }\n            if (this.object) {\n                Screen.write(6, 14, '[\\xa0\\xa1\\xa2\\xa3ENTER] Use item  [ESC] Back', Screen.DIM);\n            } else {\n                Screen.write(6, 14, '[\\xa0\\xa1\\xa2\\xa3] Examine item   [ESC] Back', Screen.DIM);\n            }\n        }\n    }\n\n    // Player\n\n    class Player {\n        constructor(pos) {\n            this.pos = { ...pos };\n\n            this.lookingAt = this.room;\n            this.inventory = [];\n\n\n            this.speed = 4;\n            this.hp = this.hpMax = 100;\n            this.sp = this.spMax = 100;\n\n            // *COMBAT*\n            // this.vigor = 8;\n            // this.insight = 12;\n            // this.will = 10;\n            // this.updateStats();\n            // this.weapon = { ar: 0.5 };\n            // this.df = flood(this.pos);\n\n            // The player starts with the uncle's letter.\n            this.obtainItem($I_UNCLE_LETTER);\n\n            // The foyer door is locked.\n            World.objectsById($D_FOYER, object => object.finished = true);\n\n            // The player is in the foyer (starting room).\n            this.room = World.roomAt(this.pos);\n            Log.add(World.strings[this.room.id][1]);\n            World.makeVisible(this.room.id);\n\n            // Temporary hack stuff\n            this.obtainItem($I_IRON_KNIFE);\n            this.obtainItem($I_BURNT_NOTEBOOK);\n\n        }\n\n        draw() {\n            Screen.writeOnMap(this.pos.x, this.pos.y, '@', Screen.WHITE | Screen.BRIGHT);\n        }\n\n        update() {\n            let move;\n\n            console.log(Input.held[Input.Action.LEFT], Input.framesHeld[Input.Action.LEFT]);\n            if (Input.held[Input.Action.LEFT] && Input.framesHeld[Input.Action.LEFT] % TURN_FRAMES === 1) {\n                move = { ...this.pos, x: this.pos.x - 1 };\n            } else if (Input.held[Input.Action.RIGHT] && Input.framesHeld[Input.Action.RIGHT] % TURN_FRAMES === 1) {\n                move = { ...this.pos, x: this.pos.x + 1 };\n            } else if (Input.held[Input.Action.UP] && Input.framesHeld[Input.Action.UP] % TURN_FRAMES === 1) {\n                move = { ...this.pos, y: this.pos.y - 1 };\n            } else if (Input.held[Input.Action.DOWN] && Input.framesHeld[Input.Action.DOWN] % TURN_FRAMES === 1) {\n                move = { ...this.pos, y: this.pos.y + 1 };\n            }\n\n            if (move) {\n                this.interactWith(move);\n            }\n            return !!move;\n        }\n\n        interactWith(pos) {\n            let tile = World.tileAt(pos);\n            let object = World.objectAt(pos);\n            let entity = Game.entityAt(pos);\n\n            if (entity) ; else if (object) {\n                if (object.open) {\n                    this.moveInto(pos, false);\n                } else if (object.finished) {\n                    this.lookingAt = object;\n                    Log.add(World.strings[object.id]);\n                    console.log('finished' + World.strings[object.id]);\n                } else {\n                    /**** SPECIAL OBJECTS ****/\n                    if (object.id === $D_DINING) {\n                        Log.add(World.strings[object.id]);\n                        if (object.interacted) {\n                            this.openInventoryFor(object);\n                        }\n                    } else if (object.id === $D_DRAW) {\n                        this.openDoor(object);\n                        World.makeVisible($R_DRAW);\n                    } else if (object.id === $D_KITCHEN) {\n                        Log.add(World.strings[object.id]);\n                    } else if (object.id === $D_GARAGE) {\n                        this.openDoor(object);\n                        World.makeVisible($R_GARAGE);\n                    } else if (object.id === $D_HALLWAY) {\n                        this.openDoor(object);\n                        World.makeVisible($R_HALLWAY);\n                    } else if (object.id === $F_BURNT_CHAIR) {\n                        Log.add(World.strings[object.id]);\n                        object.id = $F_BURNT_CHAIR_A;\n                    } else if (object.id === $F_BURNT_CHAIR_A) {\n                        object.finished = true;\n                        Log.obtainedItem($I_BURNT_NOTEBOOK);\n                        this.obtainItem($I_BURNT_NOTEBOOK);\n                    } else if (object.id === $F_FIRE3) {\n                        Log.add(World.strings[object.id]);\n                        object.id = $F_FIRE3_A;\n                    } else if (object.id === $F_FIRE3_A) {\n                        Log.add(World.strings[object.id]);\n                        object.id = $F_FIRE3_B;\n                        this.obtainItem($I_IRON_KNIFE);\n                    } else if (object.id === $F_SHELF1) {\n                        Log.add(World.strings[object.id]);\n                        object.finished = true;\n                        this.obtainItem($I_SILVER_KEY);\n                    } else if (object.id === $F_SHELF2) {\n                        Log.add(World.strings[object.id]);\n                        object.finished = true;\n                    } else if (object.id === $F_SHELF3) {\n                        Log.add(World.strings[object.id]);\n                        object.id = $F_SHELF3_A;\n                    } else if (object.id === $F_SHELF3_A) {\n                        object.finished = true;\n                        Log.obtainedItem($I_DOLL_WORKBENCH);\n                        this.obtainItem($I_DOLL_WORKBENCH);\n                    } else if (object.id === $F_STATUE) {\n                        Log.add(World.strings[object.id]);\n                        object.id = $F_STATUE_A;\n                    } else if (object.id === $F_STATUE_A) {\n                        Log.add(World.strings[object.id]);\n                        object.id = $F_STATUE_B;\n                        object.finished = true;\n                        this.obtainItem($I_IRON_KNIFE);\n                    } else if (object.id === $F_STAIR1) {\n                        Log.add(World.strings[object.id]);\n                        object.finished = true;\n                    } else if (object.type === TYPE_DOOR) {\n                        this.openDoor(object);\n                    } else {\n                        let action = '';\n                        if (object.action) {\n                            action = `\\n${object.action}`;\n                        } else if (object.interacted) {\n                            action = `\\n%y\\xa5 You need some kind of other item.`;\n                        }\n                        this.lookingAt = object;\n                        console.log(object.id);\n                        console.log(World.strings[object.id] + action);\n                        Log.add(World.strings[object.id] + action);\n                        console.log('else statement' + World.strings[object.id]);\n                    }\n                }\n\n                object.interacted = true;\n            } else if (tile === World.FLOOR) {\n                this.moveInto(pos, true);\n            } else {\n                console.log('No.');\n            }\n        }\n\n        moveInto(pos, updateRoom) {\n            this.pos = pos;\n            //this.df = flood(this.pos);\n            if (updateRoom) {\n                // This is a cheap, easy way to make doors part of \"both rooms\" - when you step\n                // between rooms, the current room description doesn't update until you walk\n                // past the doorway.\n                let room = World.roomAt(this.pos);\n                if (this.room !== room) {\n                    Log.add(World.strings[room.id][1]);\n                }\n                this.room = room;\n                this.lookingAt = this.room;\n            }\n        }\n\n        openInventoryFor(object) {\n            Game.screens.push(new InventoryScreen(object));\n        }\n\n        useItemOn(object, item) {\n            if (object.id === $D_DINING) {\n                if (item === $I_IRON_KNIFE) {\n                    this.openDoor(object, $D_DINING_OPEN);\n                    World.makeVisible($R_DINING);\n                } else {\n                    Log.add(`That doesn't work here.`, '%y');\n                }\n            }\n            console.log('oh fuck, i am using ' + object + item);\n        }\n\n        hasItem(id) {\n            return this.inventory.includes(id);\n        }\n\n        obtainItem(id) {\n            this.inventory.push(id);\n        }\n\n        openDoor(object, stringId) {\n            if (stringId) {\n                Log.add(World.strings[stringId]);\n            } else {\n                Log.add('You push the door open.', '%y');\n            }\n            object.open = object.finished = true;\n            object.char = object.char === '|' ? `'` : '\\x7f';\n        }\n\n        // *COMBAT*\n        /*\n        attack(entity) {\n            let roll = CombatSystem.rollAttack(this.vigor, this.weapon.ar);\n            if (roll.result === CombatSystem.WHIFF) {\n                Log.add('%YYou slash at the swamp rat, but miss.');\n            } else if (roll.result === CombatSystem.HIT) {\n                Log.add(`%YYou slash the ${CombatSystem.formatActeeName(entity)}, dealing ${roll.value} damage.`);\n            } else if (roll.result === CombatSystem.CRIT) {\n                Log.add(`%YFocus! You slash the ${CombatSystem.formatActeeName(entity)}, dealing ${roll.value} damage.`);\n            }\n            Game.entities.push(new WorldParticle(entity.pos, [['/', Screen.YELLOW], ['*', Screen.YELLOW]]));\n            Game.entities.push(new WorldParticle(Game.player.pos, [['@', Screen.YELLOW]]));\n        }\n\n        updateStats() {\n            this.lvl = this.vigor + this.insight + this.will;\n\n            let hpMax = this.vigor * 10 + this.lvl - 10;\n\n            if (hpMax > this.hpMax) {\n                this.hpMax = hpMax;\n                this.hp += (hpMax - this.hpMax);\n            }\n\n            let spMax = this.will * 10 + this.lvl - 30;\n\n            if (spMax > this.spMax) {\n                this.spMax = spMax;\n                this.sp += (spMax - this.spMax);\n            }\n        }\n        */\n    }\n\n    // TurnSystem\n\n    const TurnSystem = {\n        takeEntityTurns() {\n            const entities = [...Game.entities];\n\n            if (!Game.player.tp) Game.player.tp = 0;\n\n            if (Game.player.tp >= Game.player.speed) {\n                // All entities are \"paused\" until the player takes a turn.\n                let turnTaken = Game.player.update();\n\n                if (turnTaken) {\n                    Game.player.tp -= Game.player.speed;\n                }\n\n                // Entities with no speed are frame-based instead of turn-based. (For\n                // example, most spawned particles, which are also entities.)\n                for (let entity of entities) {\n                    if (!entity.speed) entity.update();\n                }\n            } else {\n                for (let entity of entities) {\n                    entity.tp = (entity.tp || 0) + 1;\n\n                    while (entity.tp >= entity.speed && entity !== Game.player) {\n                        entity.update();\n                        entity.tp -= entity.speed;\n                    }\n                }\n            }\n\n            //console.log(Game.entities.map(x => x.tp));\n        }\n    };\n\n    // Viewport\n\n    /**\n     * Viewport is a global object representing the playable pixel area of our game.\n     */\n    const Viewport = {\n        init() {\n            Viewport.canvas = document.getElementById('canvas');\n            Viewport.ctx = Viewport.canvas.getContext('2d');\n            Viewport.resize(true);\n        },\n\n        // Resize the canvas to give us approximately our desired game display size.\n        //\n        // Rather than attempt to explain it, here's a concrete example:\n        //\n        //     we start with a desired game dimension:   480x270px\n        //          get the actual browser dimensions:  1309x468px\n        //          factor in the display's DPI ratio:  2618x936px\n        //         now calculate the horizontal scale:       5.45x\n        //                     and the vertical scale:       3.46x\n        //            our new offical game scaling is:        5.4x\n        //       and our official viewport dimensions:   484x173px\n        //\n        // This approach emphasizes correct aspect ratio and maintains full-window rendering, at\n        // the potential cost of limiting visibility of the game itself in either the X or Y axis.\n        // If you use this approach, make sure your GUI can \"float\" (otherwise there may be whole\n        // UI elements the player cannot see!).\n        resize(force) {\n            let dpi = window.devicePixelRatio,\n                width = Viewport.canvas.clientWidth,\n                height = Viewport.canvas.clientHeight,\n                dpiWidth = width * dpi,\n                dpiHeight = height * dpi;\n\n            if (force || Viewport.canvas.width !== dpiWidth || Viewport.canvas.height !== dpiHeight) {\n                Viewport.canvas.width = dpiWidth;\n                Viewport.canvas.height = dpiHeight;\n\n                Viewport.scale = ((Math.min(dpiWidth / GAME_WIDTH, dpiHeight / GAME_HEIGHT) * 10) | 0) / 10;\n                Viewport.width = Math.ceil(dpiWidth / Viewport.scale);\n                Viewport.height = Math.ceil(dpiHeight / Viewport.scale);\n                Viewport.center = {\n                    u: (Viewport.width / 2) | 0,\n                    v: (Viewport.height / 2) | 0\n                };\n                Viewport.clientWidth = width;\n                Viewport.clientHeight = height;\n\n                // Note: smoothing flag gets reset on every resize by some browsers, which is why\n                // we do it here.\n                Viewport.ctx.imageSmoothingEnabled = false;\n            }\n\n            // We do this every frame, not just on resize, due to browser sometimes \"forgetting\".\n            Viewport.canvas.style.cursor = 'not-allowed';\n        }\n    };\n\n    // WelcomeScreen\n\n    class WelcomeScreen {\n        constructor() {\n            this.expand = 2;\n            Screen.smudge = 26;\n        }\n\n        update() {\n            // Weird hack here because AudioContext constructor eats up a frame\n            // about half the time... I should fix it properly but this hack\n            // works for now.\n            if (Input.pressed[Input.Action.SELECT] || Audio.initialized) {\n                this.closing = true;\n            }\n\n            if (this.closing) {\n                this.cull = true;\n                Screen.smudge = 8;\n            }\n        }\n\n        draw() {\n            let welcome = `                     %gSHADOW OF THE KEENING STAR\n\n%wFor some reason, you just couldn't ignore that letter. It was wrong,\nsomehow - although estranged, you remember your uncle, and he never\nwrote like that.\n\nSo here you are, an hour southeast of Boston, still clutching your\nuncle's letter and standing in front of a weather-beaten colonial.\n\nThe creak of the front door echoes in your ears as you step into the\nhouse...\n\n%d[ENTER] Begin`;\n\n            /*welcome = welcome.split('').map(c => {\n                let code = c.charCodeAt(0);\n                if (c === 'g' || c === 'w' || c === 'd') return c;\n                if (code >= 48 && code <= 122) return String.fromCharCode(code + this.shift);\n                return c;\n            }).join('');*/\n\n            Screen.clear();\n            Screen.writeBox(4, 4, 72, 15, Screen.GREEN);\n            Screen.write(6, 5, welcome);\n        }\n    }\n\n    // Game\n\n    const Game = {\n        async init() {\n            // Initialize game components\n            await Font.init();\n            Viewport.init();\n            Screen.init();\n            Text.init();\n            Input.init();\n            World.init();\n            Log.init();\n\n            // Initial state values\n            this.frame = 0;\n            this.entities = [];\n\n            this.player = new Player(xyz2pos(...World.spawn));\n            this.entities.push(this.player);\n\n            this.screens = [];\n\n            this.screens.push(new WelcomeScreen());\n\n            Camera.init();\n\n            // Kick off game loop\n            window.requestAnimationFrame(() => this.onFrame());\n        },\n\n        onFrame() {\n            let now = new Date().getTime();\n            let lastFrame = this.lastFrame || 0;\n\n            // Note: `requestAnimationFrame` will usually call our handler 60 times per second,\n            // but it can be higher or lower (lower if the game is lagging, higher if the user's\n            // refresh settings are modified -- it can be 120Hz for example).\n            //\n            // It's safest to explicitly limit the number of frame updates to 60 per second.\n            if (now - lastFrame >= 1000 / FPS) {\n                this.frame++;\n                this.update();\n                this.lastFrame = now;\n\n                Viewport.resize();\n                this.draw();\n            }\n\n            window.requestAnimationFrame(() => this.onFrame());\n\n            //Triggers.arm('TRAT1');\n        },\n\n        update() {\n            Input.update();\n\n            //console.log([Input.pressed[Input.Action.LOG],Input.Action.LOG,Input.held[Input.Action.LOG]]);\n            if (this.screens.length > 0) {\n                this.screens[this.screens.length - 1].update();\n                this.screens = this.screens.filter(screen => !screen.cull);\n            } else if (Input.pressed[Input.Action.LOG]) {\n                //console.log('MAKING A NEW SCREEN');\n                this.screens.push(new LogScreen());\n            } else if (Input.pressed[Input.Action.HELP]) {\n                //console.log('help screen');\n                this.screens.push(new HelpScreen());\n            } else if (Input.pressed[Input.Action.INVENTORY]) {\n                this.screens.push(new InventoryScreen());\n                console.log('inv');\n            } else {\n                TurnSystem.takeEntityTurns();\n            }\n\n            Camera.update();\n\n            //Triggers.update();\n\n            // Discard any entites marked for culling at the end of the update step. They will not\n            // be drawn this frame (so, setting \"cull\" should happen AFTER the last frame of a given\n            // enemy or particle has been drawn).\n            Game.entities = Game.entities.filter(entity => !entity.cull);\n\n            if (Screen.smudge > 0) Screen.smudge--;\n        },\n\n        draw() {\n            // Reset canvas transform and scale\n            Viewport.ctx.setTransform(Viewport.scale, 0, 0, Viewport.scale, 0, 0);\n\n            // Clear canvas\n            Viewport.ctx.fillStyle = '#121212';\n            Viewport.ctx.fillRect(0, 0, Viewport.width, Viewport.height);\n\n            // Center our ASCII \"screen\" in the viewport\n            Viewport.ctx.translate((Viewport.width - GAME_WIDTH) / 2 | 0, (Viewport.height - GAME_HEIGHT) / 2 | 0);\n\n            Screen.clear();\n\n            //Screen.write(3, 3, 'hello world');\n\n            //Screen.write(0, 0, '/--------------------------------------\\\\');\n            //Screen.write(2, 10, 'You are standing in a cramped drawing room.');\n\n            //Screen.write(0, 0, '#');\n            //Screen.write(79, 0, '#');\n            //Screen.write(0, 23, '#');\n            //Screen.write(79, 23, '#');\n\n            for (let i = 0; i < Math.min(20, this.frame / 3); i++) {\n                Screen.write(64, i, '\\x90', Screen.DIM);\n            }\n\n            //Screen.write(0, 19, '\\x91'.repeat(80));\n\n            Screen.writeTypewriter(\n                66, 1,\n                `Health ${formatQuantity(Game.player.hp)}/${formatQuantity(Game.player.hpMax)}`,\n                this.frame / 2\n            );\n            Screen.writeTypewriter(\n                66, 2,\n                `Sanity ${formatQuantity(Game.player.sp)}/${formatQuantity(Game.player.spMax)}`,\n                (this.frame / 2) - 10\n            );\n\n            //Screen.write(66, 4, `Vigor   ${formatStat(Game.player.vigor)}`);\n            //Screen.write(66, 5, `Insight ${formatStat(Game.player.insight)}`);\n            //Screen.write(66, 6, `Will    ${formatStat(Game.player.will)}`);\n            //Screen.write(66, 7, `Speed   ${formatStat(Game.player.speed)}`);\n\n    /*\n            Screen.write(0, 19, '#'.repeat(60));\n            Screen.write(0, 20, 'Here is something.');\n            Screen.write(0, 21, 'Here is something.');\n            Screen.write(3, 22, 'Here is some kind of something.');\n            Screen.write(4, 21, '#'.repeat(60));\n            Screen.write(5, 18, '#'.repeat(60));\n    */\n            World.draw();\n\n            // A simplistic 3-layer z-order system. We can always be more advanced\n            // and actually sort by z later!\n            for (let entity of this.entities) {\n                if (entity.z < 0) entity.draw();\n            }\n            for (let entity of this.entities) {\n                if (!entity.z) entity.draw();\n            }\n            for (let entity of this.entities) {\n                if (entity.z > 0) entity.draw();\n            }\n\n            if (this.frame > 60) {\n                Screen.write(66, 18, '[H] Help', Screen.DIM);\n                Log.draw(3);\n            }\n\n            for (let screen of this.screens) {\n                screen.draw();\n            }\n\n            Screen.draw(Viewport.ctx);\n        },\n\n        entityAt(pos) {\n            return this.entities.find(entity => {\n                let found = (entity.pos.x === pos.x) && (entity.pos.y === pos.y) && (entity.pos.z === pos.z);\n                return found;\n            });\n        },\n    };\n\n    // index\n\n    Game.init();\n\n}());\n//# sourceMappingURL=app.js.map\n","// Camera\n//\n// For now this is a very simple placeholder. Even if the camera never does\n// anything but follow the player, distinguishing between \"where the player is\"\n// and \"what the map camera is looking at\" is useful in other files.\n\nimport { Game } from './Game';\n\nexport const Camera = {\n    init() {\n        this.pos = { x: 0, y: 0, z: 0 };\n    },\n\n    update() {\n        this.pos = Game.player.pos;\n    }\n};\n","// Constants\n//\n// Where possible, global values are all kept here in spot for easy tweaking.\n// Don't worry about constant length -- our terser configuration in the build step\n// is going to mangle all of our constants into tiny variable names.\n\n// The \"screen area\", in ASCII characters.\nexport const SCREEN_WIDTH = 80;\nexport const SCREEN_HEIGHT = 24;\n\n// The size in pixels of each character in our monospaced font.\nexport const FONT_WIDTH = 8;\nexport const FONT_HEIGHT = 16;\n\n// The number of rows/columns of characters in the font sheet.\nexport const FONT_COLS = 16;\nexport const FONT_ROWS = 16;\n\n// Screen scaling -- currently not used.\nexport const SCREEN_SCALE = 1;\n\n// Playable area in pixels. Note that actual on-screen dimensions may differ to maintain\n// aspect ratio -- see `Viewport.width` & `Viewport.height`.\n//\n// We add a little bit of padding to make sure we don't draw a character right on top of\n// of the edge of the user's browser window.\nexport const GAME_WIDTH = (SCREEN_WIDTH + 1) * FONT_WIDTH * SCREEN_SCALE;\nexport const GAME_HEIGHT = (SCREEN_HEIGHT + 1) * FONT_HEIGHT * SCREEN_SCALE;\n\n// Global frames per second\nexport const FPS = 60;\n\n// How many frames does a turn take? This game is essentially turn-based (enemies don't\n// move unless the player moves). So this value really boils down to how fast the player\n// moves if they hold down an arrow key.\n//\n// 12 frames = 5 tiles per second.\nexport const TURN_FRAMES = 2;\n\n// The number of lines of recent history to show to the player, in the normal (closed)\n// case and the open (reviewing history) case.\nexport const LOG_CLOSED_LINES = 3;\nexport const LOG_OPEN_LINES = 15;\n\n// Horizontal column for the divider between map and status area.\nexport const STATUS_COL = 64;\n\n// Crit\nexport const COMBAT_WHIFF = 1;\nexport const COMBAT_HIT = 2;\nexport const COMBAT_CRIT = 3;\nexport const COMBAT_CRIT_MULTIPLIER = 1.5;\n\n// Object types\nexport const TYPE_DOOR = 2;\n\n// Screen flickers\nexport const FLICKER_FRAME_1 = 169;\nexport const FLICKER_FRAME_2 = 221;\n","// Font\n//\n// This file is generated by `gulp buildAssets`.\n\nexport const Font = {\n    async init() {\n        await new Promise(resolve => {\n            let image = new Image();\n            image.onload = resolve;\n            image.src = Font.data.uri;\n            Font.img = image;\n        });\n    },\n    data:\n/* <generated> */\n{ uri:\n   'data:image/png;base64,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' }\n/* </generated> */\n};\n","const FX_NO_EFFECT = 0;\nconst FX_SLIDE = 1;\nconst FX_VIBRATO = 2;\nconst FX_DROP = 3;\nconst FX_FADE_IN = 4;\nconst FX_FADE_OUT = 5;\nconst FX_ARP_FAST = 6;\nconst FX_ARP_SLOW = 7;\nconst SAMPLE_RATE = 44100;\nconst BASE_SPEED = 120;\n\n/**\n * Creates a new PICO-8 AudioCart using the \"sfx\" and \"music\" data from\n * a cartridge file.\n * @param {string} sfx\n * @param {string} music\n * @param {object} options\n */\nexport function AudioCart({ sfx, music }, options = {}) {\n  // Note: some browsers don't allow creation of an AudioContext unless you're inside\n  // a user-triggered event, like a mouse click or keypress. One way to control this\n  // is to initialize the AudioCart from a user-triggered event.\n  //\n  // (If you have multiple AudioCarts, you can choose to share an AudioContext by\n  // creating it yourself and passing it into each AudioCart in the options section.)\n  const audioCtx = options.audioCtx || new AudioContext();\n\n  // Each \"line\" of sfx and music represents one of the 64 allowed patterns in PICO-8.\n  // Note that sfx data contains a lot of \"nybbles\" (a single hex character, i.e., 4\n  // bits out of an 8-bit byte), which means the obvious improvement of breaking up\n  // each byte into integers isn't quite that simple.\n  //\n  // For now, the sfx and music data is processed \"as hex\" inline while we build up\n  // the audio samples.\n  let sfxData = sfx.split('\\n');\n  let musicData = music.split('\\n');\n\n  /**\n   * Previous brown noise.\n   * Need to track this to trim frequency ranges.\n   * See the noise oscillator.\n   * @type {number}\n   */\n  let prevNoise = 0;\n\n  /**\n   * Parses a hex substring into a decimal number.\n   * @param {string} str\n   * @param {number} start\n   * @param {number} len\n   * @return {number}\n   * @noinline\n   */\n  const parseHex = (str, start, len) => parseInt(str.substr(start, len), 16);\n\n  /**\n   * Rounds a number.\n   * This compresses better than Math.round.\n   * Google Closure Compiler inlines the calls.\n   * @param {number} x Input number.\n   * @return {number} Output number.\n   */\n  const round = (x) => (x + 0.5) | 0;\n\n  /**\n   * Triangle oscillator.\n   * @param {number} t\n   * @return {number}\n   */\n  const triangleOscillator = (t) => Math.abs(2 * t - 1) - 1.0;\n\n  /**\n   * Tilted saw oscillator.\n   * @param {number} t\n   * @return {number}\n   */\n  const tiltedSawOscillator = (t) => {\n    const a = 0.9;\n    const ret = t < a ? 2.0 * t / a - 1.0 : 2.0 * (1.0 - t) / (1.0 - a) - 1.0;\n    return ret * 0.5;\n  };\n\n  /**\n   * Saw oscillator.\n   * 0->1 ramp\n   * @param {number} t\n   * @return {number}\n   */\n  const sawOscillator = (t) => 0.6 * (t < 0.5 ? t : t - 1.0);\n\n  /**\n   * Square oscillator.\n   * 50% duty cycle square wave\n   * @param {number} t\n   * @return {number}\n   */\n  const squareOscillator = (t) => t < 0.5 ? 0.5 : -0.5;\n\n  /**\n   * Pulse oscillator.\n   * 20% duty cycle square wave\n   * @param {number} t\n   * @return {number}\n   */\n  const pulseOscillator = (t) => t < 0.3 ? 0.5 : -0.5;\n\n  /**\n   * Organ oscillator.\n   * tri-uneven: 100% tri 75% tri on loop\n   * @param {number} t\n   * @return {number}\n   */\n  const organOscillator = (t) => (\n    t < 0.5 ?\n      3.0 - Math.abs(24.0 * t - 6.0) :\n      1.0 - Math.abs(16.0 * t - 12.0)\n  ) / 9.0;\n\n  /**\n   * Noise oscillator.\n   * @return {number}\n   */\n  const noiseOscillator = () => {\n    const white = Math.random() * 2 - 1;\n    const brown = (prevNoise + (0.02 * white)) / 1.02;\n    prevNoise = brown;\n    return brown * 10; // (roughly) compensate for gain\n  };\n\n  /**\n   * Phaser oscillator.\n   * @param {number} t\n   * @param {number} value\n   * @return {number}\n   */\n  const phaserOscillator = (t, value) => {\n    // This one has a subfrequency of freq/128 that appears\n    // to modulate two signals using a triangle wave\n    const k = Math.abs(2.0 * ((value / 128.0) % 1.0) - 1.0);\n    const u = (t + 0.5 * k) % 1.0;\n    const ret = Math.abs(4.0 * u - 2.0) - Math.abs(8.0 * t - 4.0);\n    return ret / 6.0;\n  };\n\n  /**\n   * Oscillators.\n   * Order and indices are important!\n   * @const {!Array.<function(number=, number=): number>}\n   */\n  const oscillators = [\n    triangleOscillator,\n    tiltedSawOscillator,\n    sawOscillator,\n    squareOscillator,\n    pulseOscillator,\n    organOscillator,\n    noiseOscillator,\n    phaserOscillator,\n  ];\n\n  /**\n   * Returns note frequency from pitch index (0-63).\n   * From C-0 to D#-5 in chromatic scale.\n   * @param {number} pitch\n   * @return {number}\n   */\n  const getFreq = (pitch) => 65 * 2 ** (pitch / 12);\n\n  /**\n   * Cache of pre-built sounds.\n   * Key is `${sfxIndex}-${pitchOffset}\n   * Value is a Float32Array.\n   * @const {!Object}\n   */\n  const soundCache = {};\n\n  /**\n   * Builds the sound from scratch.\n   * @param {!Array.<string>} sfxData\n   * @param {number} sfxIndex\n   * @param {number} pitchOffset\n   * @return {!Float32Array}\n   */\n  const buildSound = (sfxData, sfxIndex, pitchOffset) => {\n    const sfxRow = sfxData[sfxIndex];\n    const noteLength = parseHex(sfxRow, 2, 2) / BASE_SPEED;\n    const loopStart = parseHex(sfxRow, 4, 2);\n    const loopEnd = parseHex(sfxRow, 6, 2) || 32;\n    const length = loopEnd * SAMPLE_RATE;\n    const data = new Float32Array(length);\n\n    /**\n     * Returns the next note index.\n     * Handles loop start/end.\n     * @param {number} i The current note index.\n     * @return {number} The next note index.\n     */\n    const getNextIndex = (i) => i + 1 >= loopEnd ? loopStart : i + 1;\n\n    /**\n     * Returns a data element from the sfx row.\n     * @param {number} index The note index. (0-32).\n     * @param {number} offset The element offset (0-4).\n     * @param {number} len The length in hex characters.\n     * @return {number} The sfx value.\n     */\n    const getSfx = (index, offset, len) => parseHex(sfxRow, 8 + index * 5 + offset, len);\n\n    let offset = 0;\n    let phi = 0;\n    let i = 0;\n\n    let prevNote = 24;\n    let prevFreq = getFreq(24);\n    let prevWaveform = -1;\n    let prevVolume = -1;\n    let prevEffect = -1;\n\n    let currNote;\n    let currFreq;\n    let currWaveform;\n    let currVolume;\n    let currEffect;\n\n    while (offset < length) {\n      currNote = getSfx(i, 0, 2) + pitchOffset;\n      currFreq = getFreq(currNote);\n      currWaveform = getSfx(i, 2, 1);\n      currVolume = getSfx(i, 3, 1) / 8.0;\n      currEffect = getSfx(i, 4, 1);\n\n      const next = getNextIndex(i);\n      const nextNote = getSfx(next, 0, 2) + pitchOffset;\n      const nextWaveform = getSfx(next, 2, 1);\n      const nextVolume = getSfx(next, 3, 1);\n      const nextEffect = getSfx(next, 4, 1);\n\n      let attack = 0.02;\n      if (currEffect === FX_FADE_IN ||\n        (currWaveform === prevWaveform &&\n          (currNote === prevNote || currEffect === FX_SLIDE) &&\n          prevVolume > 0 &&\n          prevEffect !== FX_FADE_OUT)) {\n        attack = 0;\n      }\n      let release = 0.05;\n      if (currEffect === FX_FADE_OUT ||\n        (currWaveform === nextWaveform &&\n          (currNote === nextNote || nextEffect === FX_SLIDE) &&\n          nextVolume > 0 &&\n          nextEffect !== FX_FADE_IN)) {\n        release = 0;\n      }\n\n      const samples = round(noteLength * SAMPLE_RATE);\n      const customInstrument = currWaveform > 7 && getSound(sfxData, currWaveform - 8, pitchOffset + currNote - 24);\n      let k = 0;\n      for (let j = offset; j < offset + samples; j++) {\n        // Note factor is the percentage of completion of the note\n        // 0.0 is the beginning\n        // 1.0 is the end\n        const noteFactor = (j - offset) / samples;\n\n        let envelope = 1.0;\n        if (noteFactor < attack) {\n          envelope = noteFactor / attack;\n        } else if (noteFactor > (1.0 - release)) {\n          envelope = (1.0 - noteFactor) / release;\n        }\n\n        let freq = currFreq;\n        let volume = currVolume;\n\n        if (currEffect === FX_SLIDE) {\n          freq = (1 - noteFactor) * prevFreq + noteFactor * currFreq;\n          if (prevVolume > 0) {\n            volume = (1 - noteFactor) * prevVolume + noteFactor * currVolume;\n          }\n        }\n        if (currEffect === FX_VIBRATO) {\n          freq *= 1.0 + 0.02 * Math.sin(7.5 * noteFactor);\n        }\n        if (currEffect === FX_DROP) {\n          freq *= 1.0 - noteFactor;\n        }\n        if (currEffect === FX_FADE_IN) {\n          volume *= noteFactor;\n        }\n        if (currEffect === FX_FADE_OUT) {\n          volume *= 1.0 - noteFactor;\n        }\n        if (currEffect >= FX_ARP_FAST) {\n          // From the documentation:\n          //   6 arpeggio fast  //  Iterate over groups of 4 notes at speed of 4\n          //   7 arpeggio slow  //  Iterate over groups of 4 notes at speed of 8\n          //   If the SFX speed is <= 8, arpeggio speeds are halved to 2, 4\n          // const m = (speed <= 8 ? 32 : 16) / (effect === FX_ARP_FAST ? 4 : 8);\n          // const n = (int)(m * 7.5 * offset / offsetPerSecond);\n          // const arp_note = (note_id & ~3) | (n & 3);\n          // freq = key_to_freq(sfx.notes[arp_note].key);\n          freq = currFreq;\n        }\n\n        phi += freq / SAMPLE_RATE;\n        if (currWaveform < 8) {\n          data[j] += volume * envelope * oscillators[currWaveform](phi % 1, phi);\n        } else {\n          data[j] += volume * envelope * customInstrument[k];\n          k = (k + 1) % customInstrument.length;\n        }\n      }\n\n      offset += samples;\n      prevNote = currNote;\n      prevFreq = currFreq;\n      prevWaveform = currWaveform;\n      prevVolume = currVolume;\n      prevEffect = currEffect;\n      i = getNextIndex(i);\n    }\n    return data;\n  };\n\n  /**\n   * Returns a sound buffer.\n   * Uses a cached buffer if available.\n   * Otherwise builds the sound from scratch.\n   * @param {!Array.<string>} sfxData\n   * @param {number} sfxIndex\n   * @param {number} pitchOffset\n   * @return {!Float32Array}\n   */\n  const getSound = (sfxData, sfxIndex, pitchOffset) => {\n    const key = sfxIndex + '-' + pitchOffset;\n    let sound = soundCache[key];\n    if (!sound) {\n      sound = buildSound(sfxData, sfxIndex, pitchOffset);\n      soundCache[key] = sound;\n    }\n    return sound;\n  };\n\n  /**\n   * @param {!Array.<string>} sfxData\n   * @param {!Float32Array} data\n   * @param {number} offset\n   * @param {number} endOffset\n   * @param {number} sfxIndex\n   * @param {number=} pitchOffset\n   */\n  const buildMusic = (sfxData, data, offset, endOffset, sfxIndex, pitchOffset = 0) => {\n    const sfxBuffer = getSound(sfxData, sfxIndex, pitchOffset);\n    let i = 0;\n    while (offset < endOffset) {\n      data[offset] += sfxBuffer[i];\n      i = (i + 1) % sfxBuffer.length;\n      offset++;\n    }\n  };\n\n  /**\n   * Builds a song and returns an audio buffer that can be used to play it.\n   * You should connect up your own audio destination before starting.\n   * @param {number=} startPattern\n   * @return {!AudioBufferSourceNode}\n   */\n  const createMusic = (startPattern = 0) => {\n    // Preprocess loop\n    // Need to do 4 things on this loop:\n    // 1) Find the \"time\" channels\n    //    Channels can run at different speeds, and therefore have different lengths\n    //    The length of a pattern is defined by the first non-looping channel\n    //    See: https://www.lexaloffle.com/bbs/?pid=12781\n    // 2) Calculate the pattern lengths\n    //    After we know the time channel, we can convert that into number of samples\n    // 3) Find the loop start time (if one exists)\n    //    Find the pattern with the \"start loop\" flag set\n    //    Otherwise default to beginning of the song\n    // 4) Find the end pattern and total song length\n    //    Find the pattern with the \"end loop\" flag set\n    //    Otherwise default to end of the song\n    const timeChannels = [];\n    const patternSamples = [];\n    let loopStart = 0;\n    let songLength = 0;\n    let endPattern = musicData.length - 1;\n    for (let pattern = startPattern; pattern <= endPattern; pattern++) {\n      const musicRow = musicData[pattern];\n      const flags = parseHex(musicRow, 0, 2);\n\n      timeChannels[pattern] = 0;\n      for (let channel = 0; channel < 4; channel++) {\n        const sfxIndex = parseHex(musicRow, 3 + channel * 2, 2);\n        if (sfxIndex < sfxData.length) {\n          const sfxRow = sfxData[sfxIndex];\n          const loopEnd = parseHex(sfxRow, 6, 2);\n          if (loopEnd === 0) {\n            timeChannels[pattern] = channel;\n            break;\n          }\n        }\n      }\n\n      const sfxIndex = parseHex(musicRow, 3 + timeChannels[pattern] * 2, 2);\n      const sfxRow = sfxData[sfxIndex];\n      const noteLength = parseHex(sfxRow, 2, 2) / BASE_SPEED;\n      patternSamples[pattern] = round(32 * noteLength * SAMPLE_RATE);\n\n      if ((flags & 1) === 1) {\n        loopStart = songLength;\n      }\n\n      songLength += 32 * noteLength;\n\n      if ((flags & 2) === 2) {\n        endPattern = pattern;\n        break;\n      }\n    }\n\n    // Now we have everything we need to build the song\n    const frameCount = SAMPLE_RATE * songLength;\n    const audioBuffer = audioCtx.createBuffer(1, frameCount, SAMPLE_RATE);\n    const data = audioBuffer.getChannelData(0);\n\n    // Main music generator loop\n    let offset = 0;\n    for (let pattern = startPattern; pattern <= endPattern; pattern++) {\n      const musicRow = musicData[pattern];\n      const samples = patternSamples[pattern];\n      for (let channel = 0; channel < 4; channel++) {\n        const sfxIndex = parseHex(musicRow, 3 + channel * 2, 2);\n        if (sfxIndex < sfxData.length) {\n          buildMusic(sfxData, data, offset, offset + samples, sfxIndex);\n        }\n      }\n      offset += samples;\n    }\n\n    const source = audioCtx.createBufferSource();\n    source.buffer = audioBuffer;\n    source.loop = true;\n    source.loopStart = loopStart;\n    return source;\n  };\n\n  /**\n   * Builds a song and immediately plays it.\n   * @param {number=} startPattern\n   * @return {!AudioBufferSourceNode}\n   */\n  const playMusic = (startPattern = 0) => {\n    const source = createMusic(startPattern);\n    source.connect(audioCtx.destination);\n    source.start();\n    return source;\n  };\n\n  this.music = createMusic;\n  this.playMusic = playMusic;\n};\n","// audio5.p8\nexport const AudioData = { music: '00 01424144\\n00 01444144\\n00 01044147\\n00 01044344\\n00 01044344\\n00 00044344\\n01 01040944\\n00 01040844\\n00 01040944\\n02 00040744', sfx: '011600000f5250f4150f2130f7250f5150f7350f4150f5150f6250f4150f513147250f515157350f4150f7150f5250f4150f5130f7250f5150f7350f4150f5150f6250f4150f2130f7250f515107350f4150f715\\n011600000c5250c4150c5150c7250c5150c7350c4150c5150c6250c4150c5150d7250c5150d7350c4150c7150c5250c4150c5150c7250c5150c7350c4150c5150c6250c4150c5150c7250c5150d7350c4150c715\\n011600000c60012500115000c6000c0002a0002a000290000c60012500115000c6000c0002a00029000240000c60012500115000c6000c00012500115000c5000c5100d0100c7200d02018030195301804019740\\n011600000f0300c030115400c0311803212730110400c5300f0300c030117400c0311803212530110400c7300f0300c030115400c0311803212730110400c5300f0300c030117400c03118032195301804019730\\n011600000c073000000c043000000c023000000c003000000c073000000c053000000c033000000c013306000c073000000c043000000c023000000c003306000c073000000c053000000c033000000c01330600\\n01160000150301203017540120311e032187301704012530150301203017740120311e032185301704012730150301203017540120311e032187301704012530150301203017740120311e0321f5301e0401f730\\n001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\\n01160000157500300015730030001571003000030000300014750030001474003000147300300014710030000c700000000000000000000000000000000000001073003000107401470010750157001076015500\\n011600000c7500c7500f7520000011750117501375012700127501255212750007000d750000000c750000000c740000000c730000000c720000000c710000000000000000000000000000000000000000000000\\n011600000c7500c7500f7520000011750117501375012700127501250212740007001273000000127100000000000000000000000000000000000000000000000000000000000000000000000000000000000000' };","// Audio\n\n//import { AudioCart } from 'pico8-audio-player';\nimport { AudioCart } from '../../temp-pico8-music';\nimport { AudioData } from './AudioData-gen';\nimport { Input } from './Input';\n\nexport const Audio = {\n    init() {\n        if (this.initialized) return;\n\n        // Note: unlike most init() methods, this is called from the first\n        // user-triggered event (like a keypress), not the main game loop. This\n        // avoids warnings in browsers about being unable to create an AudioContext.\n        this.initialized = true;\n\n        const AC = window.AudioContext || window.webkitAudioContext;\n        this.audioCtx = new AC();\n\n        setTimeout(() => {\n            this.globalGain = this.audioCtx.createGain(this.audioCtx, { gain: 0 });\n            this.globalGain.connect(this.audioCtx.destination);\n            this.globalGain.gain.linearRampToValueAtTime(1, this.audioCtx.currentTime + 2);\n\n            this.cart = new AudioCart(AudioData, { audioCtx: this.audioCtx });\n\n            this.music = this.cart.music();\n            this.music.connect(this.globalGain);\n            this.music.start();\n        }, 1);\n    }\n};\n","// Input\n\nimport { Audio } from './Audio';\n\nexport const Input = {\n    Action: {\n        UP:        11,\n        DOWN:      12,\n        LEFT:      13,\n        RIGHT:     14,\n        CAST:      15,\n        SELECT:    25,\n        INVENTORY: 26,\n        LOG:       27,\n        HELP:      28,\n        BACK:      29\n    },\n\n    init() {\n        // Key action up/down state\n        this.keyboard = {};\n\n        // \"Pressed\" means an input was pressed THIS FRAME.\n        this.pressed = {};\n\n        // \"Released\" means an input was released THIS FRAME.\n        this.released = {};\n\n        // \"Held\" means an input is held down. The input was \"Pressed\" either\n        // this frame or in a past frame, and has not been \"Released\" yet.\n        this.held = {};\n\n        // How many frames was this input held down by the player. If [held]\n        // is false, it represents how long the input was last held down.\n        this.framesHeld = {};\n\n        this.keyMapping = {\n            ArrowUp: Input.Action.UP,\n            ArrowLeft: Input.Action.LEFT,\n            ArrowDown: Input.Action.DOWN,\n            ArrowRight: Input.Action.RIGHT,\n            KeyC: Input.Action.CAST,\n            KeyL: Input.Action.LOG,\n            KeyH: Input.Action.HELP,\n            KeyI: Input.Action.INVENTORY,\n            Enter: Input.Action.SELECT,\n            Escape: Input.Action.BACK\n        };\n\n        window.addEventListener('keydown', event => {\n            let action = this.keyMapping[event.code];\n            if (action) {\n                this.keyboard[action] = true;\n            }\n\n            Audio.init();\n        });\n\n        window.addEventListener('keyup', event => {\n            let action = this.keyMapping[event.code];\n            if (action) {\n                this.keyboard[action] = false;\n            }\n        });\n    },\n\n    update() {\n        for (let action of Object.values(Input.Action)) {\n            let held = this.keyboard[action];\n\n            this.pressed[action] = !this.held[action] && held;\n            this.released[action] = this.held[action] && !held;\n\n            if (this.pressed[action]) {\n                this.framesHeld[action] = 1;\n            } else if (this.held[action] && held) {\n                this.framesHeld[action]++;\n            }\n\n            this.held[action] = held;\n        }\n    }\n};\n","// WorldData\n//\n// This file is generated by `gulp buildAssets`.\n\n/* <generated-constants> */\nexport const $D_DINING = 1;\nexport const $D_DINING_OPEN = 2;\nexport const $D_DRAW = 3;\nexport const $D_FOYER = 4;\nexport const $D_GARAGE = 5;\nexport const $D_HALLWAY = 6;\nexport const $D_KITCHEN = 7;\nexport const $F_BURNT_CHAIR = 8;\nexport const $F_BURNT_CHAIR_A = 9;\nexport const $F_DOLLHOUSE = 10;\nexport const $F_DOLLHOUSE_A = 11;\nexport const $F_FIRE1 = 12;\nexport const $F_FIRE2 = 13;\nexport const $F_FIRE3 = 14;\nexport const $F_FIRE3_A = 15;\nexport const $F_FIRE3_B = 16;\nexport const $F_SHELF1 = 17;\nexport const $F_SHELF2 = 18;\nexport const $F_SHELF3 = 19;\nexport const $F_SHELF3_A = 20;\nexport const $F_STAIR1 = 21;\nexport const $F_STATUE = 22;\nexport const $F_STATUE_A = 23;\nexport const $F_STATUE_B = 24;\nexport const $I_BURNT_NOTEBOOK = 44;\nexport const $I_DOLL_WORKBENCH = 45;\nexport const $I_IRON_KNIFE = 41;\nexport const $I_SILVER_KEY = 42;\nexport const $I_UNCLE_LETTER = 43;\nexport const $R_DINING = 30;\nexport const $R_DRAW = 31;\nexport const $R_FOYER = 32;\nexport const $R_GARAGE = 33;\nexport const $R_HALLWAY = 34;\nexport const $R_STUDY = 35;\n/* </generated-constants> */\n\nexport const WorldData =\n/* <generated-data> */\n{\n    \"floors\": [\n        {\n            \"name\": \"1F\",\n            \"tiles\": [\n                [\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32\n                ],\n                [\n                    32,\n                    32,\n                    32,\n                    129,\n                    129,\n                    129,\n                    129,\n                    129,\n                    129,\n                    129,\n                    134,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32\n                ],\n                [\n                    32,\n                    32,\n                    32,\n                    128,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    137,\n                    129,\n                    129,\n                    129,\n                    45,\n                    129,\n                    129,\n                    129,\n                    129,\n                    134,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32\n                ],\n                [\n                    32,\n                    32,\n                    32,\n                    128,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    124,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    93,\n                    128,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32\n                ],\n                [\n                    32,\n                    32,\n                    32,\n                    128,\n                    46,\n                    46,\n                    166,\n                    46,\n                    46,\n                    168,\n                    137,\n                    129,\n                    129,\n                    129,\n                    45,\n                    135,\n                    129,\n                    129,\n                    129,\n                    131,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32\n                ],\n                [\n                    32,\n                    32,\n                    32,\n                    129,\n                    129,\n                    129,\n                    129,\n                    129,\n                    129,\n                    129,\n                    138,\n                    46,\n                    46,\n                    46,\n                    46,\n                    128,\n                    32,\n                    32,\n                    32,\n                    133,\n                    129,\n                    134,\n                    32,\n                    32,\n                    130,\n                    129,\n                    129,\n                    129,\n                    45,\n                    129,\n                    129,\n                    138,\n                    32\n                ],\n                [\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    133,\n                    131,\n                    46,\n                    35,\n                    35,\n                    46,\n                    137,\n                    129,\n                    135,\n                    129,\n                    131,\n                    37,\n                    132,\n                    129,\n                    129,\n                    138,\n                    61,\n                    61,\n                    46,\n                    46,\n                    46,\n                    61,\n                    128,\n                    32\n                ],\n                [\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    128,\n                    37,\n                    46,\n                    35,\n                    35,\n                    46,\n                    128,\n                    60,\n                    132,\n                    46,\n                    46,\n                    46,\n                    46,\n                    35,\n                    46,\n                    128,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    132,\n                    134\n                ],\n                [\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    132,\n                    134,\n                    46,\n                    35,\n                    35,\n                    46,\n                    128,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    124,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    37,\n                    128\n                ],\n                [\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    128,\n                    46,\n                    46,\n                    46,\n                    46,\n                    124,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    128,\n                    91,\n                    93,\n                    46,\n                    46,\n                    38,\n                    46,\n                    133,\n                    131\n                ],\n                [\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    132,\n                    129,\n                    129,\n                    129,\n                    129,\n                    138,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    46,\n                    38,\n                    46,\n                    137,\n                    129,\n                    129,\n                    145,\n                    129,\n                    129,\n                    129,\n                    131,\n                    32\n                ],\n                [\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    132,\n                    129,\n                    129,\n                    129,\n                    45,\n                    129,\n                    129,\n                    129,\n                    129,\n                    131,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32\n                ],\n                [\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32\n                ],\n                [\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32,\n                    32\n                ]\n            ],\n            \"rooms\": [\n                [\n                    33,\n                    3,\n                    1,\n                    8,\n                    5\n                ],\n                [\n                    31,\n                    25,\n                    5,\n                    8,\n                    6\n                ],\n                [\n                    30,\n                    10,\n                    4,\n                    6,\n                    7\n                ],\n                [\n                    32,\n                    19,\n                    5,\n                    3,\n                    2\n                ],\n                [\n                    34,\n                    10,\n                    2,\n                    10,\n                    3\n                ],\n                [\n                    32,\n                    15,\n                    6,\n                    10,\n                    6\n                ],\n                [\n                    31,\n                    24,\n                    5,\n                    4,\n                    2\n                ],\n                [\n                    30,\n                    9,\n                    6,\n                    2,\n                    3\n                ]\n            ],\n            \"objects\": [\n                [\n                    3,\n                    24,\n                    8,\n                    2\n                ],\n                [\n                    6,\n                    14,\n                    4,\n                    2\n                ],\n                [\n                    12,\n                    20,\n                    6\n                ],\n                [\n                    14,\n                    31,\n                    8\n                ],\n                [\n                    1,\n                    15,\n                    9,\n                    2\n                ],\n                [\n                    13,\n                    10,\n                    7\n                ],\n                [\n                    10,\n                    22,\n                    7\n                ],\n                [\n                    5,\n                    10,\n                    3,\n                    2\n                ],\n                [\n                    7,\n                    14,\n                    2,\n                    2\n                ],\n                [\n                    17,\n                    6,\n                    4\n                ],\n                [\n                    4,\n                    19,\n                    11,\n                    2\n                ],\n                [\n                    21,\n                    16,\n                    7\n                ],\n                [\n                    22,\n                    29,\n                    9\n                ],\n                [\n                    8,\n                    18,\n                    3\n                ],\n                [\n                    18,\n                    25,\n                    6\n                ],\n                [\n                    19,\n                    26,\n                    6\n                ]\n            ],\n            \"triggers\": [],\n            \"id\": 0\n        }\n    ],\n    \"bounds\": [\n        [\n            0,\n            0\n        ],\n        [\n            33,\n            14\n        ]\n    ],\n    \"spawn\": [\n        19,\n        9,\n        0\n    ],\n    \"strings\": [\n        0,\n        \"The lock is broken and the door won't budge. With the right tool, you can\\nprobably pry it open.\",\n        \"You wedge the knife between the door and frame. With a little effort, you\\nforce the broken lock away from the strike plate.\\n%y%0 You push the door open.\",\n        0,\n        \"The front door has jammed behind you and won't budge.\",\n        0,\n        0,\n        \"It seems to be locked from the other side.\",\n        \"The charred remnants of a rocking chair.\\nA half-burnt notebook is resting on the melted seat cushion.\",\n        \"The charred remnants of a rocking chair.\",\n        \"A vintage dollhouse. Normally you could open it up and take a look inside,\\nbut it's been locked with a small silver padlock.\",\n        \"You need some kind of key to open this.\",\n        \"A massive stone fireplace. Above it hangs a portrait of a woman with long,\\nstraight black hair. She has one hand on her visibly pregnant belly.\\nThe embers are cold.\",\n        \"An impressive granite fireplace. Above the mantle hangs a brightly colored\\npainting of a newborn, out of place in such a drab room.\\nThe embers are cold.\",\n        \"Above a brick-and-onyx hearth hangs an unpleasant painting of a small child\\nbeing devoured whole by a tall, dimly-lit creature. It is hard to look at.\\nA knife has been left jammed into the canvas. You can probably pull it out.\",\n        \"With a tug, the painting releases a long iron knife. Hundreds of tiny\\nsymbols have been etched up and down the blade, but you don't recognize them.\\n%y%0 You have obtained iron knife.\",\n        \"Above a brick-and-onyx hearth hangs an unpleasant painting of a small child\\nbeing devoured whole by a tall, dimly-lit creature. It is hard to look at.\\nThe embers are cold.\",\n        \"A rusty garage shelf.\",\n        \"The shelf is covered with dust, but not much else.\",\n        \"The shelf seems to have been recently used, most of the dust is wiped off.\\nA realistic miniature workbench rests on the shelf.\",\n        \"The shelf seems to have been recently used, most of the dust is wiped off.\",\n        \"The stairs to the second floor are a wreck - you can't go up this way.\",\n        \"A crude, life-sized sculpture of a pregnant woman. One hand rests on her\\nbelly, and the other holds an iron knife.\\nThe sculpture's grip looks loose - perhaps you could take the knife.\",\n        \"With a tug, the sculpture releases the knife.\\n%y%0 You have obtained iron knife.\",\n        \"A crude, life-sized sculpture of a pregnant woman. One hand rests on her\\nbelly.\",\n        0,\n        0,\n        0,\n        0,\n        0,\n        [\n            \"DINING ROOM\",\n            \"The dining room is dominated by an oak table, which appears to have been\\nused recently as a butcher's block. Flies buzz above fresh animal entrails\\nlittering the table. The table and the carpet below is soaked in blood.\"\n        ],\n        [\n            \"DRAWING ROOM\",\n            \"You are in a dimly lit drawing room filled with faded furniture.\\nThe room smells of musty upholstery.\"\n        ],\n        [\n            \"FOYER\",\n            \"You are in the foyer of the farmhouse. The peeling paint and threadbare\\nrugs make it seem older than the outside of the house.\\nA large dollhouse sits on a pedestal in the far corner of the room.\"\n        ],\n        [\n            \"GARAGE\",\n            \"The garage is empty, save for a few rusty shelves and the usual cobwebs.\\nThere must have been other furniture here recently, you can see lines\\nin the dust where a workbench used to be.\"\n        ],\n        [\n            \"CHARRED HALLWAY\",\n            \"There must have been a fire at some point. Soot and grime coat the walls,\\nand the air stinks of burnt fabric.\"\n        ],\n        [\n            \"???\",\n            \"A nice old room.\\nWhat a nice place it is.\\nFuck it.\"\n        ],\n        0,\n        0,\n        0,\n        0,\n        0,\n        [\n            \"iron knife\",\n            \"A large iron knife etched with\\nhundreds of tiny symbols. It feels\\nheavy in your hand.\"\n        ],\n        [\n            \"silver key\",\n            \"A small, delicate silver key.\"\n        ],\n        [\n            \"your uncle's letter\",\n            \"Dearest Emily,\\n\\nYou may think me mad but I need\\nyour help. We all do. Together\\nwe can stop them or it's not\\n[the rest is crossed out...]\"\n        ],\n        [\n            \"a half-burnt notebook\",\n            \"Most of the pages are too burnt\\nto read, but somehow one page\\nis crystal clear:\\n\\n\\\"Our Goddess walks the hills\\n in the shadow of the wailing star\\n and we follow in her path\\\"\"\n        ],\n        [\n            \"miniature workbench\",\n            \"A curiously realistic miniature\\nworkbench, made of wood and metal.\\nMaybe there's some use for it.\"\n        ]\n    ]\n}\n/* </generated-data> */\n;\n","// World\n\nimport { FLICKER_FRAME_1, STATUS_COL } from './Constants';\nimport { Game } from './Game';\nimport { Screen } from './Screen';\nimport { WorldData } from './WorldData-gen';\n\nexport const World = {\n    FLOOR: 46, // '.'\n\n    init() {\n        this.reset();\n        this.visions = [];\n    },\n\n    draw() {\n        if (Game.frame % FLICKER_FRAME_1 > 1) {\n            let tiles = this.floors[0].tiles;\n            for (let y = 0; y < tiles.length; y++) {\n                for (let x = 0; x < tiles[y].length; x++) {\n                    if (this.floors[0].visible[y][x]) {\n                        let object = this.objectAt({ x, y, z: 0 });\n                        if (object) {\n                            Screen.writeOnMap(x, y, object.char, this.colorForObject(object));\n                        } else {\n                            let c = String.fromCharCode(tiles[y][x]);\n                            Screen.writeOnMap(x, y, c, this.colorForTile(c));\n                        }\n                    }\n                }\n            }\n        }\n\n        Screen.write(0, 0, ' '.repeat(STATUS_COL));\n        Screen.write(0, 1, ' '.repeat(STATUS_COL));\n        Screen.write(0, 2, ' '.repeat(STATUS_COL));\n\n        if (Game.player.room) {\n            let name = World.strings[Game.player.room.id][0];\n            Screen.write(Math.floor((STATUS_COL - name.length) / 2), 1, name, Screen.GREEN);\n        }\n\n        /*\n        if (Game.frame % 133 === 0) {\n            console.log('generating visions');\n            this.visions = [];\n            for (let i = 0; i < 10; i++) {\n                this.visions.push([\n                    Math.floor(Math.random() * tiles[0].length),\n                    Math.floor(Math.random() * tiles.length),\n                    String.fromCharCode(97 + Math.floor(Math.random() * 26))\n                ]);\n            }\n        } else if (Game.frame % 133 >= 5 && Game.frame % 133 <= 25) {\n            for (let vision of this.visions) {\n                Screen.writeOnMap(vision[0], vision[1], vision[2], Screen.RED);\n            }\n        }\n        */\n    },\n\n    reset() {\n        // We want to be careful and CLONE (not reference) the world data, because\n        // this will be our \"working copy\" -- rooms and objects and even tiles might\n        // get updated and moved during game logic.\n        this.floors = WorldData.floors.map(floor => {\n            return {\n                tiles: floor.tiles.map(row => [...row]),\n                visible: floor.tiles.map(row => row.map(c => false)),\n                objects: floor.objects.map(object => ({ id: object[0], x: object[1], y: object[2], type: object[3] })),\n                rooms: floor.rooms.map(room => ({ id: room[0], x: room[1], y: room[2], width: room[3], height: room[4] })),\n                triggers: floor.triggers.map(trigger => ({ ...trigger }))\n            };\n        });\n        this.bounds = WorldData.bounds;\n        this.spawn = WorldData.spawn;\n        this.strings = WorldData.strings;\n\n        for (let floor of this.floors) {\n            // \"Lift\" all objects off the floor, and get their default character\n            for (let object of floor.objects) {\n                object.char = String.fromCharCode(floor.tiles[object.y][object.x]);\n                floor.tiles[object.y][object.x] = World.FLOOR;\n            }\n        }\n    },\n\n    roomAt(pos) {\n        return this.floors[pos.z].rooms.find(room =>\n            pos.x >= room.x && pos.y >= room.y && pos.x < room.x + room.width && pos.y < room.y + room.height\n        );\n    },\n\n    objectAt(pos) {\n        return this.floors[pos.z].objects.find(object => object.x === pos.x && object.y === pos.y);\n    },\n\n    objectsById(id, map) {\n        let list = [];\n        for (let floor of this.floors) {\n            for (let object of floor.objects) {\n                if (object.id === id) list.push(object);\n            }\n        }\n        return map ? list.map(map) : list;\n    },\n\n    tileAt(pos) {\n        let tiles = this.floors[pos.z].tiles;\n        if (pos.x < 0 || pos.y < 0 || pos.x >= tiles[0].length || pos.y >= tiles.length) return ' ';\n        return tiles[pos.y][pos.x];\n    },\n\n    canMoveInto(pos) {\n        let tile = this.tileAt(pos);\n        if (tile === 46 /* . */) return true;\n        return false;\n    },\n\n    colorForObject(object) {\n        if (object.finished) return Screen.DIM;\n        if (object.interacted) return Screen.YELLOW;\n        return Screen.BLUE;\n    },\n\n    colorForTile(tile) {\n        return tile === '.' ? Screen.DIM : Screen.WHITE;\n    },\n\n    makeVisible(roomId) {\n        for (let floor of this.floors) {\n            for (let room of floor.rooms) {\n                if (room.id === roomId) {\n                    for (let y = room.y; y < room.y + room.height; y++) {\n                        for (let x = room.x; x < room.x + room.width; x++) {\n                            floor.visible[y][x] = true;\n                        }\n                    }\n                }\n            }\n        }\n    },\n};\n","// Util\n//\n// Miscellaneous utility functions that don't fit anywhere else.\n\nimport { World } from './World';\n\nexport function rgba(r, g, b, a) {\n    return `rgba(${r},${g},${b},${a})`;\n}\n\nexport function xyz2pos(x, y, z) {\n    return { x, y, z };\n}\n\n// To avoid having this mapping, for now I just point directly at the location of\n// chars in my font sheet -- i.e. `\\x86` etc. But in a game with more room, I'd\n// definitely use this approach just to have fun in my source code.\n/*\nexport function uni(chars) {\n    // In our character sheet, chars 0x00-0x7F are standard ASCII, below that we put whatever\n    // characters are convenient for us. Here we can choose to map unicode characters to positions\n    // 0x80+ in the charsheet, making it easy for us to render things like special characters,\n    // box drawing characters, etc.\n    //\n    // Note that this technically isn't necessary; the font sheet might map 0x81 to \"wall corner\",\n    // for example, and in Tiled the value 0x81 will display that wall corner. But it's nice to\n    // be able to put _actual wall corners_ in strings inside your JavaScript code, and in your\n    // editor that character will be more like 0x251C. I could just type '\\x81' in code, but\n    // this convert lets me convert 0x251C to 0x81.\n    //\n    // If you choose to do this, don't forget to tell the browser your encoding in your <script> tag!\n    const SUPPORTED_UNICODE_CHARS = [\n        '',\n        '',\n        ''\n    ].join('');\n    const UNICODE_CHAR_MAP = SUPPORTED_UNICODE_CHARS.split('').reduce((map, char, idx) => {\n        map[char] = 0x80 + idx;\n        return map;\n    }, {});\n    return chars.split('').map(c => String.fromCharCode(UNICODE_CHAR_MAP[c]) || c).join('');\n}\n*/\n\n// *COMBAT*\n/*\nexport function flood(pos, maxDistance = Infinity) {\n    let result = World.floors.map(floor => array2d(World.bounds[1][0], World.bounds[1][1], () => Infinity));\n    let stack = [{ ...pos, cost: 0 }];\n\n    while (stack.length > 0) {\n        let { x, y, z, cost } = stack.shift();\n        if (result[z][y][x] <= cost) continue;\n        result[z][y][x] = cost++;\n        if (result[z][y][x] >= maxDistance) continue;\n        if (World.floors[z].tiles[y][x + 1] === World.FLOOR && result[z][y][x + 1] > cost)\n            stack.push({ x: x + 1, y, z, cost });\n        if (World.floors[z].tiles[y][x - 1] === World.FLOOR && result[z][y][x - 1] > cost)\n            stack.push({ x: x - 1, y, z, cost });\n        if (World.floors[z].tiles[y + 1][x] === World.FLOOR && result[z][y + 1][x] > cost)\n            stack.push({ x, y: y + 1, z, cost });\n        if (World.floors[z].tiles[y - 1][x] === World.FLOOR && result[z][y - 1][x] > cost)\n            stack.push({ x, y: y - 1, z, cost });\n    }\n\n    return result;\n}\n*/\n\nexport function array2d(width, height, fn) {\n    return Array.from({ length: height }, () => Array.from({ length: width }, fn));\n}\n\nexport function createCanvas(width, height) {\n    let canvas = document.createElement('canvas');\n    canvas.width = width;\n    canvas.height = height;\n    let ctx = canvas.getContext('2d');\n    return { canvas, ctx };\n}\n\nexport function formatStat(value) {\n    return ('' + value).padStart(2);\n}\n\nexport function formatQuantity(value) {\n    return ('' + value).padStart(3, '0');\n}\n","// Text\n//\n// Global object responsible for drawing text characters from our font sheet onto the\n// Viewport. This includes generating recolored versions of the characters, measuring/\n// wrapping long lines, etc.\n\nimport { FONT_WIDTH, FONT_HEIGHT } from './Constants';\nimport { Font } from './Font-gen';\nimport { rgba, createCanvas } from './Util';\n\nexport const Text = {\n    init() {\n        // We'll dynamically recolor the font sheet whenever a new rgba color is requested,\n        // then cache it for future use.\n        this.colorways = {};\n        this.colorways[''] = Font.img;\n\n        // The \"white\" font sheet, right from the sprite.\n        Text.white = Font.img;\n\n        // Recolored versions of the original font sheet, to use when constructing our glow.\n        //\n        // The color here is #33FF00 which is roughly the glow of the Kaypro II.\n        Text.terminal = recolor(Text.white, rgba(51 + 16, 255, 0 + 16, 1));\n        Text.terminal_shadow = recolor(Text.white, rgba(51, 255, 0, 0.4));\n    },\n\n    drawText(ctx, text, u, v, color = '') {\n        //console.log(text, color);\n        if (typeof text === 'number') text = String.fromCharCode(text);\n        let scale = 1;\n        let font = this.colorways[color];\n        if (!font) {\n            this.colorways[color] = font = recolor(Font.img, color);\n        }\n\n        if (Array.isArray(text)) {\n            for (let block of text) {\n                Text.drawText(ctx, block.text, u + block.u * scale, v + block.v * scale, font, scale);\n            }\n            return;\n        }\n\n        for (let idx = 0; idx < text.length; idx++) {\n            let c = text.charCodeAt(idx);\n            let k = (c - 0) * FONT_WIDTH;\n            let drawable = (c !== 32);\n\n            // We clear the canvas in every frame, and it's a HUGE speed advantage not to draw an\n            // empty image (this check can save 1000+ drawImage calls a frame).\n            if (drawable) {\n                ctx.drawImage(\n                    font,\n                    (k * scale) % font.width,\n                    Math.floor((k * scale) / (font.width)) * FONT_HEIGHT * scale,\n                    FONT_WIDTH * scale,\n                    FONT_HEIGHT * scale,\n                    u ,\n                    v,\n                    FONT_WIDTH * scale,\n                    FONT_HEIGHT * scale\n                );\n            }\n            u += FONT_WIDTH * scale;\n        }\n    },\n\n    measureWidth(text, scale = 1) {\n        return text.split('').reduce((sum, c) => sum + FONT_WIDTH, 0) * scale;\n    },\n\n    splitParagraph(text, w, h) {\n        let cu = 0, cv = 0;\n        let next = () => ({ text: '', u: cu, v: cv });\n        let wip = next();\n        let list = [];\n\n        for (let c of text.split('')) {\n            let cWidth = Text.measureWidth(c, 1);\n            if (c === '\\n' || cu + cWidth > w) {\n                let saved = '';\n                if (c !== '\\n' && c !== ' ') {\n                    let space = wip.text.split(' ');\n                    if (space.length > 1) {\n                        saved = space.pop();\n                        wip.text = space.join(' ');\n                    }\n                }\n                if (wip.text.length > 0) list.push(wip);\n                cu = 0;\n                cv += FONT_HEIGHT;\n                wip = next();\n                if (saved.length > 0) {\n                    wip.text = saved;\n                    cu += Text.measureWidth(wip.text, 1);\n                }\n            } else {\n                cu += cWidth;\n            }\n            if (c !== '\\n') {\n                wip.text = wip.text + c;\n            }\n        }\n\n        if (wip.text.length > 0) list.push(wip);\n\n        return list.map(line => ({\n            ...line,\n            w: Text.measureWidth(line.text, 1),\n            h: FONT_HEIGHT\n        }));\n    }\n};\n\n// Text utility functions, for manipulating the font sheet images\n\nfunction recolor(font, color) {\n    let canvas = createCanvas(font.width, font.height);\n    canvas.ctx.fillStyle = color;\n    canvas.ctx.fillRect(0, 0, font.width, font.height);\n    canvas.ctx.globalCompositeOperation = 'destination-in';\n    canvas.ctx.drawImage(font, 0, 0);\n\n    return canvas.canvas;\n}\n","/**\n * `Screen` is a singleton that represents the virtual 80x25 character screen our game\n * lives in. Components like PlayingField will \"draw\" (write text onto) this virtual\n * screen each frame. Once all the text is written, the text will end up rendered on\n * the viewport (canvas) in the browser.\n */\n\nimport { Camera } from './Camera';\nimport { SCREEN_WIDTH, SCREEN_HEIGHT, FONT_WIDTH, FONT_HEIGHT, FLICKER_FRAME_2 } from './Constants';\nimport { Game } from './Game';\nimport { Text } from './Text';\nimport { rgba } from './Util';\n\nexport const Screen = {\n    // Terminal color codes\n    DIM:     0x00,\n    RED:     0x01,\n    GREEN:   0x02,\n    YELLOW:  0x03,\n    BLUE:    0x04,\n    MAGENTA: 0x05,\n    CYAN:    0x06,\n    WHITE:   0x07,\n    BRIGHT:  0x08,\n\n    // Useful character codes\n    SPACE:   0x20,\n\n    init() {\n        this.screen = [];\n        this.smudge = 5;\n        this.clear();\n\n        // Terminal color names to hex color mappings\n        Screen.COLORS = {\n            [Screen.DIM]:                   rgba(144, 144, 144, 1),\n            [Screen.RED]:                   rgba(214, 69,  46,  1),\n            [Screen.GREEN]:                 rgba(151, 216, 122, 1),\n            [Screen.YELLOW]:                rgba(238, 212, 83,  1),\n            [Screen.BLUE]:                  rgba(70,  151, 226, 1),\n            [Screen.WHITE]:                 rgba(214, 214, 214, 1),\n            [Screen.WHITE | Screen.BRIGHT]: rgba(255, 255, 255, 1)\n        };\n    },\n\n    clear(startX = 0, startY = 0, width = SCREEN_WIDTH, height = SCREEN_HEIGHT) {\n        for (let y = startY; y < startY + height; y++) {\n            for (let x = startX; x < startX + width; x++) {\n                this.screen[y * SCREEN_WIDTH + x] = Screen.SPACE | (Screen.WHITE << 8);\n            }\n        }\n    },\n\n    write(x, y, text, color = Screen.WHITE, x2 = SCREEN_WIDTH) {\n        if (typeof text !== 'string') throw new Error('string');\n        //if (color === undefined) color = Screen.WHITE;\n\n        let ox = x, oy = y;\n\n        for (let i = 0; i < text.length; i++) {\n            let c = text.charCodeAt(i);\n\n            if (text[i] === '\\n') {\n                x = ox;\n                y++;\n                continue;\n            }\n\n            if (text[i] === '%') {\n                switch (text[++i]) {\n                    case 'd':\n                        color = Screen.DIM;\n                        continue;\n                    case 'r':\n                        color = Screen.RED;\n                        continue;\n                    case 'g':\n                        color = Screen.GREEN;\n                        continue;\n                    case 'b':\n                        color = Screen.BLUE;\n                        continue;\n                    case 'y':\n                        color = Screen.YELLOW;\n                        continue;\n                    case 'w':\n                        color = Screen.WHITE;\n                        continue;\n                    case 'W':\n                        color = Screen.WHITE | Screen.BRIGHT;\n                        continue;\n                    case '0':\n                        c = 0xa5;\n                        break;\n                    case '1':\n                        c = 0xa4;\n                        break;\n                    default:\n                        i--;\n                }\n            }\n\n            this.screen[y * SCREEN_WIDTH + x] = c | (color << 8);\n            x++;\n            if (x >= x2) {\n                x = ox;\n                y++;\n            }\n        }\n    },\n\n    writeTypewriter(x, y, text, maxlen) {\n        if (maxlen > 0) {\n            text = text.slice(0, maxlen | 0);\n            this.write(x, y, text);\n        }\n    },\n\n    writeOnMap(x, y, text, color, x2) {\n        let offset = {\n            x: 32 - Camera.pos.x,\n            y : 12 - Camera.pos.y\n        };\n\n        this.write(x + offset.x, y + offset.y, text, color, x2);\n    },\n\n    writeBox(x, y, w, h, color) {\n        if (w > 2 && h > 2) {\n            Screen.clear(x + 1, y + 1, w - 2, h - 2);\n        }\n        this.write(x, y, `\\x95${'\\x91'.repeat(w - 2)}\\x96`, color);\n        this.write(x, y + h - 1, `\\x94${'\\x91'.repeat(w - 2)}\\x93`, color);\n        for (let i = y + 1; i < y + h - 1; i++) {\n            this.write(x, i, '\\x90', color);\n            this.write(x + w - 1, i, '\\x90', color);\n        }\n    },\n\n    draw(ctx) {\n        if (Game.frame % FLICKER_FRAME_2 > 0) {\n            for (let y = 0; y < SCREEN_HEIGHT; y++) {\n                for (let x = 0; x < SCREEN_WIDTH; x++) {\n                    let c = this.screen[y * SCREEN_WIDTH + x];\n                    let c2 = (c & 0xFF);\n                    if (c2 !== 32 && c2 < 128) c2 += this.smudge;\n                    Text.drawText(ctx, c2, x * FONT_WIDTH, y * FONT_HEIGHT, Screen.COLORS[c >> 8]);\n                }\n            }\n        }\n    }\n};\n","// Log\n\nimport { STATUS_COL } from './Constants';\nimport { Screen } from './Screen';\nimport { World } from './World';\n\nexport const Log = {\n    init() {\n        this.entries = [];\n    },\n\n    add(message, formatCode = '') {\n        console.log(message);\n        if (message[0] !== '%') {\n            message = formatCode + '\\xa5 ' + message;\n        }\n\n        this.entries.push(message.split('\\n'));\n\n        // In a real game, you'd definitely want some kind of normalized line-splitting\n        // going on here... but for JS13k, I just have carefully crafted every string in\n        // world.yaml to fit into the appropriate spaces (either the log/description\n        // area, or the inventory description area).\n\n        // For a while, I was trying to do the whole\n        /*let array = [];\n\n        while (message.length > LOG_WIDTH) {\n            array.push(message.slice(0, LOG_WIDTH));\n            message = message.slice(LOG_WIDTH);\n        }\n        if (message.length > 0) array.push(message);\n        this.entries.push(array);*/\n    },\n\n    obtainedItem(id) {\n        Log.add(`%y%0 You have obtained ${World.strings[id][0]}.`);\n    },\n\n    draw(lines = 3) {\n        let boxHeight = lines + 2;\n        let boxStart = 22 - lines;\n        let temporaryBlanks = 0;\n\n        if (this.entries[this.entries.length - 1].length < 3)\n            temporaryBlanks = 3 - this.entries[this.entries.length - 1].length;\n        let display = this.entries.flat();\n        while (temporaryBlanks-- > 0) display.push('');\n        if (display.length > lines) {\n            display = display.slice(display.length - lines);\n        }\n\n        Screen.writeBox(0, boxStart, 80, boxHeight, Screen.DIM);\n        Screen.write(STATUS_COL, boxStart, '\\x98', Screen.DIM);\n\n        for (let i = 0; i < display.length; i++) {\n            Screen.write(2, boxStart + i + 1, display[i]);\n        }\n    }\n};\n","// LogScreen\n\nimport { LOG_CLOSED_LINES, LOG_OPEN_LINES, SCREEN_WIDTH, SCREEN_HEIGHT } from './Constants';\nimport { Input } from './Input';\nimport { Log } from './Log';\nimport { Screen } from './Screen';\n\nexport class LogScreen {\n    constructor() {\n        this.lines = LOG_CLOSED_LINES;\n        this.offset = 0;\n    }\n\n    update() {\n        if (Input.pressed[Input.Action.BACK] || Input.pressed[Input.Action.LOG]) {\n            this.closing = true;\n        }\n\n        if (this.closing) {\n            this.lines -= 2;\n            if (this.lines <= LOG_CLOSED_LINES) {\n                this.cull = true;\n                return;\n            }\n        } else {\n            if (this.lines < LOG_OPEN_LINES) this.lines += 2;\n\n            if (Input.pressed[Input.Action.UP]) {\n                this.offset++;\n            } else if (Input.pressed[Input.Action.DOWN]) {\n                this.offset--;\n            }\n        }\n\n        this.offset = Math.min(this.offset, 0);\n        this.offset = Math.max(this.offset, Log.entries.flat().length - this.lines);\n    }\n\n    draw() {\n        Screen.clear(0, SCREEN_HEIGHT - this.lines - 1, SCREEN_WIDTH, this.lines + 2);\n        Log.draw(this.lines, this.offset);\n    }\n}\n","// HelpScreen\n\nimport { LOG_CLOSED_LINES, LOG_OPEN_LINES, SCREEN_WIDTH, SCREEN_HEIGHT } from './Constants';\nimport { Input } from './Input';\nimport { Log } from './Log';\nimport { Screen } from './Screen';\n\nexport class HelpScreen {\n    constructor() {\n        this.expand = 2;\n    }\n\n    update() {\n        if (Input.pressed[Input.Action.BACK] || Input.pressed[Input.Action.HELP]) {\n            this.closing = true;\n        }\n\n        if (this.closing) {\n            this.expand -= 2;\n            if (this.expand === 2) {\n                this.cull = true;\n                return;\n            }\n        } else {\n            if (this.expand < 22) this.expand += 2;\n        }\n    }\n\n    draw() {\n        const help = `                                  %gHELP\n\n%gCONTROLS\n  %W\\xa0\\xa1\\xa2\\xa3    %wMove / Investigate / Attack\n  %WI       %wOpen inventory\n  %WL       %wExpand logbook\n  %WH       %wToggle help (this screen)\n\n%gMAP LEGEND\n  %W@       %wYou\n  %d.       %wEmpty floors\n  %w\\x80\\x81      %wWalls\n  %b|- %d'    %wDoors (%bclosed%w / %dopen%w)\n  %b< >     %wStairways (up / down)\n\n  %b&!      %wBlue objects can be investigated\n  %y%#      %wYellow objects may need to be revisited later\n  %d=$      %wGray objects have already been investigated\n\n  %rsfVH    %wRed letters are foes`;\n\n        Screen.writeBox(2, 12 - Math.floor(this.expand / 2), 76, this.expand, Screen.GREEN);\n        Screen.write(4, 13 - Math.floor(this.expand / 2), help.split('\\n').slice(0, this.expand).join('\\n'));\n    }\n}\n","// InventoryScreen\n//\n// The inventory screen has two modes -- if it's passed an object during construction\n// then it's actually the \"use inventory\" screen, if it's not, it's the \"examine\n// inventory\" screen.\n\nimport { LOG_CLOSED_LINES, LOG_OPEN_LINES, SCREEN_WIDTH, SCREEN_HEIGHT } from './Constants';\nimport { Game } from './Game';\nimport { Input } from './Input';\nimport { Log } from './Log';\nimport { Screen } from './Screen';\nimport { World } from './World';\n\nexport class InventoryScreen {\n    constructor(object) {\n        this.object = object;\n        this.expand = 2;\n        this.selected = 0;\n        this.list = Game.player.inventory;\n    }\n\n    update() {\n        console.log(['update', Input.pressed[Input.Action.DOWN]]);\n        if (Input.pressed[Input.Action.BACK]) {\n            this.closing = true;\n        } else if (Input.pressed[Input.Action.INVENTORY] && !this.object) {\n            this.closing = true;\n        } else if (Input.pressed[Input.Action.DOWN]) {\n            this.selected = (this.selected + 1) % this.list.length;\n        } else if (Input.pressed[Input.Action.UP]) {\n            this.selected = (this.selected + this.list.length - 1) % this.list.length;\n        } else if (Input.pressed[Input.Action.SELECT] && this.object) {\n            this.closing = true;\n            Game.player.useItemOn(this.object, this.list[this.selected]);\n        }\n\n        if (this.closing) {\n            this.cull = true;\n        }\n    }\n\n    draw() {\n        Screen.writeBox(5, 6, 71, 10, Screen.GREEN);\n        Screen.write(38, 6, '\\x97', Screen.GREEN);\n        Screen.write(38, 15, '\\x98', Screen.GREEN);\n        for (let y = 7; y < 15; y++) {\n            Screen.write(38, y, '\\x90', Screen.GREEN);\n        }\n\n        for (let idx = 0; idx < this.list.length; idx++) {\n            let [name, description] = World.strings[this.list[idx]];\n            if (idx === this.selected) {\n                Screen.write(6, 7 + idx, `%0${name.padEnd(30)}%1`, Screen.GREEN);\n                Screen.write(40, 7, description);\n            } else {\n                Screen.write(7, 7 + idx, name);\n            }\n        }\n        if (this.object) {\n            Screen.write(6, 14, '[\\xa0\\xa1\\xa2\\xa3ENTER] Use item  [ESC] Back', Screen.DIM);\n        } else {\n            Screen.write(6, 14, '[\\xa0\\xa1\\xa2\\xa3] Examine item   [ESC] Back', Screen.DIM);\n        }\n    }\n}\n","// Player\n\n//import { CombatSystem } from './CombatSystem';\nimport {\n    TURN_FRAMES,\n    TYPE_DOOR\n} from './Constants';\nimport { Game } from './Game';\nimport { Input } from './Input';\nimport { InventoryScreen } from './InventoryScreen';\nimport { Log } from './Log';\nimport { Screen } from './Screen';\nimport { World } from './World';\nimport {\n    $D_DINING,\n    $D_DINING_OPEN,\n    $D_DRAW,\n    $D_FOYER,\n    $D_GARAGE,\n    $D_KITCHEN,\n    $D_HALLWAY,\n    $F_BURNT_CHAIR,\n    $F_BURNT_CHAIR_A,\n    $F_FIRE3,\n    $F_FIRE3_A,\n    $F_FIRE3_B,\n    $F_SHELF1,\n    $F_SHELF2,\n    $F_SHELF3,\n    $F_SHELF3_A,\n    $F_STAIR1,\n    $F_STATUE,\n    $F_STATUE_A,\n    $F_STATUE_B,\n    $I_BURNT_NOTEBOOK,\n    $I_DOLL_WORKBENCH,\n    $I_IRON_KNIFE,\n    $I_SILVER_KEY,\n    $I_UNCLE_LETTER,\n    $R_DRAW,\n    $R_DINING,\n    $R_GARAGE,\n    $R_HALLWAY\n} from './WorldData-gen';\nimport { WorldParticle } from './WorldParticle';\n\nexport class Player {\n    constructor(pos) {\n        this.pos = { ...pos };\n\n        this.lookingAt = this.room;\n        this.inventory = [];\n\n\n        this.speed = 4;\n        this.hp = this.hpMax = 100;\n        this.sp = this.spMax = 100;\n\n        // *COMBAT*\n        // this.vigor = 8;\n        // this.insight = 12;\n        // this.will = 10;\n        // this.updateStats();\n        // this.weapon = { ar: 0.5 };\n        // this.df = flood(this.pos);\n\n        // The player starts with the uncle's letter.\n        this.obtainItem($I_UNCLE_LETTER);\n\n        // The foyer door is locked.\n        World.objectsById($D_FOYER, object => object.finished = true);\n\n        // The player is in the foyer (starting room).\n        this.room = World.roomAt(this.pos);\n        Log.add(World.strings[this.room.id][1]);\n        World.makeVisible(this.room.id);\n\n        // Temporary hack stuff\n        this.obtainItem($I_IRON_KNIFE);\n        this.obtainItem($I_BURNT_NOTEBOOK);\n\n    }\n\n    draw() {\n        Screen.writeOnMap(this.pos.x, this.pos.y, '@', Screen.WHITE | Screen.BRIGHT);\n    }\n\n    update() {\n        let move;\n\n        console.log(Input.held[Input.Action.LEFT], Input.framesHeld[Input.Action.LEFT]);\n        if (Input.held[Input.Action.LEFT] && Input.framesHeld[Input.Action.LEFT] % TURN_FRAMES === 1) {\n            move = { ...this.pos, x: this.pos.x - 1 };\n        } else if (Input.held[Input.Action.RIGHT] && Input.framesHeld[Input.Action.RIGHT] % TURN_FRAMES === 1) {\n            move = { ...this.pos, x: this.pos.x + 1 };\n        } else if (Input.held[Input.Action.UP] && Input.framesHeld[Input.Action.UP] % TURN_FRAMES === 1) {\n            move = { ...this.pos, y: this.pos.y - 1 };\n        } else if (Input.held[Input.Action.DOWN] && Input.framesHeld[Input.Action.DOWN] % TURN_FRAMES === 1) {\n            move = { ...this.pos, y: this.pos.y + 1 };\n        }\n\n        if (move) {\n            this.interactWith(move);\n        }\n        return !!move;\n    }\n\n    interactWith(pos) {\n        let tile = World.tileAt(pos);\n        let object = World.objectAt(pos);\n        let entity = Game.entityAt(pos);\n\n        if (entity) {\n            // *COMBAT*\n            // this.attack(entity);\n        } else if (object) {\n            if (object.open) {\n                this.moveInto(pos, false);\n            } else if (object.finished) {\n                this.lookingAt = object;\n                Log.add(World.strings[object.id]);\n                console.log('finished' + World.strings[object.id]);\n            } else {\n                /**** SPECIAL OBJECTS ****/\n                if (object.id === $D_DINING) {\n                    Log.add(World.strings[object.id]);\n                    if (object.interacted) {\n                        this.openInventoryFor(object);\n                    }\n                } else if (object.id === $D_DRAW) {\n                    this.openDoor(object);\n                    World.makeVisible($R_DRAW);\n                } else if (object.id === $D_KITCHEN) {\n                    Log.add(World.strings[object.id]);\n                } else if (object.id === $D_GARAGE) {\n                    this.openDoor(object);\n                    World.makeVisible($R_GARAGE);\n                } else if (object.id === $D_HALLWAY) {\n                    this.openDoor(object);\n                    World.makeVisible($R_HALLWAY);\n                } else if (object.id === $F_BURNT_CHAIR) {\n                    Log.add(World.strings[object.id]);\n                    object.id = $F_BURNT_CHAIR_A;\n                } else if (object.id === $F_BURNT_CHAIR_A) {\n                    object.finished = true;\n                    Log.obtainedItem($I_BURNT_NOTEBOOK);\n                    this.obtainItem($I_BURNT_NOTEBOOK);\n                } else if (object.id === $F_FIRE3) {\n                    Log.add(World.strings[object.id]);\n                    object.id = $F_FIRE3_A;\n                } else if (object.id === $F_FIRE3_A) {\n                    Log.add(World.strings[object.id]);\n                    object.id = $F_FIRE3_B;\n                    this.obtainItem($I_IRON_KNIFE);\n                } else if (object.id === $F_SHELF1) {\n                    Log.add(World.strings[object.id]);\n                    object.finished = true;\n                    this.obtainItem($I_SILVER_KEY);\n                } else if (object.id === $F_SHELF2) {\n                    Log.add(World.strings[object.id]);\n                    object.finished = true;\n                } else if (object.id === $F_SHELF3) {\n                    Log.add(World.strings[object.id]);\n                    object.id = $F_SHELF3_A;\n                } else if (object.id === $F_SHELF3_A) {\n                    object.finished = true;\n                    Log.obtainedItem($I_DOLL_WORKBENCH);\n                    this.obtainItem($I_DOLL_WORKBENCH);\n                } else if (object.id === $F_STATUE) {\n                    Log.add(World.strings[object.id]);\n                    object.id = $F_STATUE_A;\n                } else if (object.id === $F_STATUE_A) {\n                    Log.add(World.strings[object.id]);\n                    object.id = $F_STATUE_B;\n                    object.finished = true;\n                    this.obtainItem($I_IRON_KNIFE);\n                } else if (object.id === $F_STAIR1) {\n                    Log.add(World.strings[object.id])\n                    object.finished = true;\n                } else if (object.type === TYPE_DOOR) {\n                    this.openDoor(object);\n                } else {\n                    let action = '';\n                    if (object.action) {\n                        action = `\\n${object.action}`;\n                    } else if (object.interacted) {\n                        action = `\\n%y\\xa5 You need some kind of other item.`;\n                    }\n                    this.lookingAt = object;\n                    console.log(object.id);\n                    console.log(World.strings[object.id] + action);\n                    Log.add(World.strings[object.id] + action);\n                    console.log('else statement' + World.strings[object.id]);\n                }\n            }\n\n            object.interacted = true;\n        } else if (tile === World.FLOOR) {\n            this.moveInto(pos, true);\n        } else {\n            console.log('No.');\n        }\n    }\n\n    moveInto(pos, updateRoom) {\n        this.pos = pos;\n        //this.df = flood(this.pos);\n        if (updateRoom) {\n            // This is a cheap, easy way to make doors part of \"both rooms\" - when you step\n            // between rooms, the current room description doesn't update until you walk\n            // past the doorway.\n            let room = World.roomAt(this.pos);\n            if (this.room !== room) {\n                Log.add(World.strings[room.id][1]);\n            }\n            this.room = room;\n            this.lookingAt = this.room;\n        }\n    }\n\n    openInventoryFor(object) {\n        Game.screens.push(new InventoryScreen(object));\n    }\n\n    useItemOn(object, item) {\n        if (object.id === $D_DINING) {\n            if (item === $I_IRON_KNIFE) {\n                this.openDoor(object, $D_DINING_OPEN);\n                World.makeVisible($R_DINING);\n            } else {\n                Log.add(`That doesn't work here.`, '%y');\n            }\n        }\n        console.log('oh fuck, i am using ' + object + item);\n    }\n\n    hasItem(id) {\n        return this.inventory.includes(id);\n    }\n\n    obtainItem(id) {\n        this.inventory.push(id);\n    }\n\n    openDoor(object, stringId) {\n        if (stringId) {\n            Log.add(World.strings[stringId]);\n        } else {\n            Log.add('You push the door open.', '%y');\n        }\n        object.open = object.finished = true;\n        object.char = object.char === '|' ? `'` : '\\x7f';\n    }\n\n    // *COMBAT*\n    /*\n    attack(entity) {\n        let roll = CombatSystem.rollAttack(this.vigor, this.weapon.ar);\n        if (roll.result === CombatSystem.WHIFF) {\n            Log.add('%YYou slash at the swamp rat, but miss.');\n        } else if (roll.result === CombatSystem.HIT) {\n            Log.add(`%YYou slash the ${CombatSystem.formatActeeName(entity)}, dealing ${roll.value} damage.`);\n        } else if (roll.result === CombatSystem.CRIT) {\n            Log.add(`%YFocus! You slash the ${CombatSystem.formatActeeName(entity)}, dealing ${roll.value} damage.`);\n        }\n        Game.entities.push(new WorldParticle(entity.pos, [['/', Screen.YELLOW], ['*', Screen.YELLOW]]));\n        Game.entities.push(new WorldParticle(Game.player.pos, [['@', Screen.YELLOW]]));\n    }\n\n    updateStats() {\n        this.lvl = this.vigor + this.insight + this.will;\n\n        let hpMax = this.vigor * 10 + this.lvl - 10;\n\n        if (hpMax > this.hpMax) {\n            this.hpMax = hpMax;\n            this.hp += (hpMax - this.hpMax);\n        }\n\n        let spMax = this.will * 10 + this.lvl - 30;\n\n        if (spMax > this.spMax) {\n            this.spMax = spMax;\n            this.sp += (spMax - this.spMax);\n        }\n    }\n    */\n}\n","// TurnSystem\n\nimport { Game } from './Game';\n\nexport const TurnSystem = {\n    takeEntityTurns() {\n        const entities = [...Game.entities];\n\n        if (!Game.player.tp) Game.player.tp = 0;\n\n        if (Game.player.tp >= Game.player.speed) {\n            // All entities are \"paused\" until the player takes a turn.\n            let turnTaken = Game.player.update();\n\n            if (turnTaken) {\n                Game.player.tp -= Game.player.speed;\n            }\n\n            // Entities with no speed are frame-based instead of turn-based. (For\n            // example, most spawned particles, which are also entities.)\n            for (let entity of entities) {\n                if (!entity.speed) entity.update();\n            }\n        } else {\n            for (let entity of entities) {\n                entity.tp = (entity.tp || 0) + 1;\n\n                while (entity.tp >= entity.speed && entity !== Game.player) {\n                    entity.update();\n                    entity.tp -= entity.speed;\n                }\n            }\n        }\n\n        //console.log(Game.entities.map(x => x.tp));\n    }\n};\n","// Viewport\n\nimport { GAME_WIDTH, GAME_HEIGHT } from './Constants';\n\n/**\n * Viewport is a global object representing the playable pixel area of our game.\n */\nexport const Viewport = {\n    init() {\n        Viewport.canvas = document.getElementById('canvas');\n        Viewport.ctx = Viewport.canvas.getContext('2d');\n        Viewport.resize(true);\n    },\n\n    // Resize the canvas to give us approximately our desired game display size.\n    //\n    // Rather than attempt to explain it, here's a concrete example:\n    //\n    //     we start with a desired game dimension:   480x270px\n    //          get the actual browser dimensions:  1309x468px\n    //          factor in the display's DPI ratio:  2618x936px\n    //         now calculate the horizontal scale:       5.45x\n    //                     and the vertical scale:       3.46x\n    //            our new offical game scaling is:        5.4x\n    //       and our official viewport dimensions:   484x173px\n    //\n    // This approach emphasizes correct aspect ratio and maintains full-window rendering, at\n    // the potential cost of limiting visibility of the game itself in either the X or Y axis.\n    // If you use this approach, make sure your GUI can \"float\" (otherwise there may be whole\n    // UI elements the player cannot see!).\n    resize(force) {\n        let dpi = window.devicePixelRatio,\n            width = Viewport.canvas.clientWidth,\n            height = Viewport.canvas.clientHeight,\n            dpiWidth = width * dpi,\n            dpiHeight = height * dpi;\n\n        if (force || Viewport.canvas.width !== dpiWidth || Viewport.canvas.height !== dpiHeight) {\n            Viewport.canvas.width = dpiWidth;\n            Viewport.canvas.height = dpiHeight;\n\n            Viewport.scale = ((Math.min(dpiWidth / GAME_WIDTH, dpiHeight / GAME_HEIGHT) * 10) | 0) / 10;\n            Viewport.width = Math.ceil(dpiWidth / Viewport.scale);\n            Viewport.height = Math.ceil(dpiHeight / Viewport.scale);\n            Viewport.center = {\n                u: (Viewport.width / 2) | 0,\n                v: (Viewport.height / 2) | 0\n            };\n            Viewport.clientWidth = width;\n            Viewport.clientHeight = height;\n\n            // Note: smoothing flag gets reset on every resize by some browsers, which is why\n            // we do it here.\n            Viewport.ctx.imageSmoothingEnabled = false;\n        }\n\n        // We do this every frame, not just on resize, due to browser sometimes \"forgetting\".\n        Viewport.canvas.style.cursor = 'not-allowed';\n    }\n};\n","// WelcomeScreen\n\nimport { Audio } from './Audio';\nimport { LOG_CLOSED_LINES, LOG_OPEN_LINES, SCREEN_WIDTH, SCREEN_HEIGHT } from './Constants';\nimport { Input } from './Input';\nimport { Log } from './Log';\nimport { Screen } from './Screen';\n\nexport class WelcomeScreen {\n    constructor() {\n        this.expand = 2;\n        Screen.smudge = 26;\n    }\n\n    update() {\n        // Weird hack here because AudioContext constructor eats up a frame\n        // about half the time... I should fix it properly but this hack\n        // works for now.\n        if (Input.pressed[Input.Action.SELECT] || Audio.initialized) {\n            this.closing = true;\n        }\n\n        if (this.closing) {\n            this.cull = true;\n            Screen.smudge = 8;\n        }\n    }\n\n    draw() {\n        let welcome = `                     %gSHADOW OF THE KEENING STAR\n\n%wFor some reason, you just couldn't ignore that letter. It was wrong,\nsomehow - although estranged, you remember your uncle, and he never\nwrote like that.\n\nSo here you are, an hour southeast of Boston, still clutching your\nuncle's letter and standing in front of a weather-beaten colonial.\n\nThe creak of the front door echoes in your ears as you step into the\nhouse...\n\n%d[ENTER] Begin`;\n\n        /*welcome = welcome.split('').map(c => {\n            let code = c.charCodeAt(0);\n            if (c === 'g' || c === 'w' || c === 'd') return c;\n            if (code >= 48 && code <= 122) return String.fromCharCode(code + this.shift);\n            return c;\n        }).join('');*/\n\n        Screen.clear();\n        Screen.writeBox(4, 4, 72, 15, Screen.GREEN);\n        Screen.write(6, 5, welcome);\n    }\n}\n","// Game\n//\n// A global object representing the state of the current game in progress. Game owns\n// the high-level game loop and orchestrates everything that happens each frame.\n\nimport { Camera } from './Camera';\nimport { FPS, GAME_WIDTH, GAME_HEIGHT } from './Constants';\nimport { Font } from './Font-gen';\nimport { Input } from './Input';\nimport { Log } from './Log';\nimport { LogScreen } from './LogScreen';\nimport { HelpScreen } from './HelpScreen';\nimport { InventoryScreen } from './InventoryScreen';\nimport { Player } from './Player';\nimport { Screen } from './Screen';\nimport { Text } from './Text';\n//import { Triggers } from './Triggers';\nimport { TurnSystem } from './TurnSystem';\nimport { Viewport } from './Viewport';\nimport { WelcomeScreen } from './WelcomeScreen';\nimport { World } from './World';\nimport { xyz2pos, formatStat, formatQuantity } from './Util';\n\nexport const Game = {\n    async init() {\n        // Initialize game components\n        await Font.init();\n        Viewport.init();\n        Screen.init();\n        Text.init();\n        Input.init();\n        World.init();\n        Log.init();\n\n        // Initial state values\n        this.frame = 0;\n        this.entities = [];\n\n        this.player = new Player(xyz2pos(...World.spawn));\n        this.entities.push(this.player);\n\n        this.screens = [];\n\n        this.screens.push(new WelcomeScreen());\n\n        Camera.init();\n\n        // Kick off game loop\n        window.requestAnimationFrame(() => this.onFrame());\n    },\n\n    onFrame() {\n        let now = new Date().getTime();\n        let lastFrame = this.lastFrame || 0;\n\n        // Note: `requestAnimationFrame` will usually call our handler 60 times per second,\n        // but it can be higher or lower (lower if the game is lagging, higher if the user's\n        // refresh settings are modified -- it can be 120Hz for example).\n        //\n        // It's safest to explicitly limit the number of frame updates to 60 per second.\n        if (now - lastFrame >= 1000 / FPS) {\n            this.frame++;\n            this.update();\n            this.lastFrame = now;\n\n            Viewport.resize();\n            this.draw();\n        }\n\n        window.requestAnimationFrame(() => this.onFrame());\n\n        //Triggers.arm('TRAT1');\n    },\n\n    update() {\n        Input.update();\n\n        //console.log([Input.pressed[Input.Action.LOG],Input.Action.LOG,Input.held[Input.Action.LOG]]);\n        if (this.screens.length > 0) {\n            this.screens[this.screens.length - 1].update();\n            this.screens = this.screens.filter(screen => !screen.cull);\n        } else if (Input.pressed[Input.Action.LOG]) {\n            //console.log('MAKING A NEW SCREEN');\n            this.screens.push(new LogScreen());\n        } else if (Input.pressed[Input.Action.HELP]) {\n            //console.log('help screen');\n            this.screens.push(new HelpScreen());\n        } else if (Input.pressed[Input.Action.INVENTORY]) {\n            this.screens.push(new InventoryScreen());\n            console.log('inv');\n        } else {\n            TurnSystem.takeEntityTurns();\n        }\n\n        Camera.update();\n\n        //Triggers.update();\n\n        // Discard any entites marked for culling at the end of the update step. They will not\n        // be drawn this frame (so, setting \"cull\" should happen AFTER the last frame of a given\n        // enemy or particle has been drawn).\n        Game.entities = Game.entities.filter(entity => !entity.cull);\n\n        if (Screen.smudge > 0) Screen.smudge--;\n    },\n\n    draw() {\n        // Reset canvas transform and scale\n        Viewport.ctx.setTransform(Viewport.scale, 0, 0, Viewport.scale, 0, 0);\n\n        // Clear canvas\n        Viewport.ctx.fillStyle = '#121212';\n        Viewport.ctx.fillRect(0, 0, Viewport.width, Viewport.height);\n\n        // Center our ASCII \"screen\" in the viewport\n        Viewport.ctx.translate((Viewport.width - GAME_WIDTH) / 2 | 0, (Viewport.height - GAME_HEIGHT) / 2 | 0);\n\n        Screen.clear();\n\n        //Screen.write(3, 3, 'hello world');\n\n        //Screen.write(0, 0, '/--------------------------------------\\\\');\n        //Screen.write(2, 10, 'You are standing in a cramped drawing room.');\n\n        //Screen.write(0, 0, '#');\n        //Screen.write(79, 0, '#');\n        //Screen.write(0, 23, '#');\n        //Screen.write(79, 23, '#');\n\n        for (let i = 0; i < Math.min(20, this.frame / 3); i++) {\n            Screen.write(64, i, '\\x90', Screen.DIM);\n        }\n\n        //Screen.write(0, 19, '\\x91'.repeat(80));\n\n        Screen.writeTypewriter(\n            66, 1,\n            `Health ${formatQuantity(Game.player.hp)}/${formatQuantity(Game.player.hpMax)}`,\n            this.frame / 2\n        );\n        Screen.writeTypewriter(\n            66, 2,\n            `Sanity ${formatQuantity(Game.player.sp)}/${formatQuantity(Game.player.spMax)}`,\n            (this.frame / 2) - 10\n        );\n\n        //Screen.write(66, 4, `Vigor   ${formatStat(Game.player.vigor)}`);\n        //Screen.write(66, 5, `Insight ${formatStat(Game.player.insight)}`);\n        //Screen.write(66, 6, `Will    ${formatStat(Game.player.will)}`);\n        //Screen.write(66, 7, `Speed   ${formatStat(Game.player.speed)}`);\n\n/*\n        Screen.write(0, 19, '#'.repeat(60));\n        Screen.write(0, 20, 'Here is something.');\n        Screen.write(0, 21, 'Here is something.');\n        Screen.write(3, 22, 'Here is some kind of something.');\n        Screen.write(4, 21, '#'.repeat(60));\n        Screen.write(5, 18, '#'.repeat(60));\n*/\n        World.draw();\n\n        // A simplistic 3-layer z-order system. We can always be more advanced\n        // and actually sort by z later!\n        for (let entity of this.entities) {\n            if (entity.z < 0) entity.draw();\n        }\n        for (let entity of this.entities) {\n            if (!entity.z) entity.draw();\n        }\n        for (let entity of this.entities) {\n            if (entity.z > 0) entity.draw();\n        }\n\n        if (this.frame > 60) {\n            Screen.write(66, 18, '[H] Help', Screen.DIM);\n            Log.draw(3);\n        }\n\n        for (let screen of this.screens) {\n            screen.draw();\n        }\n\n        Screen.draw(Viewport.ctx);\n    },\n\n    entityAt(pos) {\n        return this.entities.find(entity => {\n            let found = (entity.pos.x === pos.x) && (entity.pos.y === pos.y) && (entity.pos.z === pos.z);\n            return found;\n        });\n    },\n};\n","// index\n//\n// Entry point into our game. Our only job is to initialize our Game object.\n\nimport { Game } from './Game';\n\nGame.init();\n"]}